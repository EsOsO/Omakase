{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Home","text":""},{"location":"#omakase-documentation","title":"Omakase Documentation","text":"<p>Welcome to Omakase, a production-ready Docker homelab infrastructure managing 25+ containerized services with a security-first architecture.</p> <p>What is Omakase?</p> <p>Omakase (\u304a\u4efb\u305b) is a Japanese phrase meaning \"I'll leave it up to you\" - perfectly capturing the philosophy of this project: a curated, opinionated, ready-to-deploy homelab infrastructure where all the hard decisions have been made for you.</p> <p>About This Documentation</p> <p>The documentation and guides in this project are AI-assisted to provide comprehensive and helpful content. However, all Docker Compose configurations, service definitions, and infrastructure code are manually written and thoroughly reviewed by the maintainer to ensure security, reliability, and correctness.</p>"},{"location":"#why-omakase","title":"Why Omakase?","text":"<ul> <li> <p> Security First</p> <p>Multi-layered security with Authelia SSO, CrowdSec IPS, Infisical secrets management, and network isolation.</p> <p> Security Overview</p> </li> <li> <p> Infrastructure as Code</p> <p>Fully declarative Docker Compose setup with modular service architecture and automatic secret injection.</p> <p> Architecture</p> </li> <li> <p> Built-in Backup</p> <p>Automated encrypted backups with Restic to cloud storage (Backblaze B2) with verification and pruning.</p> <p> Backup Guide</p> </li> <li> <p> Fully Automated</p> <p>Renovate bot for dependency updates, CI/CD with GitHub Actions, automatic SSL certificates, and monitoring.</p> <p> Operations</p> </li> <li> <p> Modular Design</p> <p>Enable/disable services easily with include directives. Each service is isolated and independently configurable.</p> <p> Adding Services</p> </li> <li> <p> Production Ready</p> <p>Battle-tested in production with 25+ services, comprehensive monitoring, and proven disaster recovery.</p> <p> Deployment Scenarios</p> </li> </ul>"},{"location":"#core-services","title":"Core Services","text":"<p>Omakase includes essential infrastructure components:</p> Service Version Purpose Documentation Traefik v3.5 Reverse proxy with automatic HTTPS \u2192 Authelia v4.39 SSO authentication gateway \u2192 CrowdSec v1.7 Collaborative IPS and security \u2192 Cetusguard latest Secure Docker socket proxy \u2192 Portainer latest Container management UI \u2192 Homepage latest Unified dashboard \u2192 Dozzle latest Real-time log viewer \u2192 Restic latest Encrypted backup solution \u2192 <p>Plus 20+ additional services for media, productivity, development, and more!</p>"},{"location":"#quick-start","title":"Quick Start","text":"<p>Get started in 3 simple steps:</p> <pre><code># 1. Clone the repository\ngit clone https://github.com/esoso/omakase.git\ncd omakase\n\n# 2. Configure secrets in Infisical\n# (See Getting Started guide)\n\n# 3. Deploy the stack\nmake up\n</code></pre> <p>First time here? Start with:</p> <ol> <li>Prerequisites - Check what you need</li> <li>Choose Your Deployment - Pick your environment</li> <li>Installation Guide - Deploy Omakase</li> <li>Configuration - Customize your setup</li> </ol>"},{"location":"#architecture-highlights","title":"Architecture Highlights","text":""},{"location":"#network-isolation","title":"Network Isolation","text":"<pre><code>graph TB\n    Internet[Internet] --&gt; Traefik[Traefik&lt;br/&gt;ingress network]\n    Traefik --&gt; Authelia[Authelia&lt;br/&gt;SSO Gateway]\n    Authelia --&gt; Services[Protected Services]\n    Services --&gt; vnet1[vnet-service1]\n    Services --&gt; vnet2[vnet-service2]\n    Services --&gt; vnet3[vnet-service3]\n\n    Management[Management Tools] --&gt; Socket[Cetusguard&lt;br/&gt;docker_socket network]\n    Socket --&gt; Docker[Docker API&lt;br/&gt;Read-only]\n\n    style Traefik fill:#326ce5,color:#fff\n    style Authelia fill:#9d0400,color:#fff\n    style Services fill:#2ecc71,color:#fff\n    style Socket fill:#f39c12,color:#fff</code></pre>"},{"location":"#security-layers","title":"Security Layers","text":"<pre><code>graph LR\n    A[Public Internet] --&gt;|HTTPS| B[CrowdSec IPS]\n    B --&gt;|Allowed| C[Traefik SSL]\n    C --&gt;|Authenticated| D[Authelia SSO]\n    D --&gt;|Authorized| E[Application]\n    E --&gt;|Secrets| F[Infisical Vault]\n    E --&gt;|Isolated| G[vnet-*]\n    E --&gt;|Protected| H[Docker Socket Proxy]\n\n    style A fill:#e74c3c,color:#fff\n    style B fill:#f39c12,color:#fff\n    style C fill:#3498db,color:#fff\n    style D fill:#9d0400,color:#fff\n    style E fill:#2ecc71,color:#fff\n    style F fill:#9b59b6,color:#fff\n    style G fill:#1abc9c,color:#fff\n    style H fill:#34495e,color:#fff</code></pre>"},{"location":"#deployment-scenarios","title":"Deployment Scenarios","text":"<p>Omakase supports multiple deployment environments:</p> Environment Complexity Cost Performance Best For Proxmox LXC Medium Low Excellent Advanced homelab Bare Metal Low Low Excellent Simple homelab VM Generic Low Low Good Testing NAS Low Low Good Existing NAS Cloud VPS Low Medium Good Remote access Cloud Enterprise High High Excellent Production <p> Compare Deployment Options</p>"},{"location":"#key-features","title":"Key Features","text":""},{"location":"#security-first-architecture","title":"Security-First Architecture","text":"<ul> <li>Zero Trust Network: Every service isolated in dedicated networks</li> <li>SSO Authentication: Authelia protects all services with 2FA support</li> <li>Secret Management: All secrets stored in Infisical vault, never in git</li> <li>IPS Protection: CrowdSec blocks threats automatically</li> <li>Container Hardening: <code>no-new-privileges</code>, resource limits, non-root users</li> </ul>"},{"location":"#automated-operations","title":"Automated Operations","text":"<ul> <li>Dependency Updates: Renovate bot updates Docker images automatically</li> <li>Backup &amp; Verify: Daily encrypted backups with integrity checks</li> <li>SSL Certificates: Automatic Let's Encrypt certificate management</li> <li>Health Checks: Monitoring with alerts via Telegram/Email</li> <li>CI/CD Pipeline: Automated validation and deployment</li> </ul>"},{"location":"#infrastructure-as-code","title":"Infrastructure as Code","text":"<ul> <li>Declarative Setup: Everything defined in Docker Compose files</li> <li>Version Controlled: All configuration tracked in git</li> <li>Reproducible: Deploy identical infrastructure anywhere</li> <li>Documented: Comprehensive docs for every component</li> </ul>"},{"location":"#technology-stack","title":"Technology Stack","text":"<ul> <li> <p> Docker Ecosystem</p> <p>Docker 24+, Compose v2.20+, dedicated networks per service</p> </li> <li> <p> Security Stack</p> <p>Traefik, Authelia, CrowdSec, Infisical, Cetusguard</p> </li> <li> <p> Data Persistence</p> <p>PostgreSQL, Redis (Redict), encrypted backups with Restic</p> </li> <li> <p> Management</p> <p>Portainer, Homepage, Dozzle, Traefik dashboard</p> </li> </ul>"},{"location":"#community-support","title":"Community &amp; Support","text":"<ul> <li>Documentation: You're reading it! Browse sections above</li> <li>GitHub Issues: Report bugs and request features</li> <li>Discussions: Ask questions and share setups</li> <li>Security: Report security issues</li> </ul>"},{"location":"#contributing","title":"Contributing","text":"<p>Omakase is open source and welcomes contributions! Whether you want to:</p> <ul> <li>Add a new service</li> <li>Improve documentation</li> <li>Fix bugs</li> <li>Share your deployment experience</li> </ul> <p>Check out the Contributing Guide to get started.</p>"},{"location":"#license","title":"License","text":"<p>Omakase is licensed under the MIT License.</p> <ul> <li> <p> Quick Links</p> <ul> <li>Prerequisites</li> <li>Installation</li> <li>Deployment Options</li> <li>Troubleshooting</li> </ul> </li> <li> <p> Documentation</p> <ul> <li>Network Architecture</li> <li>Security Best Practices</li> <li>Backup &amp; Restore</li> <li>Adding Services</li> </ul> </li> </ul> <p>Star on GitHub</p> <p>If you find Omakase useful, please  star the repository on GitHub to show your support!</p>"},{"location":"contributing/","title":"Contributing to Omakase","text":"<p>Thank you for your interest in contributing to Omakase! This guide will help you get started.</p>"},{"location":"contributing/#ways-to-contribute","title":"Ways to Contribute","text":""},{"location":"contributing/#1-documentation","title":"1. Documentation","text":"<ul> <li>Improve existing documentation</li> <li>Add guides for new deployment scenarios</li> <li>Fix typos and clarify instructions</li> <li>Add screenshots and diagrams</li> <li>Translate documentation (coming soon)</li> </ul>"},{"location":"contributing/#2-code-contributions","title":"2. Code Contributions","text":"<ul> <li>Add new services</li> <li>Improve existing service configurations</li> <li>Fix bugs</li> <li>Optimize resource usage</li> <li>Enhance security</li> </ul>"},{"location":"contributing/#3-community-support","title":"3. Community Support","text":"<ul> <li>Answer questions in GitHub Discussions</li> <li>Help troubleshoot issues</li> <li>Share your deployment experiences</li> <li>Write blog posts or tutorials</li> </ul>"},{"location":"contributing/#4-testing","title":"4. Testing","text":"<ul> <li>Test new releases</li> <li>Report bugs</li> <li>Verify documentation accuracy</li> <li>Test on different platforms</li> </ul>"},{"location":"contributing/#getting-started","title":"Getting Started","text":""},{"location":"contributing/#fork-and-clone","title":"Fork and Clone","text":"<pre><code># Fork the repository on GitHub\n# Then clone your fork\ngit clone https://github.com/YOUR-USERNAME/omakase.git\ncd omakase\n\n# Add upstream remote\ngit remote add upstream https://github.com/esoso/omakase.git\n</code></pre>"},{"location":"contributing/#keep-your-fork-updated","title":"Keep Your Fork Updated","text":"<pre><code># Fetch upstream changes\ngit fetch upstream\n\n# Merge upstream main into your local main\ngit checkout main\ngit merge upstream/main\n\n# Push to your fork\ngit push origin main\n</code></pre>"},{"location":"contributing/#create-a-branch","title":"Create a Branch","text":"<pre><code># Create a feature branch\ngit checkout -b feature/my-new-feature\n\n# Or a fix branch\ngit checkout -b fix/issue-description\n</code></pre>"},{"location":"contributing/#development-workflow","title":"Development Workflow","text":""},{"location":"contributing/#1-make-your-changes","title":"1. Make Your Changes","text":"<p>Edit files following the project standards:</p> <ul> <li>Review the project standards and guidelines</li> <li>Follow existing code style</li> <li>Test your changes</li> <li>Update documentation</li> </ul>"},{"location":"contributing/#2-test-locally","title":"2. Test Locally","text":"<pre><code># Validate compose files\nmake config\n\n# Test deployment\nmake up\n\n# Check service status\ndocker compose ps\n\n# View logs\ndocker compose logs -f &lt;service&gt;\n</code></pre>"},{"location":"contributing/#3-documentation-changes","title":"3. Documentation Changes","text":"<p>If you modified documentation:</p> <pre><code># Install MkDocs dependencies\npip install -r requirements.txt\n\n# Serve docs locally\nmkdocs serve\n\n# Open http://127.0.0.1:8000\n</code></pre>"},{"location":"contributing/#4-commit-changes","title":"4. Commit Changes","text":"<p>Follow Conventional Commits:</p> <pre><code># Good commit messages\ngit commit -m \"feat(service): add Uptime Kuma monitoring\"\ngit commit -m \"fix(traefik): resolve SSL certificate renewal issue\"\ngit commit -m \"docs(deployment): add bare metal installation guide\"\ngit commit -m \"chore(deps): update Docker images\"\n\n# Commit types:\n# feat: New feature\n# fix: Bug fix\n# docs: Documentation only\n# style: Code style (formatting, no logic change)\n# refactor: Code refactoring\n# test: Adding tests\n# chore: Maintenance tasks\n# security: Security improvements\n</code></pre>"},{"location":"contributing/#5-push-and-create-pr","title":"5. Push and Create PR","text":"<pre><code># Push to your fork\ngit push origin feature/my-new-feature\n\n# Create Pull Request on GitHub\n# - Provide clear description\n# - Reference related issues\n# - Wait for review\n</code></pre>"},{"location":"contributing/#pull-request-guidelines","title":"Pull Request Guidelines","text":""},{"location":"contributing/#pr-title","title":"PR Title","text":"<p>Use conventional commit format:</p> <pre><code>feat(service): add new service description\nfix(traefik): resolve issue description\ndocs(guide): improve installation instructions\n</code></pre>"},{"location":"contributing/#pr-description","title":"PR Description","text":"<p>Include:</p> <ol> <li>What: Brief description of changes</li> <li>Why: Reason for the change</li> <li>How: Implementation details (if complex)</li> <li>Testing: How you tested the changes</li> <li>Screenshots: If UI changes</li> <li>Checklist: Complete the PR template checklist</li> </ol>"},{"location":"contributing/#pr-template","title":"PR Template","text":"<pre><code>## Description\nBrief description of what this PR does.\n\n## Type of Change\n- [ ] Bug fix\n- [ ] New feature\n- [ ] Documentation update\n- [ ] Configuration change\n- [ ] Security improvement\n\n## Related Issues\nFixes #123\nRelated to #456\n\n## Testing\nHow did you test these changes?\n\n## Checklist\n- [ ] I have read PROJECT_STANDARDS.md\n- [ ] I have tested my changes\n- [ ] I have updated documentation\n- [ ] I have followed commit message conventions\n- [ ] No secrets are committed\n- [ ] Pre-commit hooks pass\n</code></pre>"},{"location":"contributing/#code-review-process","title":"Code Review Process","text":"<ol> <li>Automated Checks: CI/CD runs validation</li> <li>Docker Compose validation</li> <li>YAML linting</li> <li>Secret detection</li> <li> <p>Documentation build</p> </li> <li> <p>Manual Review: Maintainer reviews code</p> </li> <li>Code quality</li> <li>Security implications</li> <li>Documentation completeness</li> <li> <p>Adherence to standards</p> </li> <li> <p>Feedback: Address review comments</p> </li> <li>Make requested changes</li> <li>Push updates to same branch</li> <li> <p>Re-request review</p> </li> <li> <p>Merge: Once approved</p> </li> <li>Maintainer merges PR</li> <li>Automatic deployment (if main branch)</li> <li>Changelog updated automatically</li> </ol>"},{"location":"contributing/#coding-standards","title":"Coding Standards","text":""},{"location":"contributing/#docker-compose-files","title":"Docker Compose Files","text":"<pre><code>services:\n  myservice:\n    # Use extends for common config\n    extends:\n      file: ../common/compose.yaml\n      service: base\n\n    # Pin image versions with digest\n    image: myimage:1.0.0@sha256:abc123...\n\n    # Mandatory security options\n    security_opt:\n      - no-new-privileges:true\n\n    # Resource limits\n    deploy:\n      resources:\n        limits:\n          cpus: '2'\n          memory: 2G\n\n    # Dedicated network\n    networks:\n      - vnet-myservice\n      - ingress  # Only if web-accessible\n\n    # Secrets from Infisical\n    environment:\n      DB_PASSWORD: \"${MYSERVICE_DB_PASSWORD:?err}\"\n</code></pre>"},{"location":"contributing/#documentation","title":"Documentation","text":"<ul> <li>Use Markdown format</li> <li>Follow Material for MkDocs syntax</li> <li>Include code examples</li> <li>Add diagrams where helpful</li> <li>Keep language clear and concise</li> </ul>"},{"location":"contributing/#security","title":"Security","text":"<ul> <li>NEVER commit secrets</li> <li>Use Infisical for all sensitive data</li> <li>Follow principle of least privilege</li> <li>Enable security options on containers</li> <li>Document security implications</li> </ul>"},{"location":"contributing/#adding-a-new-service","title":"Adding a New Service","text":"<p>See detailed guide: Adding Services</p> <p>Quick checklist:</p> <ol> <li>Create <code>compose/&lt;service&gt;/compose.yaml</code></li> <li>Configure dedicated network</li> <li>Add security options</li> <li>Configure secrets in Infisical</li> <li>Add Traefik labels (if web service)</li> <li>Create <code>docs/services/&lt;service&gt;.md</code></li> <li>Update <code>mkdocs.yml</code></li> <li>Test deployment</li> <li>Create PR</li> </ol>"},{"location":"contributing/#documentation-contributions","title":"Documentation Contributions","text":""},{"location":"contributing/#file-organization","title":"File Organization","text":"<pre><code>docs/\n\u251c\u2500\u2500 getting-started/    # Installation and setup\n\u251c\u2500\u2500 deployment/         # Platform-specific guides\n\u251c\u2500\u2500 infrastructure/     # Core component docs\n\u251c\u2500\u2500 security/          # Security guides\n\u251c\u2500\u2500 operations/        # Maintenance and ops\n\u251c\u2500\u2500 services/          # Individual service docs\n\u2514\u2500\u2500 contributing/      # This section\n</code></pre>"},{"location":"contributing/#writing-style","title":"Writing Style","text":"<ul> <li>Clear and concise: Get to the point</li> <li>Step-by-step: Number installation steps</li> <li>Examples: Provide code examples</li> <li>Screenshots: Add visuals when helpful</li> <li>Links: Reference related docs</li> </ul>"},{"location":"contributing/#admonitions","title":"Admonitions","text":"<p>Use Material for MkDocs admonitions:</p> <pre><code>!!! note \"Optional Title\"\n    General information\n\n!!! tip \"Pro Tip\"\n    Helpful advice\n\n!!! warning \"Important\"\n    Warning about potential issues\n\n!!! danger \"Critical\"\n    Critical security or data loss warnings\n</code></pre>"},{"location":"contributing/#community-guidelines","title":"Community Guidelines","text":""},{"location":"contributing/#code-of-conduct","title":"Code of Conduct","text":"<ul> <li>Be respectful and inclusive</li> <li>Welcome newcomers</li> <li>Provide constructive feedback</li> <li>Focus on the issue, not the person</li> <li>Assume good intentions</li> </ul>"},{"location":"contributing/#getting-help","title":"Getting Help","text":"<ul> <li>Questions: Use GitHub Discussions</li> <li>Bugs: Open GitHub Issues</li> <li>Security: Report security issues via GitHub security advisories</li> </ul>"},{"location":"contributing/#communication-channels","title":"Communication Channels","text":"<ul> <li>GitHub Discussions: General questions and discussion</li> <li>GitHub Issues: Bug reports and feature requests</li> <li>Pull Requests: Code and documentation contributions</li> </ul>"},{"location":"contributing/#recognition","title":"Recognition","text":"<p>Contributors are recognized:</p> <ul> <li>Listed in repository contributors</li> <li>Mentioned in changelog (if significant contribution)</li> <li>PR comments and reviews</li> <li>Community acknowledgment</li> </ul>"},{"location":"contributing/#license","title":"License","text":"<p>By contributing, you agree that your contributions will be licensed under the MIT License.</p>"},{"location":"contributing/#questions","title":"Questions?","text":"<p>If you have questions about contributing:</p> <ol> <li>Check existing documentation</li> <li>Search GitHub Discussions</li> <li>Ask in a new Discussion</li> <li>Tag maintainers if needed</li> </ol> <p>Thank you for contributing to Omakase! \ud83c\udf89</p>"},{"location":"contributing/adding-services/","title":"Adding Services","text":"<p>Comprehensive guide for adding new services to Omakase.</p>"},{"location":"contributing/adding-services/#overview","title":"Overview","text":"<p>Omakase's modular architecture makes adding services straightforward. Follow this guide to ensure proper integration with security, networking, and backup systems.</p>"},{"location":"contributing/adding-services/#quick-start","title":"Quick Start","text":"<ol> <li>Create service directory: <code>compose/&lt;service-name&gt;/</code></li> <li>Create <code>compose.yaml</code> with service definition</li> <li>Document in <code>docs/services/&lt;service-name&gt;.md</code></li> <li>Add to include list in <code>compose.prod.yaml</code> or <code>compose.dev.yaml</code></li> <li>Test deployment</li> </ol>"},{"location":"contributing/adding-services/#step-by-step-guide","title":"Step-by-Step Guide","text":""},{"location":"contributing/adding-services/#1-create-service-directory","title":"1. Create Service Directory","text":"<pre><code>mkdir -p compose/&lt;service-name&gt;\ncd compose/&lt;service-name&gt;\n</code></pre>"},{"location":"contributing/adding-services/#2-create-composeyaml","title":"2. Create compose.yaml","text":"<p>Use this template:</p> <pre><code># compose/&lt;service-name&gt;/compose.yaml\n\nservices:\n  &lt;service-name&gt;:\n    image: &lt;image&gt;:&lt;tag&gt;@sha256:&lt;digest&gt;\n    container_name: &lt;service-name&gt;\n    restart: unless-stopped\n    security_opt:\n      - no-new-privileges:true\n    user: \"${PUID}:${PGID}\"\n    networks:\n      - ingress  # Only if web-accessible\n      - vnet-&lt;service-name&gt;\n    environment:\n      # Service configuration\n      SERVICE_KEY: \"${SERVICE_KEY:?err}\"\n    volumes:\n      - ${DATA_DIR}/&lt;service-name&gt;/config:/config\n      - ${DATA_DIR}/&lt;service-name&gt;/data:/data\n    deploy:\n      resources:\n        limits:\n          cpus: '2.0'\n          memory: 2G\n        reservations:\n          cpus: '0.5'\n          memory: 512M\n    labels:\n      # Traefik labels (if web-accessible)\n      - traefik.enable=true\n      - traefik.docker.network=ingress\n      - traefik.http.routers.&lt;service-name&gt;.rule=Host(`&lt;service-name&gt;.${DOMAINNAME}`)\n      - traefik.http.routers.&lt;service-name&gt;.entrypoints=websecure\n      - traefik.http.routers.&lt;service-name&gt;.tls.certresolver=letsencrypt\n      - traefik.http.routers.&lt;service-name&gt;.middlewares=chain-authelia@file\n      - traefik.http.services.&lt;service-name&gt;.loadbalancer.server.port=&lt;port&gt;\n\nnetworks:\n  ingress:\n    external: true\n  vnet-&lt;service-name&gt;:\n    name: vnet-&lt;service-name&gt;\n    driver: bridge\n    ipam:\n      driver: default\n      config:\n        - subnet: 192.168.X.0/24\n          gateway: 192.168.X.1\n\nvolumes:\n  &lt;service-name&gt;_data:\n    driver: local\n    driver_opts:\n      type: none\n      o: bind\n      device: ${DATA_DIR}/&lt;service-name&gt;/data\n</code></pre>"},{"location":"contributing/adding-services/#3-check-network-subnet","title":"3. Check Network Subnet","text":"<p>Find available subnet:</p> <pre><code>make network\n</code></pre> <p>Choose an unused subnet in the <code>192.168.X.0/24</code> range.</p>"},{"location":"contributing/adding-services/#4-add-secrets-to-infisical","title":"4. Add Secrets to Infisical","text":"<p>Add all required secrets to Infisical vault:</p> <pre><code># Example secrets\nSERVICE_NAME_DB_PASSWORD\nSERVICE_NAME_ADMIN_PASSWORD\nSERVICE_NAME_API_KEY\n</code></pre> <p>Follow naming convention: <code>&lt;SERVICE&gt;_&lt;COMPONENT&gt;_&lt;PURPOSE&gt;</code></p>"},{"location":"contributing/adding-services/#5-document-the-service","title":"5. Document the Service","text":"<p>Create <code>docs/services/&lt;service-name&gt;.md</code>:</p> <pre><code># Service Name\n\nBrief description of the service.\n\n## Overview\n\nWhat the service does, key features.\n\n## Configuration\n\n### Environment Variables\n\n| Variable | Description | Example |\n|----------|-------------|---------|\n| `SERVICE_KEY` | Description | `value` |\n\n### Volumes\n\n- `config/`: Configuration files\n- `data/`: Persistent data\n\n## Access\n\n**URL**: `https://&lt;service-name&gt;.${DOMAINNAME}`\n\n**Default credentials**:\n- Username: Set via `SERVICE_ADMIN_USER`\n- Password: Set via `SERVICE_ADMIN_PASSWORD`\n\n## First-Time Setup\n\n1. Access service URL\n2. Complete setup wizard\n3. Configure settings\n\n## Usage\n\nHow to use the service.\n\n## Backup\n\nService data backed up via Restic from `${DATA_DIR}/&lt;service-name&gt;/`.\n\n## Troubleshooting\n\nCommon issues and solutions.\n\n## See Also\n\n- [Official Documentation](https://example.com)\n- [Related Service](other-service.md)\n</code></pre>"},{"location":"contributing/adding-services/#6-add-to-include-list","title":"6. Add to Include List","text":"<p>Edit <code>compose.prod.yaml</code> (or <code>compose.dev.yaml</code>):</p> <pre><code>include:\n  # ... existing services ...\n  - compose/&lt;service-name&gt;/compose.yaml\n</code></pre>"},{"location":"contributing/adding-services/#7-update-mkdocsyml","title":"7. Update mkdocs.yml","text":"<p>Add to navigation:</p> <pre><code>nav:\n  - Services:\n      # ... existing services ...\n      - Service Name: services/&lt;service-name&gt;.md\n</code></pre>"},{"location":"contributing/adding-services/#8-test-deployment","title":"8. Test Deployment","text":"<pre><code># Validate configuration\nmake config\n\n# Deploy\nmake up\n\n# Check status\ndocker compose ps &lt;service-name&gt;\n\n# View logs\ndocker compose logs -f &lt;service-name&gt;\n\n# Test access\ncurl https://&lt;service-name&gt;.yourdomain.com\n</code></pre>"},{"location":"contributing/adding-services/#9-run-pre-commit-checks","title":"9. Run Pre-commit Checks","text":"<pre><code>pre-commit run --all-files\n</code></pre>"},{"location":"contributing/adding-services/#10-commit-changes","title":"10. Commit Changes","text":"<pre><code>git add compose/&lt;service-name&gt;/\ngit add docs/services/&lt;service-name&gt;.md\ngit add compose.prod.yaml\ngit add mkdocs.yml\ngit commit -m \"feat(service): add &lt;service-name&gt;\"\ngit push\n</code></pre>"},{"location":"contributing/adding-services/#service-patterns","title":"Service Patterns","text":""},{"location":"contributing/adding-services/#web-service-only","title":"Web Service Only","text":"<pre><code>services:\n  myservice:\n    image: myservice:latest\n    networks:\n      - ingress\n      - vnet-myservice\n    labels:\n      - traefik.enable=true\n      # ... Traefik labels\n</code></pre>"},{"location":"contributing/adding-services/#service-with-database","title":"Service with Database","text":"<pre><code>services:\n  myservice:\n    image: myservice:latest\n    networks:\n      - ingress\n      - vnet-myservice\n    environment:\n      DB_HOST: myservice-db\n      DB_NAME: myservice\n      DB_USER: myservice\n      DB_PASSWORD: \"${MYSERVICE_DB_PASSWORD:?err}\"\n    depends_on:\n      - myservice-db\n\n  myservice-db:\n    image: postgres:16\n    container_name: myservice-db\n    networks:\n      - vnet-myservice  # NOT on ingress\n    environment:\n      POSTGRES_DB: myservice\n      POSTGRES_USER: myservice\n      POSTGRES_PASSWORD: \"${MYSERVICE_DB_PASSWORD:?err}\"\n    volumes:\n      - myservice_db_data:/var/lib/postgresql/data\n</code></pre>"},{"location":"contributing/adding-services/#service-with-docker-api-access","title":"Service with Docker API Access","text":"<pre><code>services:\n  myservice:\n    image: myservice:latest\n    networks:\n      - ingress\n      - vnet-socket  # For Docker API\n    environment:\n      DOCKER_HOST: tcp://cetusguard:2375\n\nnetworks:\n  ingress:\n    external: true\n  vnet-socket:\n    external: true\n</code></pre>"},{"location":"contributing/adding-services/#service-without-authentication","title":"Service Without Authentication","text":"<p>For services with built-in auth:</p> <pre><code>labels:\n  - traefik.http.routers.myservice.middlewares=chain-no-auth@file\n</code></pre> <p>Or configure bypass in Authelia access rules.</p>"},{"location":"contributing/adding-services/#security-checklist","title":"Security Checklist","text":"<p>Before adding service, ensure:</p> <ul> <li> <code>security_opt: no-new-privileges:true</code> set</li> <li> Resource limits configured</li> <li> Secrets in Infisical, not hardcoded</li> <li> Dedicated network (<code>vnet-service</code>)</li> <li> Only connects to required networks</li> <li> Non-root user (<code>user: \"${PUID}:${PGID}\"</code>) if possible</li> <li> Traefik labels correct if web-accessible</li> <li> Authentication configured (Authelia or service-specific)</li> <li> Database not on ingress network</li> <li> No direct Docker socket access</li> </ul>"},{"location":"contributing/adding-services/#common-patterns","title":"Common Patterns","text":""},{"location":"contributing/adding-services/#extend-base-service","title":"Extend Base Service","text":"<p>Use common base definitions:</p> <pre><code>services:\n  myservice:\n    extends:\n      file: ../common/compose.yaml\n      service: base\n    image: myservice:latest\n    # Additional config\n</code></pre>"},{"location":"contributing/adding-services/#multiple-instances","title":"Multiple Instances","text":"<p>Run multiple instances of same service:</p> <pre><code>services:\n  myservice-1:\n    # Config for instance 1\n\n  myservice-2:\n    # Config for instance 2\n    # Use different ports, volumes, networks\n</code></pre>"},{"location":"contributing/adding-services/#init-containers-workaround","title":"Init Containers (Workaround)","text":"<p>Docker Compose doesn't have init containers, but you can use depends_on with healthcheck:</p> <pre><code>services:\n  myservice:\n    depends_on:\n      init-task:\n        condition: service_completed_successfully\n\n  init-task:\n    image: myservice:latest\n    command: /init.sh\n    restart: \"no\"\n</code></pre>"},{"location":"contributing/adding-services/#testing","title":"Testing","text":""},{"location":"contributing/adding-services/#local-testing","title":"Local Testing","text":"<p>Test in development environment:</p> <pre><code># Use dev compose\ndocker compose -f compose.yaml -f compose.dev.yaml up -d &lt;service-name&gt;\n\n# Check logs\ndocker compose logs -f &lt;service-name&gt;\n\n# Test functionality\n</code></pre>"},{"location":"contributing/adding-services/#validation","title":"Validation","text":"<pre><code># Validate compose syntax\ndocker compose config\n\n# Check secret injection\nmake config | grep SERVICE_NAME\n\n# Verify network\ndocker network inspect vnet-&lt;service-name&gt;\n\n# Check resources\ndocker stats &lt;service-name&gt;\n</code></pre>"},{"location":"contributing/adding-services/#troubleshooting","title":"Troubleshooting","text":""},{"location":"contributing/adding-services/#service-wont-start","title":"Service Won't Start","text":"<p>Check logs: <pre><code>docker compose logs &lt;service-name&gt;\n</code></pre></p> <p>Common issues: - Missing secrets - Permission errors - Port conflicts - Network issues</p>"},{"location":"contributing/adding-services/#cant-access-via-web","title":"Can't Access via Web","text":"<p>Check: - Service on <code>ingress</code> network? - Traefik labels correct? - DNS configured? - Authelia allowing access?</p>"},{"location":"contributing/adding-services/#database-connection-fails","title":"Database Connection Fails","text":"<p>Check: - Both services on same network? - DB_HOST correct? - Credentials correct? - Database ready? (add healthcheck)</p>"},{"location":"contributing/adding-services/#best-practices","title":"Best Practices","text":"<ol> <li>Pin versions - Use specific tags with digests</li> <li>Document thoroughly - Complete service documentation</li> <li>Test extensively - Before committing</li> <li>Follow conventions - Naming, structure, security</li> <li>Minimal networks - Only connect to required networks</li> <li>Resource limits - Prevent resource exhaustion</li> <li>Health checks - Add healthcheck where possible</li> <li>Graceful shutdown - Use proper stop signals</li> <li>Backup considerations - Document what needs backup</li> <li>Update mkdocs - Keep navigation updated</li> </ol>"},{"location":"contributing/adding-services/#service-template","title":"Service Template","text":"<p>Copy this template for new services:</p> <pre><code># compose/&lt;service-name&gt;/compose.yaml\n\nservices:\n  &lt;service-name&gt;:\n    image: &lt;image&gt;:&lt;version&gt;@sha256:&lt;digest&gt;\n    container_name: &lt;service-name&gt;\n    restart: unless-stopped\n    security_opt:\n      - no-new-privileges:true\n    user: \"${PUID}:${PGID}\"\n    networks:\n      - ingress\n      - vnet-&lt;service-name&gt;\n    environment:\n      TZ: ${TZ}\n      # Service-specific vars\n    volumes:\n      - ${DATA_DIR}/&lt;service-name&gt;/config:/config\n      - ${DATA_DIR}/&lt;service-name&gt;/data:/data\n    deploy:\n      resources:\n        limits:\n          cpus: '1.0'\n          memory: 1G\n        reservations:\n          cpus: '0.25'\n          memory: 256M\n    healthcheck:\n      test: [\"CMD\", \"wget\", \"--no-verbose\", \"--tries=1\", \"--spider\", \"http://localhost:&lt;port&gt;/health\"]\n      interval: 30s\n      timeout: 10s\n      retries: 3\n      start_period: 40s\n    labels:\n      - traefik.enable=true\n      - traefik.docker.network=ingress\n      - traefik.http.routers.&lt;service-name&gt;.rule=Host(`&lt;service-name&gt;.${DOMAINNAME}`)\n      - traefik.http.routers.&lt;service-name&gt;.entrypoints=websecure\n      - traefik.http.routers.&lt;service-name&gt;.tls.certresolver=letsencrypt\n      - traefik.http.routers.&lt;service-name&gt;.middlewares=chain-authelia@file\n      - traefik.http.services.&lt;service-name&gt;.loadbalancer.server.port=&lt;port&gt;\n\nnetworks:\n  ingress:\n    external: true\n  vnet-&lt;service-name&gt;:\n    name: vnet-&lt;service-name&gt;\n    driver: bridge\n    ipam:\n      driver: default\n      config:\n        - subnet: 192.168.X.0/24\n          gateway: 192.168.X.1\n</code></pre>"},{"location":"contributing/adding-services/#see-also","title":"See Also","text":"<ul> <li>Network Architecture - Network design</li> <li>Security Best Practices - Security guidelines</li> <li>Services Index - Existing services</li> <li>How to Contribute - Contribution guidelines</li> </ul>"},{"location":"deployment/","title":"Deployment Scenarios","text":"<p>Omakase can be deployed in various environments, from your home network to cloud infrastructure. This section guides you through the most common deployment patterns.</p>"},{"location":"deployment/#architectural-flexibility","title":"Architectural Flexibility","text":"<p>Omakase was born from a production homelab setup and has been generalized to support different architectural choices while maintaining core security and operational principles.</p>"},{"location":"deployment/#fixed-principles-non-negotiable","title":"Fixed Principles (Non-Negotiable)","text":"<p>These principles are fundamental to Omakase and cannot be compromised:</p> <ul> <li>Security-First Architecture: No secrets in git, mandatory network isolation, <code>no-new-privileges</code> on all containers</li> <li>External Secret Management: Secrets must be stored in an external vault (Infisical recommended)</li> <li>Network Isolation: Each service requires its own isolated network (<code>vnet-&lt;service&gt;</code>)</li> <li>Infrastructure-as-Code: All configuration declarative, versioned, and reproducible</li> <li>Backup Strategy: Data protection with automated, encrypted backups</li> </ul>"},{"location":"deployment/#flexible-architectural-aspects","title":"Flexible Architectural Aspects","text":"<p>While core principles remain fixed, Omakase adapts to different infrastructure patterns:</p>"},{"location":"deployment/#ssl-termination-options","title":"SSL Termination Options","text":"<ul> <li>External Proxy (reference setup): HAProxy/nginx upstream handles SSL, Traefik receives HTTP</li> <li>Direct Traefik: Traefik manages Let's Encrypt certificates directly</li> <li>Cloudflare Tunnel: Zero-trust access without exposed ports</li> <li>Custom: Caddy, Nginx Proxy Manager, or other reverse proxies</li> </ul>"},{"location":"deployment/#platform-choices","title":"Platform Choices","text":"<ul> <li>Proxmox LXC (reference setup): Lightweight containerization with minimal overhead</li> <li>Bare Metal: Direct installation on physical hardware</li> <li>Virtual Machines: VMware, VirtualBox, KVM, or cloud VMs</li> <li>NAS Devices: Synology, QNAP with Docker support</li> <li>Cloud VPS: DigitalOcean, Hetzner, AWS, GCP, Azure</li> </ul>"},{"location":"deployment/#storage-backends","title":"Storage Backends","text":"<ul> <li>ZFS with bind mounts (reference setup): Enterprise-grade with snapshots and compression</li> <li>Local filesystem: Direct storage on ext4/xfs</li> <li>Network storage: NFS, CIFS, iSCSI shares</li> <li>Cloud storage: Block storage from cloud providers</li> </ul>"},{"location":"deployment/#secret-management-deployment","title":"Secret Management Deployment","text":"<ul> <li>Dedicated host (reference setup): Infisical on separate LXC/VM</li> <li>Infisical Cloud: SaaS offering (free tier available)</li> <li>Co-located: Infisical containerized within the same stack</li> <li>Alternatives: HashiCorp Vault, Doppler, 1Password</li> <li>Development only: <code>.env</code> files (not for production)</li> </ul>"},{"location":"deployment/#multi-environment-patterns","title":"Multi-Environment Patterns","text":"<ul> <li>Separated environments (reference setup): Dedicated PROD and DEV stacks on separate hosts/domains</li> <li>Single environment: Production-only deployment</li> <li>Docker Compose profiles: Environment switching via profiles</li> <li>Branch-based: Different branches for different environments</li> </ul>"},{"location":"deployment/#documentation-scope","title":"Documentation Scope","text":"<p>This documentation provides: - \u2705 Reference architecture based on the production setup (Proxmox + HAProxy + multi-LXC) - \u2705 Alternative deployment guides for common scenarios - \u2705 Configuration patterns that adapt to different architectures - \u274c Detailed implementation for every possible combination (out of scope)</p> <p>The compose file structure (<code>compose.yaml</code>, <code>compose.prod.yaml</code>, <code>compose.dev.yaml</code>) already supports flexible deployment patterns through Docker Compose's multi-file composition.</p>"},{"location":"deployment/#choose-your-deployment-scenario","title":"Choose Your Deployment Scenario","text":""},{"location":"deployment/#homelab-deployments","title":"\ud83c\udfe0 Homelab Deployments","text":"**[Proxmox with LXC Containers](proxmox-lxc.md)** \u2b50 Recommended  Production-tested setup with Debian LXC containers on Proxmox VE.  **Advantages:** - Minimal overhead vs full VMs - Integrated snapshots and backups - Dynamic resource allocation - Secure isolation  **Requirements:** - Proxmox VE 8.0+ - 8+ CPU cores, 16GB+ RAM - 500GB+ storage     **[Bare Metal Server](bare-metal.md)**  Direct installation on dedicated physical hardware.  **Advantages:** - Maximum performance - Total hardware control - No virtualization layer  **Requirements:** - Dedicated physical server - Linux (Debian/Ubuntu) - 8+ CPU cores, 16GB+ RAM     **[Generic Virtual Machine](vm-generic.md)**  Deployment on VM platforms (VMware, VirtualBox, KVM).  **Advantages:** - Portability between hypervisors - Easy snapshots and cloning - Complete isolation  **Requirements:** - Any hypervisor - Linux VM - 8GB+ RAM, 200GB+ storage     **[NAS Devices (Synology/QNAP)](nas.md)**  Run on NAS hardware with Docker support.  **Advantages:** - Use existing hardware - Integrated storage - Built-in NAS backups  **Requirements:** - Synology DSM 7.0+ or QNAP - Container Station/Docker - 8GB+ RAM"},{"location":"deployment/#cloud-deployments","title":"\u2601\ufe0f Cloud Deployments","text":"**[Cloud VPS](cloud-vps.md)**  Deploy on cloud providers (DigitalOcean, Hetzner, Vultr).  **Advantages:** - Accessible from anywhere - Dedicated public IP - On-demand scalability  **Requirements:** - Linux VPS (Debian/Ubuntu) - 4+ CPU, 8GB+ RAM - 200GB+ storage  **Recommended Providers:** - Hetzner Cloud (CPX41: \u20ac20/month) - DigitalOcean (8GB: $48/month) - Vultr (High Frequency: $48/month)     **[AWS/GCP/Azure](cloud-enterprise.md)**  Enterprise cloud setup with managed services.  **Advantages:** - Guaranteed SLAs - Integrated managed services - Auto-scaling capabilities  **Requirements:** - Cloud provider account - IaC knowledge (Terraform) - Enterprise budget  **Estimated Costs:** - AWS: $80-150/month - GCP: $70-130/month - Azure: $75-140/month"},{"location":"deployment/#architecture-comparison","title":"Architecture Comparison","text":"Scenario Setup Cost Monthly Cost Complexity Performance Uptime Best For Proxmox LXC \u20ac500-1500 \u20ac10-30 (power) Medium Excellent 99%+ Advanced homelab Bare Metal \u20ac300-1000 \u20ac10-30 (power) Low Excellent 99%+ Basic homelab Generic VM \u20ac0* \u20ac0-30 Low Good 95%+ Testing &amp; development NAS \u20ac300-800 \u20ac5-15 (power) Low Good 99%+ Homelab with existing NAS Cloud VPS \u20ac0 \u20ac20-50 Low Good 99.9%+ Remote access priority Cloud Enterprise \u20ac0 \u20ac80-150+ High Excellent 99.99%+ Business production <p>* If hardware already available</p>"},{"location":"deployment/#common-components-across-all-scenarios","title":"Common Components Across All Scenarios","text":"<p>Regardless of your chosen scenario, you'll need:</p>"},{"location":"deployment/#1-operating-system","title":"1. Operating System","text":"<ul> <li>Recommended: Debian 12 (Bookworm)</li> <li>Supported alternatives: Ubuntu 22.04/24.04 LTS</li> </ul>"},{"location":"deployment/#2-container-runtime","title":"2. Container Runtime","text":"<ul> <li>Docker Engine 24.0+</li> <li>Docker Compose v2.20+</li> </ul>"},{"location":"deployment/#3-secret-management","title":"3. Secret Management","text":"<p>Options (in order of recommendation): - \u2705 Infisical Self-Hosted (recommended for homelab) - \u2705 Infisical Cloud (free for personal use) - \u26a0\ufe0f Alternative vaults: HashiCorp Vault, Doppler, 1Password - \u26a0\ufe0f <code>.env</code> files (development only, not for production)</p>"},{"location":"deployment/#4-reverse-proxy-ssl","title":"4. Reverse Proxy &amp; SSL","text":"<p>Options: - \u2705 Traefik (included in Omakase) - \u2705 Traefik + External HAProxy/nginx (reference Proxmox setup) - \u2705 Nginx Proxy Manager (user-friendly alternative) - \u26a0\ufe0f Cloudflare Tunnel (may limit some services)</p>"},{"location":"deployment/#5-backup-storage","title":"5. Backup Storage","text":"<ul> <li>Local: NAS, external hard drives</li> <li>Cloud: Backblaze B2 (recommended), AWS S3, Wasabi</li> <li>Hybrid: Local backup + cloud replication</li> </ul>"},{"location":"deployment/#quick-start-by-scenario","title":"Quick Start by Scenario","text":""},{"location":"deployment/#homelab-proxmoxbare-metal","title":"Homelab (Proxmox/Bare Metal)","text":"<pre><code># 1. Set up self-hosted Infisical (see specific guide)\n# 2. Clone Omakase\ngit clone https://github.com/esoso/omakase.git\ncd omakase\n\n# 3. Configure secrets in Infisical\n# 4. Deploy\nmake up\n</code></pre> <p>Estimated time: 2-4 hours</p>"},{"location":"deployment/#cloud-vps","title":"Cloud VPS","text":"<pre><code># 1. Provision VPS\n# 2. Install Docker\ncurl -fsSL https://get.docker.com | sh\n\n# 3. Clone and deploy\ngit clone https://github.com/esoso/omakase.git\ncd omakase\n# Configure Infisical Cloud\nmake up\n</code></pre> <p>Estimated time: 1-2 hours</p>"},{"location":"deployment/#decision-guide","title":"Decision Guide","text":""},{"location":"deployment/#choose-proxmox-lxc-if","title":"Choose Proxmox LXC if:","text":"<ul> <li>\u2705 You have a homelab server with Proxmox</li> <li>\u2705 You want to manage multiple isolated projects/services</li> <li>\u2705 You need integrated backups and snapshots</li> <li>\u2705 You're familiar with Proxmox</li> </ul>"},{"location":"deployment/#choose-bare-metal-if","title":"Choose Bare Metal if:","text":"<ul> <li>\u2705 You have dedicated hardware for Omakase only</li> <li>\u2705 You want maximum performance</li> <li>\u2705 You don't need virtualization</li> <li>\u2705 You prefer simple, direct setup</li> </ul>"},{"location":"deployment/#choose-cloud-vps-if","title":"Choose Cloud VPS if:","text":"<ul> <li>\u2705 You don't have homelab hardware</li> <li>\u2705 You want access from anywhere without VPN</li> <li>\u2705 You prefer to outsource hardware management</li> <li>\u2705 Budget: \u20ac20-50/month</li> </ul>"},{"location":"deployment/#choose-nas-if","title":"Choose NAS if:","text":"<ul> <li>\u2705 You already have a Synology/QNAP NAS with Docker</li> <li>\u2705 You want to consolidate on existing hardware</li> <li>\u2705 Storage is your primary concern</li> </ul>"},{"location":"deployment/#resource-requirements","title":"Resource Requirements","text":""},{"location":"deployment/#minimum-configuration-15-20-services","title":"Minimum Configuration (15-20 services)","text":"<ul> <li>CPU: 4 cores</li> <li>RAM: 8 GB</li> <li>Storage: 200 GB</li> <li>Network: 100 Mbps</li> </ul> <p>Services to exclude for reduced resources: - Media stack (Jellyfin, *arr apps) - Development tools - Game servers</p>"},{"location":"deployment/#recommended-configuration-25-30-services","title":"Recommended Configuration (25-30 services)","text":"<ul> <li>CPU: 8+ cores</li> <li>RAM: 16 GB</li> <li>Storage: 500 GB</li> <li>Network: 1 Gbps</li> </ul> <p>Includes complete stack as per <code>compose.prod.yaml</code>.</p>"},{"location":"deployment/#enterprise-configuration-30-services-ha","title":"Enterprise Configuration (30+ services + HA)","text":"<ul> <li>CPU: 16+ cores</li> <li>RAM: 32 GB+</li> <li>Storage: 1 TB+ (SSD)</li> <li>Network: 10 Gbps</li> </ul> <p>For HA setups, Proxmox clusters, Kubernetes, etc.</p>"},{"location":"deployment/#reference-architecture-production-setup","title":"Reference Architecture (Production Setup)","text":"<p>The reference architecture this project is based on:</p> <pre><code>Internet\n   \u2193\n[OPNSense Firewall]\n   \u251c\u2500 HAProxy (SSL termination, Let's Encrypt)\n   \u2514\u2500 SNI-based routing\n   \u2193\n[Proxmox Hypervisor]\n   \u251c\u2500 Internal network (192.168.x.0/24)\n   \u2502\n   \u251c\u2500 [LXC: Production] *.example.com\n   \u2502  \u251c\u2500 Traefik (HTTP routing)\n   \u2502  \u251c\u2500 Full Omakase stack (compose.yaml + compose.prod.yaml)\n   \u2502  \u251c\u2500 Storage: ZFS bind mounts\n   \u2502  \u2514\u2500 Restic backups \u2192 Backblaze B2\n   \u2502\n   \u251c\u2500 [LXC: Development] *.dev.example.com\n   \u2502  \u251c\u2500 Traefik (HTTP routing)\n   \u2502  \u251c\u2500 Dev stack (compose.yaml + compose.dev.yaml)\n   \u2502  \u2514\u2500 Storage: virtual disk\n   \u2502\n   \u251c\u2500 [LXC: Infisical]\n   \u2502  \u2514\u2500 Secret management (internal network access)\n   \u2502\n   \u2514\u2500 [LXC: CI/CD]\n      \u251c\u2500 Renovate (dependency updates)\n      \u2514\u2500 GitHub Actions runner (self-hosted)\n</code></pre> <p>Key characteristics: - SSL termination: Centralized in OPNSense HAProxy - Multi-environment: Separate PROD and DEV stacks - Network isolation: Each LXC isolated, internal network for Proxmox - Storage strategy: ZFS for prod (snapshots, compression), virtual disk for dev - Backup strategy: Automated Restic to cloud (prod only)</p> <p>This architecture is battle-tested but not mandatory. Adapt to your infrastructure while maintaining security principles.</p>"},{"location":"deployment/#next-steps","title":"Next Steps","text":"<ol> <li>Choose your scenario from the guides above</li> <li>Read prerequisites in the Getting Started section</li> <li>Follow installation guide specific to your environment</li> <li>Configure services you need</li> </ol>"},{"location":"deployment/#support","title":"Support","text":"<p>Questions about choosing a deployment scenario? Open a GitHub Discussion describing: - Your current hardware/setup - Services you want to run - Available budget - Your priorities (performance, cost, simplicity)</p> <p>The community will help you choose the best solution!</p>"},{"location":"deployment/bare-metal/","title":"Bare Metal Deployment","text":"<p>Deploy Omakase directly on physical hardware for maximum performance and control.</p>"},{"location":"deployment/bare-metal/#overview","title":"Overview","text":"<p>Bare metal deployment involves installing Omakase directly on physical hardware without virtualization.</p> <p>Advantages: - Maximum performance (no hypervisor overhead) - Direct hardware access - Simpler architecture - Lower resource requirements</p> <p>Disadvantages: - Less flexible - Harder to backup/restore - Single point of failure - Resource dedicated to homelab</p>"},{"location":"deployment/bare-metal/#hardware-requirements","title":"Hardware Requirements","text":""},{"location":"deployment/bare-metal/#minimum","title":"Minimum","text":"<ul> <li>CPU: 4 cores (x86_64)</li> <li>RAM: 8GB</li> <li>Storage: 250GB SSD</li> <li>Network: Gigabit Ethernet</li> </ul>"},{"location":"deployment/bare-metal/#recommended","title":"Recommended","text":"<ul> <li>CPU: 8+ cores with AES-NI</li> <li>RAM: 16GB+</li> <li>Storage: 500GB+ NVMe SSD</li> <li>Network: Gigabit or 10GbE</li> <li>UPS: Battery backup for power protection</li> </ul>"},{"location":"deployment/bare-metal/#storage-layout","title":"Storage Layout","text":"<p>Separate OS and data storage:</p> <pre><code>/dev/sda (256GB SSD): OS and Docker\n  /dev/sda1: /boot (1GB)\n  /dev/sda2: / (50GB)\n  /dev/sda3: swap (16GB)\n  /dev/sda4: /var/lib/docker (remaining)\n\n/dev/sdb (1TB+ HDD/SSD): Data\n  /dev/sdb1: /mnt/storage (entire disk)\n    \u2192 ${DATA_DIR}\n</code></pre>"},{"location":"deployment/bare-metal/#operating-system","title":"Operating System","text":""},{"location":"deployment/bare-metal/#recommended-ubuntu-server-2404-lts","title":"Recommended: Ubuntu Server 24.04 LTS","text":"<p>Why: - Long-term support (5 years) - Well-documented - Strong Docker support - Large community</p>"},{"location":"deployment/bare-metal/#installation","title":"Installation","text":"<ol> <li>Download: Ubuntu Server 24.04 LTS</li> <li>Create bootable USB: Using Rufus, balenaEtcher, or <code>dd</code></li> <li>Boot from USB</li> <li>Install:</li> <li>Minimal server installation</li> <li>Enable SSH server</li> <li>Configure static IP</li> <li>Set up user account</li> </ol>"},{"location":"deployment/bare-metal/#alternative-os-options","title":"Alternative OS Options","text":"<ul> <li>Debian 12: More stable, older packages</li> <li>Rocky Linux 9: RHEL-based, enterprise focus</li> <li>Arch Linux: Rolling release, latest packages</li> </ul>"},{"location":"deployment/bare-metal/#initial-setup","title":"Initial Setup","text":""},{"location":"deployment/bare-metal/#1-update-system","title":"1. Update System","text":"<pre><code>sudo apt update &amp;&amp; sudo apt upgrade -y\nsudo reboot\n</code></pre>"},{"location":"deployment/bare-metal/#2-install-prerequisites","title":"2. Install Prerequisites","text":"<pre><code># Docker\ncurl -fsSL https://get.docker.com | sh\nsudo usermod -aG docker $USER\n\n# Docker Compose\nsudo apt install docker-compose-plugin\n\n# Infisical CLI\ncurl -1sLf 'https://dl.cloudsmith.io/public/infisical/infisical-cli/setup.deb.sh' | sudo -E bash\nsudo apt-get update &amp;&amp; sudo apt-get install -y infisical\n\n# Useful tools\nsudo apt install -y htop iotop git make pwgen\n</code></pre> <p>Log out and back in for docker group to take effect.</p>"},{"location":"deployment/bare-metal/#3-configure-storage","title":"3. Configure Storage","text":"<p>Mount data partition:</p> <pre><code># Create mount point\nsudo mkdir -p /mnt/storage\n\n# Get UUID\nsudo blkid /dev/sdb1\n\n# Add to /etc/fstab\necho \"UUID=&lt;uuid&gt; /mnt/storage ext4 defaults,noatime 0 2\" | sudo tee -a /etc/fstab\n\n# Mount\nsudo mount -a\n\n# Set permissions\nsudo chown -R $USER:$USER /mnt/storage\n</code></pre>"},{"location":"deployment/bare-metal/#4-configure-network","title":"4. Configure Network","text":"<p>Static IP configuration (<code>/etc/netplan/00-installer-config.yaml</code>):</p> <pre><code>network:\n  version: 2\n  ethernets:\n    ens18:  # Your interface name\n      addresses:\n        - 192.168.1.100/24\n      gateway4: 192.168.1.1\n      nameservers:\n        addresses:\n          - 1.1.1.1\n          - 8.8.8.8\n</code></pre> <p>Apply: <pre><code>sudo netplan apply\n</code></pre></p>"},{"location":"deployment/bare-metal/#5-configure-firewall","title":"5. Configure Firewall","text":"<pre><code># Install UFW\nsudo apt install ufw\n\n# Default policies\nsudo ufw default deny incoming\nsudo ufw default allow outgoing\n\n# Allow SSH\nsudo ufw allow 22/tcp\n\n# Allow HTTP/HTTPS\nsudo ufw allow 80/tcp\nsudo ufw allow 443/tcp\n\n# Enable\nsudo ufw enable\n</code></pre>"},{"location":"deployment/bare-metal/#deploy-omakase","title":"Deploy Omakase","text":""},{"location":"deployment/bare-metal/#1-clone-repository","title":"1. Clone Repository","text":"<pre><code>cd ~\ngit clone https://github.com/yourusername/omakase.git\ncd omakase\n</code></pre>"},{"location":"deployment/bare-metal/#2-configure-environment","title":"2. Configure Environment","text":"<pre><code># Set up Infisical\nexport INFISICAL_DOMAIN=\"your-infisical-domain\"\nexport INFISICAL_PROJECT_ID=\"your-project-id\"\nexport INFISICAL_CLIENT_ID=\"your-client-id\"\nexport INFISICAL_CLIENT_SECRET=\"your-client-secret\"\n\n# Or login interactively\ninfisical login\n</code></pre>"},{"location":"deployment/bare-metal/#3-configure-data-directory","title":"3. Configure Data Directory","text":"<p>Create <code>.env</code> or add to Infisical: <pre><code>DATA_DIR=/mnt/storage/omakase\nDOMAINNAME=yourdomain.com\nPUID=1000\nPGID=1000\nTZ=Europe/Rome\n</code></pre></p>"},{"location":"deployment/bare-metal/#4-initialize-data-directories","title":"4. Initialize Data Directories","text":"<pre><code>make config  # Verify configuration\nmake up      # Deploy services\n</code></pre>"},{"location":"deployment/bare-metal/#5-verify-deployment","title":"5. Verify Deployment","text":"<pre><code>docker compose ps\ndocker compose logs\n</code></pre>"},{"location":"deployment/bare-metal/#performance-optimization","title":"Performance Optimization","text":""},{"location":"deployment/bare-metal/#docker-storage-driver","title":"Docker Storage Driver","text":"<p>Use overlay2 with <code>/etc/docker/daemon.json</code>:</p> <pre><code>{\n  \"storage-driver\": \"overlay2\",\n  \"log-driver\": \"json-file\",\n  \"log-opts\": {\n    \"max-size\": \"10m\",\n    \"max-file\": \"3\"\n  }\n}\n</code></pre> <p>Restart Docker: <pre><code>sudo systemctl restart docker\n</code></pre></p>"},{"location":"deployment/bare-metal/#system-tuning","title":"System Tuning","text":"<p>Optimize kernel parameters (<code>/etc/sysctl.conf</code>):</p> <pre><code># Network optimization\nnet.core.somaxconn = 1024\nnet.ipv4.tcp_max_syn_backlog = 2048\nnet.ipv4.ip_local_port_range = 10000 65535\n\n# Container optimization\nvm.swappiness = 10\nvm.overcommit_memory = 1\n\n# File handles\nfs.file-max = 100000\nfs.inotify.max_user_watches = 524288\n</code></pre> <p>Apply: <pre><code>sudo sysctl -p\n</code></pre></p>"},{"location":"deployment/bare-metal/#disk-optimization","title":"Disk Optimization","text":"<p>Mount options for SSD: <pre><code>UUID=xxx /mnt/storage ext4 defaults,noatime,discard 0 2\n</code></pre></p> <p>Enable TRIM: <pre><code>sudo systemctl enable fstrim.timer\nsudo systemctl start fstrim.timer\n</code></pre></p>"},{"location":"deployment/bare-metal/#high-availability","title":"High Availability","text":""},{"location":"deployment/bare-metal/#raid-configuration","title":"RAID Configuration","text":"<p>For data redundancy:</p> <p>RAID 1 (mirroring): <pre><code># Create RAID 1 array\nsudo mdadm --create /dev/md0 --level=1 --raid-devices=2 /dev/sdb /dev/sdc\n\n# Format\nsudo mkfs.ext4 /dev/md0\n\n# Mount\nsudo mount /dev/md0 /mnt/storage\n</code></pre></p> <p>RAID 10 (high performance + redundancy): Requires 4+ disks.</p>"},{"location":"deployment/bare-metal/#ups-configuration","title":"UPS Configuration","text":"<p>Install NUT (Network UPS Tools):</p> <pre><code>sudo apt install nut\n\n# Configure UPS in /etc/nut/ups.conf\n# Configure shutdown in /etc/nut/upsd.conf\n</code></pre>"},{"location":"deployment/bare-metal/#monitoring","title":"Monitoring","text":"<p>Install node exporter for monitoring:</p> <pre><code># Add to compose.yaml\nservices:\n  node-exporter:\n    image: prom/node-exporter:latest\n    container_name: node-exporter\n    restart: unless-stopped\n    network_mode: host\n    volumes:\n      - /proc:/host/proc:ro\n      - /sys:/host/sys:ro\n      - /:/rootfs:ro\n    command:\n      - '--path.procfs=/host/proc'\n      - '--path.sysfs=/host/sys'\n      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'\n</code></pre>"},{"location":"deployment/bare-metal/#backup-strategy","title":"Backup Strategy","text":""},{"location":"deployment/bare-metal/#system-backup","title":"System Backup","text":"<p>OS configuration: <pre><code># Backup critical configs\ntar czf system-backup.tar.gz \\\n  /etc/fstab \\\n  /etc/netplan/ \\\n  /etc/docker/ \\\n  ~/.ssh/\n</code></pre></p> <p>Omakase configuration: <pre><code>cd ~/omakase\ntar czf omakase-config.tar.gz compose*\n</code></pre></p>"},{"location":"deployment/bare-metal/#data-backup","title":"Data Backup","text":"<p>Omakase's built-in Restic backup handles data automatically.</p>"},{"location":"deployment/bare-metal/#full-system-image","title":"Full System Image","text":"<p>Create disk image: <pre><code># Using Clonezilla or dd\nsudo dd if=/dev/sda of=/mnt/backup/system.img bs=4M status=progress\n</code></pre></p>"},{"location":"deployment/bare-metal/#disaster-recovery","title":"Disaster Recovery","text":""},{"location":"deployment/bare-metal/#system-failure","title":"System Failure","text":"<ol> <li>Boot from installation USB</li> <li>Restore OS from image or reinstall</li> <li>Restore configuration from backup</li> <li>Mount data disk</li> <li>Restore Omakase stack</li> <li>Restore data from Restic backup if needed</li> </ol>"},{"location":"deployment/bare-metal/#disk-failure","title":"Disk Failure","text":"<p>With RAID: <pre><code># Replace failed disk\nsudo mdadm --manage /dev/md0 --add /dev/sdX\n\n# Monitor rebuild\nwatch cat /proc/mdstat\n</code></pre></p> <p>Without RAID: 1. Replace disk 2. Format and mount 3. Restore from Restic backup</p>"},{"location":"deployment/bare-metal/#maintenance","title":"Maintenance","text":""},{"location":"deployment/bare-metal/#regular-tasks","title":"Regular Tasks","text":"<p>Daily: <pre><code># Check service status\ndocker compose ps\n\n# Monitor resources\nhtop\n</code></pre></p> <p>Weekly: <pre><code># Update images\nmake pull\nmake restart\n\n# Check disk health\nsudo smartctl -a /dev/sda\n</code></pre></p> <p>Monthly: <pre><code># Update system\nsudo apt update &amp;&amp; sudo apt upgrade -y\n\n# Clean Docker\nmake clean\n\n# Check RAID (if applicable)\ncat /proc/mdstat\n</code></pre></p>"},{"location":"deployment/bare-metal/#security-hardening","title":"Security Hardening","text":""},{"location":"deployment/bare-metal/#ssh-security","title":"SSH Security","text":"<p>Edit <code>/etc/ssh/sshd_config</code>:</p> <pre><code>PermitRootLogin no\nPasswordAuthentication no\nPubkeyAuthentication yes\nAllowUsers yourusername\n</code></pre> <p>Restart SSH: <pre><code>sudo systemctl restart sshd\n</code></pre></p>"},{"location":"deployment/bare-metal/#automatic-updates","title":"Automatic Updates","text":"<pre><code># Install unattended-upgrades\nsudo apt install unattended-upgrades\n\n# Configure\nsudo dpkg-reconfigure -plow unattended-upgrades\n</code></pre>"},{"location":"deployment/bare-metal/#fail2ban","title":"Fail2ban","text":"<pre><code>sudo apt install fail2ban\n\n# Configure for SSH\nsudo systemctl enable fail2ban\nsudo systemctl start fail2ban\n</code></pre>"},{"location":"deployment/bare-metal/#troubleshooting","title":"Troubleshooting","text":""},{"location":"deployment/bare-metal/#service-wont-start","title":"Service Won't Start","text":"<p>Check Docker status: <pre><code>sudo systemctl status docker\nsudo journalctl -u docker -n 50\n</code></pre></p>"},{"location":"deployment/bare-metal/#disk-full","title":"Disk Full","text":"<p>Find large files: <pre><code>sudo du -sh /* | sort -h\ndocker system df\n</code></pre></p> <p>Clean up: <pre><code>make clean\ndocker system prune -a\n</code></pre></p>"},{"location":"deployment/bare-metal/#network-issues","title":"Network Issues","text":"<p>Check configuration: <pre><code>ip addr show\nip route show\nping 8.8.8.8\n</code></pre></p>"},{"location":"deployment/bare-metal/#performance-issues","title":"Performance Issues","text":"<p>Check resources: <pre><code>htop\niotop\ndocker stats\n</code></pre></p>"},{"location":"deployment/bare-metal/#scaling","title":"Scaling","text":""},{"location":"deployment/bare-metal/#adding-more-services","title":"Adding More Services","text":"<p>Omakase's modular design allows easy service addition. See Adding Services.</p>"},{"location":"deployment/bare-metal/#hardware-upgrades","title":"Hardware Upgrades","text":"<p>Easy upgrades: - Add RAM (shut down, install, boot) - Add storage (mount, update DATA_DIR) - Network upgrade (replace card)</p> <p>Complex upgrades: - CPU/Motherboard (requires OS reinstall or careful migration)</p>"},{"location":"deployment/bare-metal/#see-also","title":"See Also","text":"<ul> <li>Installation Guide</li> <li>VM Deployment</li> <li>Proxmox LXC</li> <li>Performance Tuning</li> </ul>"},{"location":"deployment/cloud-enterprise/","title":"Cloud Enterprise Deployment","text":"<p>Deploy Omakase on enterprise cloud platforms with Kubernetes for production-grade infrastructure.</p>"},{"location":"deployment/cloud-enterprise/#overview","title":"Overview","text":"<p>Enterprise cloud deployment provides scalable, highly-available infrastructure using managed Kubernetes services.</p> <p>Advantages: - High availability - Auto-scaling - Multi-region deployment - Enterprise SLA - Managed services - Professional support</p> <p>Disadvantages: - Higher complexity - Significantly higher cost - Requires Kubernetes knowledge - Overkill for personal homelab</p> <p>Note: This deployment method is for organizations needing production-grade infrastructure, not typical homelab users.</p>"},{"location":"deployment/cloud-enterprise/#when-to-use","title":"When to Use","text":"<p>Consider enterprise deployment when: - Multiple users/teams - Business-critical services - Compliance requirements (SOC2, HIPAA, etc.) - Need for 99.9%+ uptime - Multi-region requirements - Large scale (100+ users)</p>"},{"location":"deployment/cloud-enterprise/#cloud-providers","title":"Cloud Providers","text":""},{"location":"deployment/cloud-enterprise/#amazon-eks-aws","title":"Amazon EKS (AWS)","text":"<p>Advantages: - Mature ecosystem - Wide service catalog - Global presence</p> <p>Cost: ~$300-500/month (small cluster)</p>"},{"location":"deployment/cloud-enterprise/#google-gke-gcp","title":"Google GKE (GCP)","text":"<p>Advantages: - Best Kubernetes experience - Excellent networking - Autopilot mode</p> <p>Cost: ~$250-400/month (small cluster)</p>"},{"location":"deployment/cloud-enterprise/#azure-aks","title":"Azure AKS","text":"<p>Advantages: - Microsoft integration - Hybrid cloud options - Enterprise features</p> <p>Cost: ~$300-450/month (small cluster)</p>"},{"location":"deployment/cloud-enterprise/#digitalocean-kubernetes","title":"DigitalOcean Kubernetes","text":"<p>Advantages: - Simplest setup - Lower cost - Good for startups</p> <p>Cost: ~$120-200/month (small cluster)</p>"},{"location":"deployment/cloud-enterprise/#architecture","title":"Architecture","text":""},{"location":"deployment/cloud-enterprise/#kubernetes-cluster","title":"Kubernetes Cluster","text":"<p>Control Plane: Managed by provider Worker Nodes: 3-5 nodes for HA</p> <p>Node specifications: - 4 vCPU, 16GB RAM per node - 100GB SSD per node - Auto-scaling enabled</p>"},{"location":"deployment/cloud-enterprise/#storage","title":"Storage","text":"<p>Persistent Volumes: - Use provider's block storage (EBS, Persistent Disk, etc.) - StorageClass with encryption - Automated backups</p> <p>Object Storage: - S3, GCS, or Azure Blob - For media and backups</p>"},{"location":"deployment/cloud-enterprise/#networking","title":"Networking","text":"<p>Load Balancer: Cloud provider load balancer Ingress Controller: Nginx Ingress or Traefik Service Mesh (optional): Istio or Linkerd</p>"},{"location":"deployment/cloud-enterprise/#conversion-to-kubernetes","title":"Conversion to Kubernetes","text":"<p>Omakase is Docker Compose-based. For Kubernetes deployment:</p>"},{"location":"deployment/cloud-enterprise/#option-1-kompose","title":"Option 1: Kompose","text":"<p>Convert Docker Compose to Kubernetes manifests:</p> <pre><code># Install kompose\ncurl -L https://github.com/kubernetes/kompose/releases/download/v1.31.2/kompose-linux-amd64 -o kompose\nchmod +x kompose\nsudo mv kompose /usr/local/bin/\n\n# Convert\ncd omakase\nkompose convert -f compose.yaml -f compose.prod.yaml\n</code></pre> <p>Manually adjust generated manifests.</p>"},{"location":"deployment/cloud-enterprise/#option-2-helm-chart","title":"Option 2: Helm Chart","text":"<p>Create Helm chart for Omakase:</p> <pre><code># Chart.yaml\napiVersion: v2\nname: omakase\nversion: 1.0.0\ndescription: Omakase Homelab Infrastructure\n\n# values.yaml\nreplicaCount: 3\n\nimage:\n  traefik:\n    repository: traefik\n    tag: v3.0\n\n  authelia:\n    repository: authelia/authelia\n    tag: latest\n\npersistence:\n  enabled: true\n  storageClass: gp3\n  size: 100Gi\n\ningress:\n  enabled: true\n  className: nginx\n  hosts:\n    - host: \"*.yourdomain.com\"\n</code></pre>"},{"location":"deployment/cloud-enterprise/#option-3-keep-docker-compose","title":"Option 3: Keep Docker Compose","text":"<p>Run Docker Compose on Kubernetes using: - Docker Compose on Kubernetes: Not recommended - Podman with Kubernetes: Alternative approach</p>"},{"location":"deployment/cloud-enterprise/#deployment-steps","title":"Deployment Steps","text":""},{"location":"deployment/cloud-enterprise/#1-create-kubernetes-cluster","title":"1. Create Kubernetes Cluster","text":"<p>AWS EKS: <pre><code>eksctl create cluster \\\n  --name omakase \\\n  --region us-east-1 \\\n  --nodegroup-name standard-workers \\\n  --node-type t3.xlarge \\\n  --nodes 3 \\\n  --nodes-min 3 \\\n  --nodes-max 10 \\\n  --managed\n</code></pre></p> <p>GKE: <pre><code>gcloud container clusters create omakase \\\n  --zone us-central1-a \\\n  --num-nodes 3 \\\n  --machine-type n1-standard-4 \\\n  --enable-autoscaling \\\n  --min-nodes 3 \\\n  --max-nodes 10\n</code></pre></p> <p>AKS: <pre><code>az aks create \\\n  --resource-group omakase-rg \\\n  --name omakase \\\n  --node-count 3 \\\n  --node-vm-size Standard_D4s_v3 \\\n  --enable-cluster-autoscaler \\\n  --min-count 3 \\\n  --max-count 10\n</code></pre></p>"},{"location":"deployment/cloud-enterprise/#2-install-ingress-controller","title":"2. Install Ingress Controller","text":"<p>Nginx Ingress: <pre><code>helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx\nhelm install ingress-nginx ingress-nginx/ingress-nginx \\\n  --set controller.service.type=LoadBalancer\n</code></pre></p>"},{"location":"deployment/cloud-enterprise/#3-install-cert-manager","title":"3. Install Cert-Manager","text":"<p>For automatic SSL certificates: <pre><code>helm repo add jetstack https://charts.jetstack.io\nhelm install cert-manager jetstack/cert-manager \\\n  --namespace cert-manager \\\n  --create-namespace \\\n  --set installCRDs=true\n</code></pre></p>"},{"location":"deployment/cloud-enterprise/#4-deploy-services","title":"4. Deploy Services","text":"<p>Apply Kubernetes manifests: <pre><code>kubectl create namespace omakase\nkubectl apply -f k8s/traefik/\nkubectl apply -f k8s/authelia/\nkubectl apply -f k8s/services/\n</code></pre></p>"},{"location":"deployment/cloud-enterprise/#5-configure-dns","title":"5. Configure DNS","text":"<p>Point domain to LoadBalancer IP: <pre><code>kubectl get service ingress-nginx-controller -o wide\n</code></pre></p> <p>Update DNS A records to LoadBalancer IP.</p>"},{"location":"deployment/cloud-enterprise/#high-availability","title":"High Availability","text":""},{"location":"deployment/cloud-enterprise/#pod-replication","title":"Pod Replication","text":"<pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: traefik\nspec:\n  replicas: 3  # Multiple replicas\n  selector:\n    matchLabels:\n      app: traefik\n</code></pre>"},{"location":"deployment/cloud-enterprise/#pod-disruption-budget","title":"Pod Disruption Budget","text":"<pre><code>apiVersion: policy/v1\nkind: PodDisruptionBudget\nmetadata:\n  name: traefik-pdb\nspec:\n  minAvailable: 2\n  selector:\n    matchLabels:\n      app: traefik\n</code></pre>"},{"location":"deployment/cloud-enterprise/#multi-az-deployment","title":"Multi-AZ Deployment","text":"<p>Ensure nodes span multiple availability zones.</p>"},{"location":"deployment/cloud-enterprise/#database-ha","title":"Database HA","text":"<p>Use managed database services: - AWS RDS - Google Cloud SQL - Azure Database</p> <p>With multi-AZ deployment and read replicas.</p>"},{"location":"deployment/cloud-enterprise/#storage_1","title":"Storage","text":""},{"location":"deployment/cloud-enterprise/#statefulsets","title":"StatefulSets","text":"<p>For services needing persistent storage:</p> <pre><code>apiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: nextcloud\nspec:\n  serviceName: nextcloud\n  replicas: 1\n  volumeClaimTemplates:\n    - metadata:\n        name: data\n      spec:\n        accessModes: [\"ReadWriteOnce\"]\n        storageClassName: gp3\n        resources:\n          requests:\n            storage: 100Gi\n</code></pre>"},{"location":"deployment/cloud-enterprise/#storage-classes","title":"Storage Classes","text":"<p>Define storage classes:</p> <pre><code>apiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\n  name: fast-ssd\nprovisioner: kubernetes.io/aws-ebs\nparameters:\n  type: gp3\n  iops: \"3000\"\n  throughput: \"125\"\n  encrypted: \"true\"\n</code></pre>"},{"location":"deployment/cloud-enterprise/#secrets-management","title":"Secrets Management","text":""},{"location":"deployment/cloud-enterprise/#external-secrets-operator","title":"External Secrets Operator","text":"<p>Integrate with cloud secret managers:</p> <pre><code>apiVersion: external-secrets.io/v1beta1\nkind: SecretStore\nmetadata:\n  name: aws-secrets-manager\nspec:\n  provider:\n    aws:\n      service: SecretsManager\n      region: us-east-1\n</code></pre>"},{"location":"deployment/cloud-enterprise/#sealed-secrets","title":"Sealed Secrets","text":"<p>Encrypt secrets in git:</p> <pre><code>kubeseal --format=yaml &lt; secret.yaml &gt; sealed-secret.yaml\nkubectl apply -f sealed-secret.yaml\n</code></pre>"},{"location":"deployment/cloud-enterprise/#monitoring","title":"Monitoring","text":""},{"location":"deployment/cloud-enterprise/#prometheus-grafana","title":"Prometheus + Grafana","text":"<pre><code>helm repo add prometheus-community https://prometheus-community.github.io/helm-charts\nhelm install prometheus prometheus-community/kube-prometheus-stack \\\n  --namespace monitoring \\\n  --create-namespace\n</code></pre>"},{"location":"deployment/cloud-enterprise/#cloud-provider-monitoring","title":"Cloud Provider Monitoring","text":"<p>Use native monitoring: - AWS CloudWatch - Google Cloud Monitoring - Azure Monitor</p>"},{"location":"deployment/cloud-enterprise/#cost-management","title":"Cost Management","text":""},{"location":"deployment/cloud-enterprise/#auto-scaling","title":"Auto-Scaling","text":"<p>Horizontal Pod Autoscaler: <pre><code>apiVersion: autoscaling/v2\nkind: HorizontalPodAutoscaler\nmetadata:\n  name: traefik-hpa\nspec:\n  scaleTargetRef:\n    apiVersion: apps/v1\n    kind: Deployment\n    name: traefik\n  minReplicas: 2\n  maxReplicas: 10\n  metrics:\n    - type: Resource\n      resource:\n        name: cpu\n        target:\n          type: Utilization\n          averageUtilization: 70\n</code></pre></p> <p>Cluster Autoscaler: Automatically adjust node count.</p>"},{"location":"deployment/cloud-enterprise/#spot-instances","title":"Spot Instances","text":"<p>Use spot/preemptible instances for non-critical workloads: - Save 60-90% on compute costs - Acceptable for stateless services</p>"},{"location":"deployment/cloud-enterprise/#resource-limits","title":"Resource Limits","text":"<p>Set resource requests/limits:</p> <pre><code>resources:\n  requests:\n    cpu: 100m\n    memory: 128Mi\n  limits:\n    cpu: 500m\n    memory: 512Mi\n</code></pre>"},{"location":"deployment/cloud-enterprise/#cost-monitoring","title":"Cost Monitoring","text":"<ul> <li>Enable cloud cost explorer</li> <li>Set budget alerts</li> <li>Use tools like Kubecost</li> </ul>"},{"location":"deployment/cloud-enterprise/#security","title":"Security","text":""},{"location":"deployment/cloud-enterprise/#network-policies","title":"Network Policies","text":"<p>Restrict pod-to-pod communication:</p> <pre><code>apiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: deny-all-ingress\nspec:\n  podSelector: {}\n  policyTypes:\n    - Ingress\n</code></pre>"},{"location":"deployment/cloud-enterprise/#pod-security-standards","title":"Pod Security Standards","text":"<p>Enforce security policies:</p> <pre><code>apiVersion: policy/v1beta1\nkind: PodSecurityPolicy\nmetadata:\n  name: restricted\nspec:\n  privileged: false\n  allowPrivilegeEscalation: false\n  runAsUser:\n    rule: MustRunAsNonRoot\n</code></pre>"},{"location":"deployment/cloud-enterprise/#rbac","title":"RBAC","text":"<p>Implement role-based access control.</p>"},{"location":"deployment/cloud-enterprise/#image-scanning","title":"Image Scanning","text":"<p>Use tools like: - Trivy - Snyk - Aqua Security</p>"},{"location":"deployment/cloud-enterprise/#disaster-recovery","title":"Disaster Recovery","text":""},{"location":"deployment/cloud-enterprise/#backup","title":"Backup","text":"<p>Velero: Kubernetes backup tool</p> <pre><code>velero install \\\n  --provider aws \\\n  --plugins velero/velero-plugin-for-aws:v1.8.0 \\\n  --bucket omakase-backups \\\n  --backup-location-config region=us-east-1\n\n# Create backup\nvelero backup create omakase-backup\n</code></pre>"},{"location":"deployment/cloud-enterprise/#multi-region","title":"Multi-Region","text":"<p>Deploy to multiple regions for DR: - Active-passive: Standby cluster in another region - Active-active: Both regions serve traffic</p>"},{"location":"deployment/cloud-enterprise/#cicd","title":"CI/CD","text":""},{"location":"deployment/cloud-enterprise/#gitops-with-argocd","title":"GitOps with ArgoCD","text":"<pre><code>kubectl create namespace argocd\nkubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml\n</code></pre> <p>Configure ArgoCD to sync from git repository.</p>"},{"location":"deployment/cloud-enterprise/#automated-deployments","title":"Automated Deployments","text":"<p>Use GitHub Actions or GitLab CI:</p> <pre><code>name: Deploy to EKS\non:\n  push:\n    branches: [main]\njobs:\n  deploy:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v3\n      - uses: aws-actions/configure-aws-credentials@v2\n      - run: kubectl apply -f k8s/\n</code></pre>"},{"location":"deployment/cloud-enterprise/#estimated-costs","title":"Estimated Costs","text":""},{"location":"deployment/cloud-enterprise/#small-deployment","title":"Small Deployment","text":"<ul> <li>Cluster: $150-200/month</li> <li>Compute: 3 nodes \u00d7 $50 = $150/month</li> <li>Storage: 500GB \u00d7 $0.10 = $50/month</li> <li>Load Balancer: $20/month</li> <li>Transfer: $20-50/month</li> </ul> <p>Total: ~$390-470/month</p>"},{"location":"deployment/cloud-enterprise/#medium-deployment","title":"Medium Deployment","text":"<ul> <li>Cluster: $150-200/month</li> <li>Compute: 5 nodes \u00d7 $100 = $500/month</li> <li>Storage: 2TB \u00d7 $0.10 = $200/month</li> <li>Load Balancer: $40/month</li> <li>Transfer: $100-200/month</li> </ul> <p>Total: ~$990-1240/month</p>"},{"location":"deployment/cloud-enterprise/#alternatives","title":"Alternatives","text":"<p>For most homelab users, enterprise Kubernetes is overkill. Consider: - Bare Metal - Best performance - VM Deployment - Good flexibility - Cloud VPS - Simple cloud option</p>"},{"location":"deployment/cloud-enterprise/#see-also","title":"See Also","text":"<ul> <li>Cloud VPS Deployment - Simpler cloud option</li> <li>Installation Guide</li> <li>Security Best Practices</li> </ul>"},{"location":"deployment/cloud-vps/","title":"Cloud VPS Deployment","text":"<p>Deploy Omakase on cloud Virtual Private Servers for remote access and scalability.</p>"},{"location":"deployment/cloud-vps/#overview","title":"Overview","text":"<p>VPS deployment provides cloud-hosted infrastructure with public accessibility.</p> <p>Advantages: - No home internet requirements - Professional uptime/connectivity - Easy to scale - Global access - No hardware maintenance</p> <p>Disadvantages: - Monthly costs - Data transfer limits - Privacy concerns - Compliance considerations</p>"},{"location":"deployment/cloud-vps/#provider-selection","title":"Provider Selection","text":""},{"location":"deployment/cloud-vps/#recommended-providers","title":"Recommended Providers","text":"<p>Hetzner Cloud: - Excellent price/performance - European data centers - Fast networking - Snapshot support - From \u20ac4.51/month</p> <p>DigitalOcean: - Easy to use - Good documentation - Global locations - From $6/month</p> <p>Linode (Akamai): - Reliable performance - Excellent support - Good networking - From $5/month</p> <p>Vultr: - Many locations - Competitive pricing - Good performance - From $6/month</p>"},{"location":"deployment/cloud-vps/#selection-criteria","title":"Selection Criteria","text":"<p>Consider: - Price: Fits budget - Performance: Adequate CPU/RAM - Location: Close to users - Network: Bandwidth/transfer limits - Backup: Snapshot support - Support: Quality of support</p>"},{"location":"deployment/cloud-vps/#sizing","title":"Sizing","text":""},{"location":"deployment/cloud-vps/#small-deployment-5-10-services","title":"Small Deployment (5-10 services)","text":"<p>Specifications: - 4 vCPU cores - 8GB RAM - 160GB SSD - 4TB transfer</p> <p>Cost: ~$24-36/month</p> <p>Providers: - Hetzner CPX31 - DigitalOcean Basic Droplet - Linode 8GB</p>"},{"location":"deployment/cloud-vps/#medium-deployment-10-20-services","title":"Medium Deployment (10-20 services)","text":"<p>Specifications: - 8 vCPU cores - 16GB RAM - 320GB SSD - 8TB transfer</p> <p>Cost: ~$48-72/month</p> <p>Providers: - Hetzner CPX41 - DigitalOcean CPU-Optimized - Linode 16GB</p>"},{"location":"deployment/cloud-vps/#large-deployment-20-services","title":"Large Deployment (20+ services)","text":"<p>Specifications: - 16 vCPU cores - 32GB RAM - 640GB SSD - 16TB transfer</p> <p>Cost: ~$96-144/month</p> <p>Providers: - Hetzner CPX51 - DigitalOcean CPU-Optimized - Linode 32GB</p>"},{"location":"deployment/cloud-vps/#initial-setup","title":"Initial Setup","text":""},{"location":"deployment/cloud-vps/#1-create-vps","title":"1. Create VPS","text":"<p>Hetzner example: 1. Sign up at https://hetzner.cloud 2. Create project 3. Add server:    - Location: Nuremberg    - Image: Ubuntu 24.04    - Type: CPX31    - Volume: Optional additional storage 4. Add SSH key 5. Create server</p>"},{"location":"deployment/cloud-vps/#2-initial-access","title":"2. Initial Access","text":"<pre><code>ssh root@server-ip\n</code></pre>"},{"location":"deployment/cloud-vps/#3-basic-security","title":"3. Basic Security","text":"<pre><code># Update system\napt update &amp;&amp; apt upgrade -y\n\n# Create user\nadduser omakase\nusermod -aG sudo omakase\n\n# Configure SSH\nsed -i 's/PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config\nsed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config\nsystemctl restart sshd\n\n# Set up firewall\nufw default deny incoming\nufw default allow outgoing\nufw allow 22/tcp\nufw allow 80/tcp\nufw allow 443/tcp\nufw enable\n\n# Install fail2ban\napt install fail2ban -y\n</code></pre>"},{"location":"deployment/cloud-vps/#4-install-docker","title":"4. Install Docker","text":"<pre><code># Install Docker\ncurl -fsSL https://get.docker.com | sh\nusermod -aG docker omakase\n\n# Install Docker Compose\napt install docker-compose-plugin -y\n\n# Install Infisical\ncurl -1sLf 'https://dl.cloudsmith.io/public/infisical/infisical-cli/setup.deb.sh' | sudo -E bash\napt-get update &amp;&amp; apt-get install -y infisical\n</code></pre>"},{"location":"deployment/cloud-vps/#5-configure-storage","title":"5. Configure Storage","text":"<pre><code># Optional: Attach block storage volume\n# Format and mount\nmkfs.ext4 /dev/sdb\nmkdir -p /mnt/storage\necho \"/dev/sdb /mnt/storage ext4 defaults,noatime 0 2\" &gt;&gt; /etc/fstab\nmount -a\n\n# Set ownership\nchown -R omakase:omakase /mnt/storage\n</code></pre>"},{"location":"deployment/cloud-vps/#deploy-omakase","title":"Deploy Omakase","text":"<pre><code># Switch to user\nsu - omakase\n\n# Clone repository\ngit clone https://github.com/yourusername/omakase.git\ncd omakase\n\n# Configure environment\nexport DATA_DIR=/mnt/storage/omakase  # Or /home/omakase/omakase-data\nexport DOMAINNAME=yourdomain.com\nexport PUID=$(id -u)\nexport PGID=$(id -g)\n\n# Configure Infisical\ninfisical login\n\n# Deploy\nmake up\n</code></pre>"},{"location":"deployment/cloud-vps/#dns-configuration","title":"DNS Configuration","text":""},{"location":"deployment/cloud-vps/#domain-setup","title":"Domain Setup","text":"<p>Point domain to VPS:</p> <pre><code>A     @              server-ip\nA     *              server-ip\nAAAA  @              server-ipv6  # If available\nAAAA  *              server-ipv6\n</code></pre> <p>Propagation takes 1-24 hours.</p>"},{"location":"deployment/cloud-vps/#cloudflare-recommended","title":"Cloudflare (Recommended)","text":"<p>Benefits: - DDoS protection - CDN - Free SSL - Analytics</p> <p>Setup: 1. Add domain to Cloudflare 2. Update nameservers at registrar 3. Add DNS records 4. Enable proxy (orange cloud)</p> <p>Caution: Cloudflare proxy incompatible with HTTP challenge for Let's Encrypt. Use DNS challenge instead.</p>"},{"location":"deployment/cloud-vps/#ssl-certificates","title":"SSL Certificates","text":""},{"location":"deployment/cloud-vps/#lets-encrypt-http-challenge","title":"Let's Encrypt HTTP Challenge","text":"<p>Default configuration works if ports 80/443 accessible.</p>"},{"location":"deployment/cloud-vps/#dns-challenge-for-cloudflare-proxy","title":"DNS Challenge (for Cloudflare proxy)","text":"<p>Update Traefik configuration:</p> <pre><code>certificatesResolvers:\n  letsencrypt:\n    acme:\n      email: ${ACME_EMAIL}\n      storage: /letsencrypt/acme.json\n      dnsChallenge:\n        provider: cloudflare\n        resolvers:\n          - \"1.1.1.1:53\"\n\nenvironment:\n  CF_API_EMAIL: ${CLOUDFLARE_EMAIL}\n  CF_API_KEY: ${CLOUDFLARE_API_KEY}\n</code></pre>"},{"location":"deployment/cloud-vps/#security-hardening","title":"Security Hardening","text":""},{"location":"deployment/cloud-vps/#rate-limiting","title":"Rate Limiting","text":"<p>Add Traefik middleware:</p> <pre><code>http:\n  middlewares:\n    rate-limit:\n      rateLimit:\n        average: 100\n        burst: 50\n</code></pre>"},{"location":"deployment/cloud-vps/#ip-whitelist-optional","title":"IP Whitelist (Optional)","text":"<p>Restrict admin services to your IP:</p> <pre><code>http:\n  middlewares:\n    ip-whitelist:\n      ipWhiteList:\n        sourceRange:\n          - \"your-home-ip/32\"\n</code></pre>"},{"location":"deployment/cloud-vps/#crowdsec","title":"CrowdSec","text":"<p>Ensure CrowdSec is active and enrolled in CAPI for threat intelligence.</p>"},{"location":"deployment/cloud-vps/#backup-firewall","title":"Backup Firewall","text":"<p>Use provider's cloud firewall if available: - Only allow ports 22, 80, 443 - Restrict SSH to your IP if possible</p>"},{"location":"deployment/cloud-vps/#monitoring","title":"Monitoring","text":""},{"location":"deployment/cloud-vps/#resource-usage","title":"Resource Usage","text":"<p>Monitor VPS resources: <pre><code>htop\ndocker stats\ndf -h\n</code></pre></p>"},{"location":"deployment/cloud-vps/#network-transfer","title":"Network Transfer","text":"<p>Track bandwidth usage via provider dashboard.</p>"},{"location":"deployment/cloud-vps/#costs","title":"Costs","text":"<p>Monitor spending: - Check provider billing - Watch for unexpected charges - Set billing alerts</p>"},{"location":"deployment/cloud-vps/#backups","title":"Backups","text":""},{"location":"deployment/cloud-vps/#vps-snapshots","title":"VPS Snapshots","text":"<p>Use provider snapshots: - Hetzner: Enable backup (20% additional cost) - DigitalOcean: Enable automatic backups - Linode: Enable backups</p>"},{"location":"deployment/cloud-vps/#omakase-backups","title":"Omakase Backups","text":"<p>Use built-in Restic backup to Backblaze B2 or similar.</p>"},{"location":"deployment/cloud-vps/#configuration-backup","title":"Configuration Backup","text":"<p>Backup Omakase configuration: <pre><code>cd ~/omakase\ntar czf omakase-config-$(date +%Y%m%d).tar.gz compose* .env\n</code></pre></p> <p>Store off-server.</p>"},{"location":"deployment/cloud-vps/#disaster-recovery","title":"Disaster Recovery","text":""},{"location":"deployment/cloud-vps/#vps-failure","title":"VPS Failure","text":"<ol> <li>Create new VPS from snapshot</li> <li>Update DNS A records</li> <li>Verify services</li> </ol>"},{"location":"deployment/cloud-vps/#data-corruption","title":"Data Corruption","text":"<ol> <li>Restore from Restic backup</li> <li>Restore from VPS snapshot</li> <li>Deploy services</li> </ol>"},{"location":"deployment/cloud-vps/#cost-optimization","title":"Cost Optimization","text":""},{"location":"deployment/cloud-vps/#right-sizing","title":"Right-Sizing","text":"<p>Monitor resource usage: - Downsize if underutilized - Upgrade if constrained</p>"},{"location":"deployment/cloud-vps/#storage","title":"Storage","text":"<p>Use object storage for backups instead of expensive block storage: - Backblaze B2 - Wasabi - Provider object storage</p>"},{"location":"deployment/cloud-vps/#network-transfer_1","title":"Network Transfer","text":"<p>Optimize to stay within limits: - Compress responses - Cache content - Limit media streaming</p>"},{"location":"deployment/cloud-vps/#scaling","title":"Scaling","text":""},{"location":"deployment/cloud-vps/#vertical-scaling","title":"Vertical Scaling","text":"<p>Upgrade VPS: 1. Shutdown services 2. Resize VPS (via provider dashboard) 3. Restart services</p> <p>Usually zero downtime.</p>"},{"location":"deployment/cloud-vps/#horizontal-scaling","title":"Horizontal Scaling","text":"<p>Add additional VPS for specific services: - Media server on separate VPS - Database on dedicated instance</p>"},{"location":"deployment/cloud-vps/#load-balancing","title":"Load Balancing","text":"<p>Use provider load balancer or Cloudflare for distribution.</p>"},{"location":"deployment/cloud-vps/#provider-specific-notes","title":"Provider-Specific Notes","text":""},{"location":"deployment/cloud-vps/#hetzner-cloud","title":"Hetzner Cloud","text":"<p>Volumes: Attach additional storage via Cloud Volumes Snapshots: Manual snapshots, no automatic backups IPv6: Free IPv6 address included Network: Very fast (up to 20 Gbps)</p>"},{"location":"deployment/cloud-vps/#digitalocean","title":"DigitalOcean","text":"<p>Spaces: Object storage for backups Monitoring: Built-in metrics Firewall: Cloud Firewalls available 1-Click Apps: Can use Docker droplet</p>"},{"location":"deployment/cloud-vps/#linode","title":"Linode","text":"<p>Volumes: Block storage available NodeBalancer: Load balancer option Backups: Automatic backup service Longview: Free monitoring</p>"},{"location":"deployment/cloud-vps/#compliance","title":"Compliance","text":""},{"location":"deployment/cloud-vps/#data-privacy","title":"Data Privacy","text":"<p>Consider: - GDPR (EU users) - Data residency requirements - Provider's privacy policy</p>"},{"location":"deployment/cloud-vps/#data-location","title":"Data Location","text":"<p>Choose server location based on: - User location - Legal requirements - Performance needs</p>"},{"location":"deployment/cloud-vps/#troubleshooting","title":"Troubleshooting","text":""},{"location":"deployment/cloud-vps/#high-network-usage","title":"High Network Usage","text":"<p>Check logs: <pre><code>docker compose logs | grep -i \"status\": \"5\"\n</code></pre></p> <p>Identify bandwidth-heavy service.</p>"},{"location":"deployment/cloud-vps/#vps-performance","title":"VPS Performance","text":"<p>Check: - CPU steal time (hypervisor overhead) - Disk I/O performance - Network latency</p> <p>Consider upgrading or changing provider.</p>"},{"location":"deployment/cloud-vps/#ssh-connection-issues","title":"SSH Connection Issues","text":"<pre><code># Check from another terminal\nssh -v root@server-ip\n\n# Check fail2ban\nfail2ban-client status sshd\n</code></pre>"},{"location":"deployment/cloud-vps/#migration","title":"Migration","text":""},{"location":"deployment/cloud-vps/#between-providers","title":"Between Providers","text":"<ol> <li>Deploy new VPS</li> <li>Set up Omakase</li> <li>Restore data from backup</li> <li>Update DNS</li> <li>Test thoroughly</li> <li>Destroy old VPS</li> </ol>"},{"location":"deployment/cloud-vps/#from-home-to-cloud","title":"From Home to Cloud","text":"<ol> <li>Backup home installation</li> <li>Deploy to VPS</li> <li>Restore backup</li> <li>Update DNS</li> <li>Test access</li> </ol>"},{"location":"deployment/cloud-vps/#best-practices","title":"Best Practices","text":"<ol> <li>Enable automatic backups - Worth the cost</li> <li>Use cloud firewall - Additional security layer</li> <li>Monitor costs - Set billing alerts</li> <li>Regular snapshots - Before major changes</li> <li>Keep DNS TTL low - Easier migration</li> <li>Document IP addresses - For firewall rules</li> <li>Use object storage - For large backups</li> <li>Monitor bandwidth - Avoid overage charges</li> </ol>"},{"location":"deployment/cloud-vps/#see-also","title":"See Also","text":"<ul> <li>Installation Guide</li> <li>Security Best Practices</li> <li>Backup Configuration</li> </ul>"},{"location":"deployment/nas/","title":"NAS Deployment","text":"<p>Deploy Omakase on Network Attached Storage (NAS) devices.</p>"},{"location":"deployment/nas/#overview","title":"Overview","text":"<p>Many NAS devices support Docker, making them suitable for Omakase deployment.</p> <p>Advantages: - Utilize existing hardware - Integrated storage management - Lower power consumption - Often includes backup features</p> <p>Disadvantages: - Limited CPU/RAM - Proprietary OS customizations - May require workarounds - Limited community support for some platforms</p>"},{"location":"deployment/nas/#supported-nas-platforms","title":"Supported NAS Platforms","text":""},{"location":"deployment/nas/#synology-dsm","title":"Synology DSM","text":"<p>Models: DS920+, DS1821+, DS923+, etc.</p> <p>Requirements: - DSM 7.0+ - Intel CPU (avoid ARM models) - 4GB+ RAM (8GB+ recommended) - Docker package from Package Center</p>"},{"location":"deployment/nas/#qnap-qts","title":"QNAP QTS","text":"<p>Models: TS-464, TVS-h674, TS-873A, etc.</p> <p>Requirements: - QTS 5.0+ - Intel/AMD CPU - 4GB+ RAM - Container Station</p>"},{"location":"deployment/nas/#truenas-scale","title":"TrueNAS Scale","text":"<p>Best option - Full Linux with native Docker support.</p> <p>Requirements: - TrueNAS Scale 22.12+ - Any compatible hardware - 8GB+ RAM</p>"},{"location":"deployment/nas/#unraid","title":"Unraid","text":"<p>Advantages: Excellent Docker support, flexible storage.</p> <p>Requirements: - Unraid 6.10+ - 8GB+ RAM - Compatible hardware</p>"},{"location":"deployment/nas/#synology-deployment","title":"Synology Deployment","text":""},{"location":"deployment/nas/#prerequisites","title":"Prerequisites","text":"<ol> <li>Install Docker:</li> <li>Open Package Center</li> <li>Search for \"Docker\"</li> <li> <p>Click Install</p> </li> <li> <p>Enable SSH:</p> </li> <li>Control Panel \u2192 Terminal &amp; SNMP</li> <li> <p>Enable SSH service</p> </li> <li> <p>Create shared folder:</p> </li> <li>Control Panel \u2192 Shared Folder</li> <li>Create \"omakase\" folder</li> </ol>"},{"location":"deployment/nas/#installation","title":"Installation","text":"<p>SSH into Synology: <pre><code>ssh admin@nas-ip\nsudo -i\n</code></pre></p> <p>Install Docker Compose: <pre><code># Download docker-compose\ncurl -SL https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64 -o /usr/local/bin/docker-compose\n\n# Make executable\nchmod +x /usr/local/bin/docker-compose\n\n# Verify\ndocker-compose --version\n</code></pre></p> <p>Clone and deploy: <pre><code>cd /volume1/omakase\ngit clone https://github.com/yourusername/omakase.git\ncd omakase\n\n# Configure environment\nexport DATA_DIR=/volume1/omakase/data\nexport DOMAINNAME=yourdomain.com\n\n# Deploy\nmake up\n</code></pre></p>"},{"location":"deployment/nas/#synology-specific-configuration","title":"Synology-Specific Configuration","text":"<p>Port conflicts: Synology uses ports 80/443:</p> <pre><code># compose.yaml\nservices:\n  traefik:\n    ports:\n      - \"8080:80\"\n      - \"8443:443\"\n</code></pre> <p>Access services at <code>https://nas-ip:8443</code></p> <p>Permissions: <pre><code>chown -R admin:users /volume1/omakase\n</code></pre></p>"},{"location":"deployment/nas/#qnap-deployment","title":"QNAP Deployment","text":""},{"location":"deployment/nas/#prerequisites_1","title":"Prerequisites","text":"<ol> <li>Install Container Station:</li> <li>App Center \u2192 Container Station</li> <li> <p>Install</p> </li> <li> <p>Enable SSH:</p> </li> <li>Control Panel \u2192 Telnet/SSH</li> <li>Enable SSH</li> </ol>"},{"location":"deployment/nas/#installation_1","title":"Installation","text":"<p>SSH into QNAP: <pre><code>ssh admin@qnap-ip\n\n# Navigate to share\ncd /share/Container/omakase\n\n# Clone repository\ngit clone https://github.com/yourusername/omakase.git\ncd omakase\n\n# Deploy\nDATA_DIR=/share/Container/omakase/data make up\n</code></pre></p>"},{"location":"deployment/nas/#qnap-considerations","title":"QNAP Considerations","text":"<ul> <li>Use <code>/share/Container/</code> for Docker data</li> <li>Container Station provides GUI management</li> <li>May need to adjust resource limits</li> </ul>"},{"location":"deployment/nas/#truenas-scale-deployment","title":"TrueNAS Scale Deployment","text":""},{"location":"deployment/nas/#prerequisites_2","title":"Prerequisites","text":"<p>TrueNAS Scale has native Docker support via K3s.</p>"},{"location":"deployment/nas/#installation_2","title":"Installation","text":"<p>Option 1: TrueNAS Apps (Recommended): - Use TrueCharts catalog - Deploy services via GUI</p> <p>Option 2: Custom Docker Compose:</p> <pre><code># SSH into TrueNAS\nssh admin@truenas-ip\n\n# Install docker-compose\nsudo apt install docker-compose\n\n# Deploy Omakase\ncd /mnt/pool/omakase\ngit clone https://github.com/yourusername/omakase.git\ncd omakase\nmake up\n</code></pre>"},{"location":"deployment/nas/#truenas-benefits","title":"TrueNAS Benefits","text":"<ul> <li>Native ZFS support</li> <li>Built-in snapshots</li> <li>Excellent backup options</li> <li>Full Linux environment</li> </ul>"},{"location":"deployment/nas/#unraid-deployment","title":"Unraid Deployment","text":""},{"location":"deployment/nas/#prerequisites_3","title":"Prerequisites","text":"<ol> <li>Enable Docker:</li> <li>Settings \u2192 Docker</li> <li>Enable Docker</li> <li> <p>Set Docker directory</p> </li> <li> <p>Install Community Applications:</p> </li> <li>Plugins \u2192 Install \"Community Applications\"</li> </ol>"},{"location":"deployment/nas/#installation_3","title":"Installation","text":"<p>Option 1: Docker Compose Manager: 1. Install \"Docker Compose Manager\" plugin 2. Create new stack 3. Paste compose.yaml 4. Deploy</p> <p>Option 2: SSH: <pre><code>ssh root@unraid-ip\n\ncd /mnt/user/appdata/omakase\ngit clone https://github.com/yourusername/omakase.git\ncd omakase\ndocker-compose up -d\n</code></pre></p>"},{"location":"deployment/nas/#unraid-benefits","title":"Unraid Benefits","text":"<ul> <li>Excellent Docker integration</li> <li>Community Applications</li> <li>Flexible storage</li> <li>Active community</li> </ul>"},{"location":"deployment/nas/#common-nas-challenges","title":"Common NAS Challenges","text":""},{"location":"deployment/nas/#limited-resources","title":"Limited Resources","text":"<p>Optimize for NAS:</p> <pre><code># Reduce resource limits\ndeploy:\n  resources:\n    limits:\n      memory: 512M  # Instead of 2G\n</code></pre> <p>Disable resource-heavy services.</p>"},{"location":"deployment/nas/#port-conflicts","title":"Port Conflicts","text":"<p>NAS often uses standard ports. Options:</p> <ol> <li>Change NAS ports</li> <li>Change Omakase ports:    <pre><code>ports:\n  - \"8080:80\"\n  - \"8443:443\"\n</code></pre></li> <li>Use reverse proxy on different ports</li> </ol>"},{"location":"deployment/nas/#storage-paths","title":"Storage Paths","text":"<p>Each NAS has different paths: - Synology: <code>/volume1/</code> - QNAP: <code>/share/Container/</code> - TrueNAS: <code>/mnt/pool/</code> - Unraid: <code>/mnt/user/appdata/</code></p> <p>Set <code>DATA_DIR</code> accordingly.</p>"},{"location":"deployment/nas/#persistence-after-reboot","title":"Persistence After Reboot","text":"<p>Ensure services start automatically:</p> <p>Synology: Create scheduled task in Task Scheduler: <pre><code>cd /volume1/omakase/omakase &amp;&amp; /usr/local/bin/docker-compose up -d\n</code></pre></p> <p>QNAP: Use Container Station autostart feature.</p> <p>TrueNAS/Unraid: Create system startup script.</p>"},{"location":"deployment/nas/#performance-considerations","title":"Performance Considerations","text":""},{"location":"deployment/nas/#cpu-limitations","title":"CPU Limitations","text":"<p>NAS CPUs often less powerful: - Disable CPU-intensive services (transcoding, ML) - Use hardware transcoding if supported - Limit concurrent services</p>"},{"location":"deployment/nas/#memory-constraints","title":"Memory Constraints","text":"<p>Monitor memory usage: <pre><code>docker stats --no-stream\n</code></pre></p> <p>Adjust limits as needed.</p>"},{"location":"deployment/nas/#network-performance","title":"Network Performance","text":"<ul> <li>Use wired connection</li> <li>Enable jumbo frames if supported</li> <li>Monitor network saturation</li> </ul>"},{"location":"deployment/nas/#nas-specific-features","title":"NAS-Specific Features","text":""},{"location":"deployment/nas/#leverage-nas-capabilities","title":"Leverage NAS Capabilities","text":"<p>Synology: - Hyper Backup for VM/container backup - Snapshot Replication - Active Backup for Business</p> <p>QNAP: - QNAP NetBak Replicator - Hybrid Backup Sync - Snapshot feature</p> <p>TrueNAS: - ZFS snapshots - Replication tasks - Cloud sync</p> <p>Unraid: - CA Backup - Appdata Backup plugin - Parity protection</p>"},{"location":"deployment/nas/#backup-strategy","title":"Backup Strategy","text":""},{"location":"deployment/nas/#nas-snapshots","title":"NAS Snapshots","text":"<p>Use NAS snapshot feature for quick rollback:</p> <p>Synology: - Snapshot Replication \u2192 Create snapshot schedule</p> <p>TrueNAS: - Periodic Snapshot Tasks</p>"},{"location":"deployment/nas/#omakase-backups","title":"Omakase Backups","text":"<p>Use built-in Restic backup in addition to NAS snapshots.</p>"},{"location":"deployment/nas/#monitoring","title":"Monitoring","text":"<p>Use NAS native monitoring: - Resource Monitor (Synology/QNAP) - Reporting (TrueNAS) - Dashboard (Unraid)</p> <p>Plus Omakase's monitoring stack.</p>"},{"location":"deployment/nas/#troubleshooting","title":"Troubleshooting","text":""},{"location":"deployment/nas/#docker-wont-start","title":"Docker Won't Start","text":"<p>Check Docker service: <pre><code># Synology\nsynoservicectl --status pkgctl-Docker\n\n# Others\nsystemctl status docker\n</code></pre></p>"},{"location":"deployment/nas/#permission-denied","title":"Permission Denied","text":"<p>Fix permissions: <pre><code># Set PUID/PGID to NAS user\nexport PUID=$(id -u)\nexport PGID=$(id -g)\n</code></pre></p>"},{"location":"deployment/nas/#out-of-memory","title":"Out of Memory","text":"<p>Reduce services or add RAM to NAS.</p>"},{"location":"deployment/nas/#upgrading-nas","title":"Upgrading NAS","text":""},{"location":"deployment/nas/#before-nas-os-update","title":"Before NAS OS Update","text":"<ol> <li>Backup Omakase data</li> <li>Export docker-compose config</li> <li>Note all customizations</li> <li>Stop services</li> </ol>"},{"location":"deployment/nas/#after-update","title":"After Update","text":"<ol> <li>Verify Docker still installed</li> <li>Reinstall docker-compose if needed</li> <li>Restore services</li> <li>Test functionality</li> </ol>"},{"location":"deployment/nas/#best-practices","title":"Best Practices","text":"<ol> <li>Use NAS strengths - Snapshots, redundancy</li> <li>Monitor resources - NAS often constrained</li> <li>Regular backups - To external location</li> <li>Update carefully - Test NAS updates</li> <li>Document customizations - NAS-specific changes</li> <li>Use persistent storage - Map to NAS shares</li> <li>Enable autostart - Services survive reboots</li> </ol>"},{"location":"deployment/nas/#see-also","title":"See Also","text":"<ul> <li>Installation Guide</li> <li>Performance Tuning</li> <li>Backup Configuration</li> </ul>"},{"location":"deployment/proxmox-lxc/","title":"Proxmox LXC Container Deployment","text":"<p>This guide describes deploying Omakase in a Debian LXC container on Proxmox VE, based on a real production setup.</p>"},{"location":"deployment/proxmox-lxc/#architecture-overview","title":"Architecture Overview","text":"<pre><code>Internet\n   \u2193\nOPNsense Firewall\n   \u251c\u2500 HAProxy (Reverse Proxy)\n   \u251c\u2500 Let's Encrypt (SSL Certificates)\n   \u2514\u2500 VPN (Optional: Wireguard/OpenVPN)\n   \u2193\nProxmox VE Host\n   \u251c\u2500 LXC: Infisical (Secrets Management)\n   \u2514\u2500 LXC: Omakase (Docker Stack)\n          \u251c\u2500 Traefik (Internal Routing)\n          \u2514\u2500 25+ Services\n</code></pre>"},{"location":"deployment/proxmox-lxc/#advantages-of-this-setup","title":"Advantages of This Setup","text":"<ul> <li>Isolation: LXC containers with minimal overhead vs full VMs</li> <li>Security: Firewall handles SSL and external access, Omakase isolated internally</li> <li>Scalability: Resources dynamically allocated by Proxmox</li> <li>Backup: LXC snapshots + Restic for application data</li> <li>Performance: Near bare-metal, efficient kernel sharing</li> </ul>"},{"location":"deployment/proxmox-lxc/#hardware-requirements","title":"Hardware Requirements","text":""},{"location":"deployment/proxmox-lxc/#production-configuration-tested","title":"Production Configuration (Tested)","text":"<ul> <li>CPU: 8+ cores allocated to LXC</li> <li>RAM: 16GB+ allocated to LXC</li> <li>Storage: 500GB+ for Omakase LXC</li> <li>System: 50GB</li> <li>Docker volumes: 450GB+</li> <li>Network: 1Gbps NIC</li> </ul>"},{"location":"deployment/proxmox-lxc/#minimum-configuration-basic-homelab","title":"Minimum Configuration (Basic Homelab)","text":"<ul> <li>CPU: 4 cores</li> <li>RAM: 8GB</li> <li>Storage: 200GB</li> <li>System: 30GB</li> <li>Docker volumes: 170GB</li> </ul>"},{"location":"deployment/proxmox-lxc/#proxmox-host-requirements","title":"Proxmox Host Requirements","text":"<ul> <li>Proxmox VE 8.0+</li> <li>Storage backend: LVM, ZFS, or Ceph</li> <li>Network: Configured bridge (vmbr0)</li> </ul>"},{"location":"deployment/proxmox-lxc/#software-prerequisites","title":"Software Prerequisites","text":""},{"location":"deployment/proxmox-lxc/#on-proxmox-host","title":"On Proxmox Host","text":"<pre><code># Check Proxmox version\npveversion\n\n# Expected output: pve-manager/8.x.x\n</code></pre>"},{"location":"deployment/proxmox-lxc/#firewallrouter-opnsense-or-alternative","title":"Firewall/Router (OPNsense or alternative)","text":"<ul> <li>OPNsense 24.x+ (recommended) or:</li> <li>pfSense</li> <li>Linux firewall (iptables/nftables)</li> <li>HAProxy or nginx for external reverse proxy</li> <li>Certbot or ACME client for Let's Encrypt</li> </ul>"},{"location":"deployment/proxmox-lxc/#separate-lxc-for-infisical-recommended","title":"Separate LXC for Infisical (Recommended)","text":"<ul> <li>Debian 12 LXC container</li> <li>2 CPU / 2GB RAM / 20GB storage</li> <li>Docker + Docker Compose</li> </ul>"},{"location":"deployment/proxmox-lxc/#step-1-create-lxc-container-on-proxmox","title":"Step 1: Create LXC Container on Proxmox","text":""},{"location":"deployment/proxmox-lxc/#11-download-debian-template","title":"1.1 Download Debian Template","text":"<pre><code># On Proxmox host, download Debian 12 template\npveam update\npveam download local debian-12-standard_12.2-1_amd64.tar.zst\n</code></pre>"},{"location":"deployment/proxmox-lxc/#12-create-omakase-container","title":"1.2 Create Omakase Container","text":"<p>Via Proxmox Web UI (recommended):</p> <ol> <li>Datacenter \u2192 Create CT</li> <li>General:</li> <li>Node: Select Proxmox node</li> <li>CT ID: 100 (or free ID)</li> <li>Hostname: <code>omakase</code></li> <li>Password: Set root password</li> <li>SSH public key: (Optional) Add your SSH key</li> <li> <p>Unprivileged container: \u2713 (recommended for security)</p> </li> <li> <p>Template:</p> </li> <li>Storage: local</li> <li> <p>Template: debian-12-standard</p> </li> <li> <p>Disks:</p> </li> <li>Storage: Select storage backend (local-lvm, ZFS, etc.)</li> <li> <p>Disk size: 500 GB (or according to needs)</p> </li> <li> <p>CPU:</p> </li> <li> <p>Cores: 8 (or 4 for minimum setup)</p> </li> <li> <p>Memory:</p> </li> <li>Memory: 16384 MB (16GB)</li> <li> <p>Swap: 4096 MB</p> </li> <li> <p>Network:</p> </li> <li>Bridge: vmbr0</li> <li>IPv4: Static</li> <li>IPv4/CIDR: <code>192.168.1.100/24</code> (adapt to your network)</li> <li>Gateway: <code>192.168.1.1</code> (your router/firewall)</li> <li> <p>IPv6: SLAAC (or disable if not using IPv6)</p> </li> <li> <p>DNS:</p> </li> <li>DNS domain: <code>home.arpa</code> (or your local domain)</li> <li> <p>DNS servers: <code>192.168.1.1</code> (your DNS resolver)</p> </li> <li> <p>Confirm \u2192 Finish</p> </li> </ol>"},{"location":"deployment/proxmox-lxc/#13-configure-lxc-features","title":"1.3 Configure LXC Features","text":"<p>After creation, configure features needed for Docker:</p> <pre><code># On Proxmox host\npct set 100 -features nesting=1,keyctl=1\npct set 100 -unprivileged 1\n\n# Enable FUSE for some containers (e.g. rclone)\necho \"lxc.apparmor.profile: unconfined\" &gt;&gt; /etc/pve/lxc/100.conf\necho \"lxc.cgroup2.devices.allow: c 10:229 rwm\" &gt;&gt; /etc/pve/lxc/100.conf\necho \"lxc.mount.entry: /dev/fuse dev/fuse none bind,create=file 0 0\" &gt;&gt; /etc/pve/lxc/100.conf\n</code></pre>"},{"location":"deployment/proxmox-lxc/#14-start-container","title":"1.4 Start Container","text":"<pre><code># Start container\npct start 100\n\n# Open console\npct enter 100\n</code></pre>"},{"location":"deployment/proxmox-lxc/#step-2-configure-omakase-container","title":"Step 2: Configure Omakase Container","text":""},{"location":"deployment/proxmox-lxc/#21-system-update","title":"2.1 System Update","text":"<pre><code># Inside LXC container\napt update &amp;&amp; apt upgrade -y\napt install -y curl git vim wget ca-certificates gnupg sudo\n</code></pre>"},{"location":"deployment/proxmox-lxc/#22-docker-installation","title":"2.2 Docker Installation","text":"<pre><code># Add Docker repository\ninstall -m 0755 -d /etc/apt/keyrings\ncurl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc\nchmod a+r /etc/apt/keyrings/docker.asc\n\necho \\\n  \"deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian \\\n  $(. /etc/os-release &amp;&amp; echo \"$VERSION_CODENAME\") stable\" | \\\n  tee /etc/apt/sources.list.d/docker.list &gt; /dev/null\n\n# Install Docker\napt update\napt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin\n\n# Verify installation\ndocker --version\ndocker compose version\n\n# Expected output:\n# Docker version 28.x.x\n# Docker Compose version v2.x.x\n</code></pre>"},{"location":"deployment/proxmox-lxc/#23-install-infisical-cli","title":"2.3 Install Infisical CLI","text":"<pre><code># Install Infisical CLI\ncurl -1sLf 'https://dl.cloudsmith.io/public/infisical/infisical-cli/setup.deb.sh' | bash\napt update\napt install -y infisical\n\n# Verify installation\ninfisical --version\n\n# Expected output: infisical version 0.42.x\n</code></pre>"},{"location":"deployment/proxmox-lxc/#24-user-configuration","title":"2.4 User Configuration","text":"<pre><code># Create dedicated user (optional but recommended)\nuseradd -m -s /bin/bash -G docker omakase\npasswd omakase\n\n# Add SSH key (if configured)\nsudo -u omakase mkdir -p /home/omakase/.ssh\nsudo -u omakase chmod 700 /home/omakase/.ssh\n# Copy your public key to /home/omakase/.ssh/authorized_keys\n</code></pre>"},{"location":"deployment/proxmox-lxc/#step-3-self-hosted-infisical-setup","title":"Step 3: Self-Hosted Infisical Setup","text":""},{"location":"deployment/proxmox-lxc/#31-create-infisical-lxc","title":"3.1 Create Infisical LXC","text":"<p>Follow the same steps as Step 1 to create a second LXC with:</p> <ul> <li>CT ID: 101</li> <li>Hostname: <code>infisical</code></li> <li>CPU: 2 cores</li> <li>RAM: 2048 MB</li> <li>Storage: 20 GB</li> <li>IP: <code>192.168.1.101/24</code></li> </ul> <p>Install Docker the same way (Step 2.2).</p>"},{"location":"deployment/proxmox-lxc/#32-deploy-infisical","title":"3.2 Deploy Infisical","text":"<pre><code># In Infisical container (CT 101)\nmkdir -p /opt/infisical\ncd /opt/infisical\n\n# Download Infisical docker-compose.yml\ncurl -o docker-compose.yml https://raw.githubusercontent.com/Infisical/infisical/main/docker-compose.prod.yml\n\n# Generate encryption keys\ncat &gt; .env &lt;&lt;EOF\n# Infisical Configuration\nENCRYPTION_KEY=$(openssl rand -hex 32)\nJWT_SECRET=$(openssl rand -hex 32)\nMONGO_URL=mongodb://mongo:27017/infisical\n\n# Frontend URL (adapt to your domain)\nSITE_URL=https://infisical.home.arpa\nEOF\n\n# Start Infisical\ndocker compose up -d\n\n# Verify status\ndocker compose ps\n</code></pre>"},{"location":"deployment/proxmox-lxc/#33-initial-infisical-configuration","title":"3.3 Initial Infisical Configuration","text":"<ol> <li>Open browser at <code>http://192.168.1.101</code> (or configured domain)</li> <li>Complete setup wizard:</li> <li>Create admin account</li> <li>Create organization</li> <li>Create project \"omakase\"</li> <li>Generate Machine Identity for Omakase:</li> <li>Settings \u2192 Machine Identities \u2192 Create</li> <li>Save <code>INFISICAL_CLIENT_ID</code> and <code>INFISICAL_CLIENT_SECRET</code></li> </ol>"},{"location":"deployment/proxmox-lxc/#step-4-clone-and-configure-omakase","title":"Step 4: Clone and Configure Omakase","text":""},{"location":"deployment/proxmox-lxc/#41-clone-repository","title":"4.1 Clone Repository","text":"<pre><code># In Omakase container (CT 100), as omakase user\nsu - omakase\ncd ~\ngit clone https://github.com/esoso/omakase.git\ncd omakase\n</code></pre>"},{"location":"deployment/proxmox-lxc/#42-configure-base-variables","title":"4.2 Configure Base Variables","text":"<pre><code># Create .env file for Infisical auth\ncat &gt; .env &lt;&lt;EOF\n# Infisical Configuration\nINFISICAL_DOMAIN=http://192.168.1.101  # Infisical LXC URL\nINFISICAL_PROJECT_ID=&lt;your-project-id&gt;\nINFISICAL_CLIENT_ID=&lt;machine-identity-client-id&gt;\nINFISICAL_CLIENT_SECRET=&lt;machine-identity-client-secret&gt;\nEOF\n\n# DO NOT commit .env\necho \".env\" &gt;&gt; .gitignore\n</code></pre>"},{"location":"deployment/proxmox-lxc/#43-configure-secrets-in-infisical","title":"4.3 Configure Secrets in Infisical","text":"<p>Access Infisical Web UI and add secrets to the \"omakase\" project:</p> <p>Base Secrets (Environment: dev):</p> <pre><code># Data paths\nDATA_DIR=/home/omakase/omakase/data\nCOMPOSE_PROJECT_NAME=omakase\n\n# Domains\nDOMAINNAME=home.arpa\nTRAEFIK_DOMAIN=traefik.home.arpa\n\n# Network\nTRAEFIK_TRUSTED_IPS=192.168.0.0/16,172.16.0.0/12\n\n# User/Group\nPUID=1000\nPGID=1000\nTZ=Europe/Rome\n\n# Database passwords\nPOSTGRES_PASSWORD=&lt;generate-secure-password&gt;\nAUTHELIA_DB_PASSWORD=&lt;generate-secure-password&gt;\n\n# Authelia secrets\nAUTHELIA_JWT_SECRET=&lt;generate-with-openssl-rand-hex-32&gt;\nAUTHELIA_SESSION_SECRET=&lt;generate-with-openssl-rand-hex-32&gt;\nAUTHELIA_STORAGE_ENCRYPTION_KEY=&lt;generate-with-openssl-rand-hex-32&gt;\n\n# Traefik\nTRAEFIK_API_USER=admin\nTRAEFIK_API_PASSWORD=&lt;generate-secure-password&gt;\n\n# Backup (Restic + Backblaze B2)\nRESTIC_PASSWORD=&lt;generate-secure-password&gt;\nB2_ACCOUNT_ID=&lt;backblaze-key-id&gt;\nB2_ACCOUNT_KEY=&lt;backblaze-application-key&gt;\nRESTIC_REPOSITORY=b2:&lt;bucket-name&gt;:omakase\n\n# Telegram notifications (optional)\nTELEGRAM_BOT_TOKEN=&lt;bot-token&gt;\nTELEGRAM_CHAT_ID=&lt;chat-id&gt;\n</code></pre> <p>Generate Secure Passwords:</p> <pre><code># In Omakase container\nmake pwgen  # Generate secure password\n# or\nopenssl rand -base64 32\n</code></pre>"},{"location":"deployment/proxmox-lxc/#44-prepare-directories","title":"4.4 Prepare Directories","text":"<pre><code># Create directory for persistent data\nmkdir -p ~/omakase/data\n\n# Verify permissions\nls -la ~/omakase/\n</code></pre>"},{"location":"deployment/proxmox-lxc/#step-5-configure-opnsense-haproxy","title":"Step 5: Configure OPNsense HAProxy","text":""},{"location":"deployment/proxmox-lxc/#51-install-haproxy-on-opnsense","title":"5.1 Install HAProxy on OPNsense","text":"<ol> <li>System \u2192 Firmware \u2192 Plugins</li> <li>Search and install: <code>os-haproxy</code></li> <li>Services \u2192 HAProxy \u2192 Settings</li> <li>Enable HAProxy</li> </ol>"},{"location":"deployment/proxmox-lxc/#52-configure-backend-omakasetraefik","title":"5.2 Configure Backend (Omakase/Traefik)","text":"<p>Services \u2192 HAProxy \u2192 Settings \u2192 Real Servers:</p> <ul> <li>Name: <code>omakase_traefik</code></li> <li>FQDN/IP: <code>192.168.1.100</code></li> <li>Port: <code>80</code></li> <li>SSL: No (Traefik handles SSL internally)</li> <li>Verify SSL: No</li> <li>Health Check: HTTP</li> </ul>"},{"location":"deployment/proxmox-lxc/#53-configure-https-frontend","title":"5.3 Configure HTTPS Frontend","text":"<p>Services \u2192 HAProxy \u2192 Settings \u2192 Virtual Services \u2192 Public Services:</p> <ul> <li>Name: <code>https_frontend</code></li> <li>Listen Addresses: <code>WAN address:443</code></li> <li>Type: <code>HTTP / HTTPS (SSL offloading)</code></li> <li>Default Backend: <code>omakase_traefik</code></li> <li>SSL Offloading: Yes</li> <li>Certificates: Select Let's Encrypt certificate (see next step)</li> <li>Add ACL: Optional (for hostname-based routing)</li> </ul>"},{"location":"deployment/proxmox-lxc/#54-configure-lets-encrypt-on-opnsense","title":"5.4 Configure Let's Encrypt on OPNsense","text":"<p>System \u2192 Firmware \u2192 Plugins \u2192 Install <code>os-acme-client</code></p> <p>Services \u2192 ACME Client \u2192 Settings:</p> <ol> <li>Create Account:</li> <li>Name: <code>letsencrypt_prod</code></li> <li>ACME CA: <code>Let's Encrypt (Production v2)</code></li> <li> <p>Email: <code>your-email@example.com</code></p> </li> <li> <p>Create Challenge:</p> </li> <li>Name: <code>http01_challenge</code></li> <li>Challenge Type: <code>HTTP-01</code></li> <li> <p>HTTP Service: <code>HAProxy</code></p> </li> <li> <p>Create Certificate:</p> </li> <li>Common Name: <code>*.yourdomain.com</code></li> <li>Account: <code>letsencrypt_prod</code></li> <li>Challenge: <code>http01_challenge</code></li> <li>Auto Renewal: Yes (80 days)</li> <li> <p>Domains: Add all necessary subdomains</p> </li> <li> <p>Issue Certificate \u2192 Wait for completion</p> </li> <li> <p>Bind Certificate to HAProxy:</p> </li> <li>Return to HAProxy \u2192 Virtual Services</li> <li>Select newly created certificate</li> </ol>"},{"location":"deployment/proxmox-lxc/#55-port-forwarding-if-needed","title":"5.5 Port Forwarding (If Needed)","text":"<p>Firewall \u2192 NAT \u2192 Port Forward:</p> <ul> <li>Interface: WAN</li> <li>Protocol: TCP</li> <li>Destination port: 443</li> <li>Redirect target IP: 192.168.1.1 (OPNsense LAN IP)</li> <li>Redirect target port: 443</li> <li>Description: HTTPS to HAProxy</li> </ul>"},{"location":"deployment/proxmox-lxc/#step-6-first-omakase-deployment","title":"Step 6: First Omakase Deployment","text":""},{"location":"deployment/proxmox-lxc/#61-configuration-validation","title":"6.1 Configuration Validation","text":"<pre><code># In Omakase container\ncd ~/omakase\n\n# Test Infisical connection\ninfisical export --env=dev\n\n# Validate compose with secrets\nmake config\n\n# Verify no errors and secrets are injected\n</code></pre>"},{"location":"deployment/proxmox-lxc/#62-deploy-stack","title":"6.2 Deploy Stack","text":"<pre><code># Deploy dev environment\nmake up\n\n# Monitor logs\ndocker compose logs -f\n\n# Verify all services are running\ndocker compose ps\n</code></pre>"},{"location":"deployment/proxmox-lxc/#63-verify-traefik-dashboard","title":"6.3 Verify Traefik Dashboard","text":"<pre><code># Get Traefik IP\ndocker compose exec traefik ip addr show eth0\n\n# Open browser at http://192.168.1.100:8080\n# (or https://traefik.home.arpa if configured via HAProxy)\n</code></pre>"},{"location":"deployment/proxmox-lxc/#step-7-configure-authelia","title":"Step 7: Configure Authelia","text":""},{"location":"deployment/proxmox-lxc/#71-configure-users","title":"7.1 Configure Users","text":"<pre><code># Generate password hash for Authelia\ndocker compose exec authelia authelia crypto hash generate argon2 --password 'your-password'\n\n# Add user in Infisical:\n# AUTHELIA_USERS_&lt;USERNAME&gt;_PASSWORD=&lt;generated-hash&gt;\n</code></pre>"},{"location":"deployment/proxmox-lxc/#72-test-sso","title":"7.2 Test SSO","text":"<ol> <li>Access a protected service (e.g. https://portainer.yourdomain.com)</li> <li>You'll be redirected to Authelia</li> <li>Login with configured credentials</li> <li>Configure 2FA (optional but recommended)</li> </ol>"},{"location":"deployment/proxmox-lxc/#step-8-configure-restic-backups","title":"Step 8: Configure Restic Backups","text":""},{"location":"deployment/proxmox-lxc/#81-initialize-backblaze-repository","title":"8.1 Initialize Backblaze Repository","text":"<pre><code># Verify Restic variables are in Infisical\nmake config | grep RESTIC\n\n# Initialize repository (first time only)\ndocker compose run --rm backup restic init\n\n# Output: created restic repository xyz at b2:...\n</code></pre>"},{"location":"deployment/proxmox-lxc/#82-test-manual-backup","title":"8.2 Test Manual Backup","text":"<pre><code># Run first backup\ndocker compose run --rm backup /app/scripts/backup.sh\n\n# Verify backup\ndocker compose run --rm backup restic snapshots\n</code></pre>"},{"location":"deployment/proxmox-lxc/#83-automated-backups","title":"8.3 Automated Backups","text":"<p>Backups are already configured in <code>compose/backup/compose.yaml</code>:</p> <ul> <li>Daily backup: 3:30 AM</li> <li>Check: 5:15 AM</li> <li>Prune: 4:00 AM</li> </ul> <p>Verify with:</p> <pre><code>docker compose logs backup\n</code></pre>"},{"location":"deployment/proxmox-lxc/#step-9-monitoring-and-maintenance","title":"Step 9: Monitoring and Maintenance","text":""},{"location":"deployment/proxmox-lxc/#91-access-dashboards","title":"9.1 Access Dashboards","text":"<ul> <li>Homepage: https://home.yourdomain.com</li> <li>Traefik: https://traefik.yourdomain.com</li> <li>Portainer: https://portainer.yourdomain.com</li> <li>Dozzle (logs): https://dozzle.yourdomain.com</li> </ul>"},{"location":"deployment/proxmox-lxc/#92-useful-commands","title":"9.2 Useful Commands","text":"<pre><code># View all services status\nmake ps\n\n# View logs per service\ndocker compose logs -f &lt;service-name&gt;\n\n# Restart service\ndocker compose restart &lt;service-name&gt;\n\n# Update images\nmake pull\n\n# Restart stack\nmake restart\n\n# Stop stack\nmake down\n</code></pre>"},{"location":"deployment/proxmox-lxc/#93-monitor-lxc-resources","title":"9.3 Monitor LXC Resources","text":"<pre><code># On Proxmox host\npct status 100        # Container status\npct exec 100 -- df -h # Disk usage\npct exec 100 -- free -h # Memory usage\npct exec 100 -- docker stats # Docker stats\n</code></pre>"},{"location":"deployment/proxmox-lxc/#troubleshooting","title":"Troubleshooting","text":""},{"location":"deployment/proxmox-lxc/#container-wont-start","title":"Container Won't Start","text":"<pre><code># Check Proxmox logs\njournalctl -u pve-container@100\n\n# Verify LXC features\ncat /etc/pve/lxc/100.conf | grep -E \"features|nesting\"\n\n# Ensure nesting=1\n</code></pre>"},{"location":"deployment/proxmox-lxc/#docker-not-working-in-lxc","title":"Docker Not Working in LXC","text":"<pre><code># Verify apparmor isn't blocking Docker\naa-status\n\n# If needed, disable apparmor for this container\n# (already done in Step 1.3)\n</code></pre>"},{"location":"deployment/proxmox-lxc/#traefik-not-reachable-from-haproxy","title":"Traefik Not Reachable from HAProxy","text":"<pre><code># Verify Traefik listens on 0.0.0.0:80\ndocker compose exec traefik netstat -tlnp | grep :80\n\n# Verify container firewall (should be permissive)\niptables -L\n\n# Test from OPNsense\n# Diagnostics \u2192 Ping: 192.168.1.100\n# Diagnostics \u2192 Port Probe: 192.168.1.100:80\n</code></pre>"},{"location":"deployment/proxmox-lxc/#secrets-not-loading","title":"Secrets Not Loading","text":"<pre><code># Verify Infisical connection\ninfisical export --env=dev\n\n# Verify .env variables\ncat .env\n\n# Test Infisical LXC connection\ncurl http://192.168.1.101/api/status\n</code></pre>"},{"location":"deployment/proxmox-lxc/#backup-and-disaster-recovery","title":"Backup and Disaster Recovery","text":""},{"location":"deployment/proxmox-lxc/#complete-lxc-backup-proxmox","title":"Complete LXC Backup (Proxmox)","text":"<pre><code># Create LXC snapshot\nvzdump 100 --mode snapshot --storage local\n\n# Scheduled backup (cron on Proxmox host)\n# Datacenter \u2192 Backup \u2192 Add\n</code></pre>"},{"location":"deployment/proxmox-lxc/#restore-from-backup","title":"Restore from Backup","text":"<pre><code># Restore container from backup\npct restore 100 /var/lib/vz/dump/vzdump-lxc-100-*.tar.zst\n\n# Restore Restic data\ndocker compose run --rm backup restic restore latest --target /restore\n</code></pre>"},{"location":"deployment/proxmox-lxc/#best-practices","title":"Best Practices","text":"<ol> <li>Regular snapshots: Configure automatic LXC backups on Proxmox</li> <li>Monitoring: Use Uptime Kuma or Grafana for uptime monitoring</li> <li>Updates: Run <code>apt update &amp;&amp; apt upgrade</code> monthly in LXC</li> <li>Logs: Monitor Dozzle for anomalous errors</li> <li>Secret rotation: Rotate critical secrets every 90 days</li> <li>Firewall rules: Maintain minimal OPNsense firewall rules (least privilege)</li> <li>2FA: Enable 2FA on Authelia for all users</li> <li>Backup testing: Test restore from backup quarterly</li> </ol>"},{"location":"deployment/proxmox-lxc/#useful-resources","title":"Useful Resources","text":"<ul> <li>Proxmox LXC Documentation</li> <li>OPNsense HAProxy Plugin</li> <li>Docker in LXC</li> <li>Infisical Self-Hosted</li> </ul>"},{"location":"deployment/proxmox-lxc/#next-steps","title":"Next Steps","text":"<ul> <li>Add new services</li> <li>Configure advanced monitoring</li> <li>Set up VPN for remote access</li> <li>Performance optimization</li> </ul>"},{"location":"deployment/vm-generic/","title":"Virtual Machine Deployment","text":"<p>Deploy Omakase in a virtual machine for flexibility and easy management.</p>"},{"location":"deployment/vm-generic/#overview","title":"Overview","text":"<p>VM deployment provides isolation and flexibility while sharing hardware resources.</p> <p>Advantages: - Easy snapshots and backups - Hardware abstraction - Easy migration - Can run alongside other VMs - Test environment on same hardware</p> <p>Disadvantages: - Virtualization overhead (~5-10%) - Requires hypervisor - More complex setup</p>"},{"location":"deployment/vm-generic/#supported-hypervisors","title":"Supported Hypervisors","text":"<ul> <li>VMware ESXi / Workstation</li> <li>Proxmox VE (see Proxmox LXC for container option)</li> <li>KVM/QEMU (libvirt)</li> <li>VirtualBox</li> <li>Hyper-V</li> </ul>"},{"location":"deployment/vm-generic/#vm-specifications","title":"VM Specifications","text":""},{"location":"deployment/vm-generic/#minimum","title":"Minimum","text":"<ul> <li>vCPU: 4 cores</li> <li>RAM: 8GB</li> <li>Disk: 250GB (thin provisioned)</li> <li>Network: Bridged or NAT with port forwarding</li> </ul>"},{"location":"deployment/vm-generic/#recommended","title":"Recommended","text":"<ul> <li>vCPU: 8 cores</li> <li>RAM: 16GB</li> <li>Disk: 500GB NVMe/SSD</li> <li>Network: Bridged for direct LAN access</li> </ul>"},{"location":"deployment/vm-generic/#vm-creation","title":"VM Creation","text":""},{"location":"deployment/vm-generic/#vmware-example","title":"VMware Example","text":"<ol> <li>Create New VM:</li> <li>Guest OS: Linux \u2192 Ubuntu 64-bit</li> <li>Processors: 8 cores</li> <li>Memory: 16GB</li> <li>Disk: 500GB (thin provision)</li> <li> <p>Network: Bridged</p> </li> <li> <p>VM Settings:</p> </li> <li>Enable hardware virtualization (VT-x/AMD-V)</li> <li>Paravirtualized SCSI controller</li> <li> <p>VMXNET3 network adapter</p> </li> <li> <p>Install OS: Mount Ubuntu Server 24.04 ISO</p> </li> </ol>"},{"location":"deployment/vm-generic/#proxmox-example","title":"Proxmox Example","text":"<pre><code># Create VM via CLI\nqm create 100 \\\n  --name omakase \\\n  --memory 16384 \\\n  --cores 8 \\\n  --sockets 1 \\\n  --net0 virtio,bridge=vmbr0 \\\n  --scsi0 local-lvm:500 \\\n  --ide2 local:iso/ubuntu-24.04-server-amd64.iso,media=cdrom \\\n  --boot order=ide2 \\\n  --ostype l26\n\n# Start VM\nqm start 100\n</code></pre>"},{"location":"deployment/vm-generic/#kvmqemu-example","title":"KVM/QEMU Example","text":"<pre><code># Create disk\nqemu-img create -f qcow2 omakase.qcow2 500G\n\n# Create VM\nvirt-install \\\n  --name omakase \\\n  --ram 16384 \\\n  --vcpus 8 \\\n  --disk path=omakase.qcow2,format=qcow2 \\\n  --network bridge=br0 \\\n  --graphics none \\\n  --console pty,target_type=serial \\\n  --location /path/to/ubuntu-24.04-server-amd64.iso \\\n  --os-variant ubuntu24.04 \\\n  --extra-args 'console=ttyS0,115200n8'\n</code></pre>"},{"location":"deployment/vm-generic/#operating-system-installation","title":"Operating System Installation","text":"<p>Follow Bare Metal Deployment guide for OS installation.</p>"},{"location":"deployment/vm-generic/#vm-specific-configuration","title":"VM-Specific Configuration","text":""},{"location":"deployment/vm-generic/#disk-configuration","title":"Disk Configuration","text":"<p>Two-disk setup (recommended): - Disk 1 (100GB): OS and Docker - Disk 2 (500GB+): Data storage</p> <pre><code># Format data disk\nsudo mkfs.ext4 /dev/sdb\n\n# Mount\nsudo mkdir -p /mnt/storage\necho \"/dev/sdb /mnt/storage ext4 defaults,noatime 0 2\" | sudo tee -a /etc/fstab\nsudo mount -a\n</code></pre>"},{"location":"deployment/vm-generic/#network-configuration","title":"Network Configuration","text":"<p>Bridged mode (recommended): - VM gets own IP on LAN - Direct access from network - Easy DNS setup</p> <p>NAT mode: <pre><code># Port forwarding required\n# Host: 8080 \u2192 Guest: 80\n# Host: 8443 \u2192 Guest: 443\n</code></pre></p>"},{"location":"deployment/vm-generic/#guest-tools","title":"Guest Tools","text":"<p>VMware Tools: <pre><code>sudo apt install open-vm-tools\n</code></pre></p> <p>QEMU Guest Agent: <pre><code>sudo apt install qemu-guest-agent\nsudo systemctl enable qemu-guest-agent\nsudo systemctl start qemu-guest-agent\n</code></pre></p> <p>VirtualBox Guest Additions: <pre><code>sudo apt install virtualbox-guest-utils virtualbox-guest-dkms\n</code></pre></p>"},{"location":"deployment/vm-generic/#performance-optimization","title":"Performance Optimization","text":""},{"location":"deployment/vm-generic/#paravirtualized-drivers","title":"Paravirtualized Drivers","text":"<p>Use virtio drivers for better performance: - Disk: VirtIO SCSI - Network: VirtIO Net - Balloon: VirtIO Balloon (memory management)</p>"},{"location":"deployment/vm-generic/#cpu-configuration","title":"CPU Configuration","text":"<pre><code># Enable CPU passthrough features\ncpu: host\n</code></pre> <p>Allocate dedicated cores if possible.</p>"},{"location":"deployment/vm-generic/#memory","title":"Memory","text":"<ul> <li>Enable ballooning for dynamic allocation</li> <li>Set minimum memory reservation</li> <li>Disable memory overcommit in production</li> </ul>"},{"location":"deployment/vm-generic/#storage","title":"Storage","text":"<ul> <li>Use SSD/NVMe backed storage</li> <li>Enable TRIM/UNMAP for thin provisioning</li> <li>Use virtio-scsi over IDE</li> </ul>"},{"location":"deployment/vm-generic/#snapshots-and-backups","title":"Snapshots and Backups","text":""},{"location":"deployment/vm-generic/#vm-snapshots","title":"VM Snapshots","text":"<p>Before major changes: <pre><code># Proxmox\nqm snapshot 100 pre-update\n\n# VMware\nvim-cmd vmsvc/snapshot.create VM_ID snapshot_name\n\n# KVM\nvirsh snapshot-create-as omakase pre-update\n</code></pre></p> <p>Restore if needed: <pre><code># Proxmox\nqm rollback 100 pre-update\n\n# KVM\nvirsh snapshot-revert omakase pre-update\n</code></pre></p>"},{"location":"deployment/vm-generic/#vm-backup","title":"VM Backup","text":"<p>Full VM backup: - Proxmox: Built-in backup (vzdump) - VMware: VM clone or export to OVA - KVM: virsh dombackup</p> <p>Data-only backup: Use Omakase's built-in Restic backup for application data.</p>"},{"location":"deployment/vm-generic/#high-availability","title":"High Availability","text":""},{"location":"deployment/vm-generic/#vm-level-ha","title":"VM-Level HA","text":"<p>Proxmox HA: <pre><code># Enable HA for VM\nha-manager add vm:100\n</code></pre></p> <p>VMware HA: Configure in vSphere cluster settings.</p>"},{"location":"deployment/vm-generic/#replication","title":"Replication","text":"<p>Proxmox: <pre><code># Set up replication\npvecm add &lt;node-ip&gt;\n</code></pre></p>"},{"location":"deployment/vm-generic/#migration","title":"Migration","text":""},{"location":"deployment/vm-generic/#live-migration","title":"Live Migration","text":"<p>Proxmox: <pre><code>qm migrate 100 target-node\n</code></pre></p> <p>VMware vMotion: Right-click VM \u2192 Migrate \u2192 Change host</p>"},{"location":"deployment/vm-generic/#cold-migration","title":"Cold Migration","text":"<ol> <li>Shut down VM</li> <li>Export VM (OVA/OVF)</li> <li>Import on target hypervisor</li> <li>Update network configuration</li> <li>Start VM</li> </ol>"},{"location":"deployment/vm-generic/#resource-management","title":"Resource Management","text":""},{"location":"deployment/vm-generic/#cpu-allocation","title":"CPU Allocation","text":"<pre><code># Proxmox\ncores: 8\ncpu: host\ncpu-units: 1024  # Default priority\n</code></pre>"},{"location":"deployment/vm-generic/#memory-allocation","title":"Memory Allocation","text":"<pre><code>memory: 16384\nballoon: 8192  # Minimum guaranteed\n</code></pre>"},{"location":"deployment/vm-generic/#disk-qos","title":"Disk QoS","text":"<pre><code># Limit disk I/O if needed\nmbps_rd: 100  # MB/s read limit\nmbps_wr: 100  # MB/s write limit\n</code></pre>"},{"location":"deployment/vm-generic/#monitoring","title":"Monitoring","text":""},{"location":"deployment/vm-generic/#hypervisor-monitoring","title":"Hypervisor Monitoring","text":"<p>Monitor VM resources from hypervisor: - CPU usage - Memory usage - Disk I/O - Network throughput</p>"},{"location":"deployment/vm-generic/#guest-monitoring","title":"Guest Monitoring","text":"<p>Use Omakase's built-in monitoring stack.</p>"},{"location":"deployment/vm-generic/#troubleshooting","title":"Troubleshooting","text":""},{"location":"deployment/vm-generic/#vm-performance-issues","title":"VM Performance Issues","text":"<p>Check resource allocation: - Enough vCPUs assigned? - Memory ballooning aggressive? - Disk on SSD?</p> <p>Check host load: - Other VMs consuming resources? - Host swap usage?</p>"},{"location":"deployment/vm-generic/#network-issues","title":"Network Issues","text":"<p>Bridged mode not working: - Check bridge configuration - Verify promiscuous mode enabled</p> <p>Can't reach VM: - Check firewall on guest - Verify network adapter connected - Check DHCP/static IP configuration</p>"},{"location":"deployment/vm-generic/#disk-full","title":"Disk Full","text":"<pre><code># Inside VM\ndf -h\n\n# Thin provisioned disk full?\n# Expand disk in hypervisor\n# Then expand filesystem\nsudo growpart /dev/sda 1\nsudo resize2fs /dev/sda1\n</code></pre>"},{"location":"deployment/vm-generic/#best-practices","title":"Best Practices","text":"<ol> <li>Use paravirtualized drivers - Better performance</li> <li>Regular snapshots - Before updates/changes</li> <li>Monitor resource usage - Adjust allocation as needed</li> <li>Use SSD storage - Significant performance boost</li> <li>Bridged networking - Simpler than NAT</li> <li>Install guest tools - Better integration</li> <li>Allocate adequate resources - Don't overcommit</li> <li>Regular VM backups - Complement data backups</li> </ol>"},{"location":"deployment/vm-generic/#see-also","title":"See Also","text":"<ul> <li>Bare Metal Deployment - OS installation details</li> <li>Proxmox LXC - Container alternative</li> <li>Performance Tuning</li> </ul>"},{"location":"getting-started/configuration/","title":"Configuration","text":"<p>This guide covers post-installation configuration of Omakase services.</p>"},{"location":"getting-started/configuration/#environment-variables","title":"Environment Variables","text":"<p>All environment variables are managed through Infisical. See Secrets Management for details.</p>"},{"location":"getting-started/configuration/#core-variables","title":"Core Variables","text":"<p>Required for all deployments:</p> Variable Description Example <code>DATA_DIR</code> Base directory for persistent data <code>/mnt/storage/omakase</code> <code>DOMAINNAME</code> Base domain for services <code>example.com</code> <code>TRAEFIK_TRUSTED_IPS</code> Trusted IP ranges <code>192.168.1.0/24</code> <code>PUID</code> User ID for non-root execution <code>1000</code> <code>PGID</code> Group ID for non-root execution <code>1000</code> <code>TZ</code> Timezone <code>Europe/Rome</code>"},{"location":"getting-started/configuration/#service-specific-variables","title":"Service-Specific Variables","text":"<p>Each service requires its own set of secrets following the pattern: <code>&lt;SERVICE&gt;_&lt;COMPONENT&gt;_&lt;PURPOSE&gt;</code></p> <p>Example: <pre><code>NEXTCLOUD_DB_PASSWORD=secure-password\nNEXTCLOUD_ADMIN_PASSWORD=another-secure-password\nVAULTWARDEN_ADMIN_TOKEN=token-here\n</code></pre></p>"},{"location":"getting-started/configuration/#service-configuration","title":"Service Configuration","text":""},{"location":"getting-started/configuration/#authelia-sso","title":"Authelia (SSO)","text":"<p>Authelia provides single sign-on for all services.</p> <ol> <li>Configure users in <code>compose/authelia/config/users_database.yml</code></li> <li>Set up SMTP for password resets</li> <li>Configure 2FA requirements</li> </ol>"},{"location":"getting-started/configuration/#traefik-reverse-proxy","title":"Traefik (Reverse Proxy)","text":"<p>Traefik automatically discovers services via Docker labels.</p> <p>Configure TLS: - Automatic Let's Encrypt certificates - Custom certificate resolver: <code>letsencrypt</code> - DNS challenge for wildcard certificates</p>"},{"location":"getting-started/configuration/#crowdsec-ips","title":"CrowdSec (IPS)","text":"<p>Configure security collections: <pre><code>docker exec crowdsec cscli collections list\ndocker exec crowdsec cscli collections install crowdsecurity/traefik\n</code></pre></p>"},{"location":"getting-started/configuration/#network-configuration","title":"Network Configuration","text":"<p>Services use isolated networks. See Network Architecture for details.</p> <p>To check allocated subnets: <pre><code>make network\n</code></pre></p>"},{"location":"getting-started/configuration/#storage-configuration","title":"Storage Configuration","text":""},{"location":"getting-started/configuration/#directory-structure","title":"Directory Structure","text":"<p>Standard layout: <pre><code>${DATA_DIR}/\n\u251c\u2500\u2500 service-name/\n\u2502   \u251c\u2500\u2500 config/\n\u2502   \u251c\u2500\u2500 data/\n\u2502   \u2514\u2500\u2500 logs/\n</code></pre></p>"},{"location":"getting-started/configuration/#permissions","title":"Permissions","text":"<p>Ensure correct ownership: <pre><code>chown -R ${PUID}:${PGID} ${DATA_DIR}/service-name\n</code></pre></p>"},{"location":"getting-started/configuration/#backup-configuration","title":"Backup Configuration","text":"<p>See Backup Guide for configuring automated backups.</p>"},{"location":"getting-started/configuration/#monitoring-configuration","title":"Monitoring Configuration","text":"<p>Configure monitoring dashboards: - Dozzle: Real-time container logs - Homepage: Service dashboard - Portainer: Container management</p>"},{"location":"getting-started/configuration/#next-steps","title":"Next Steps","text":"<ul> <li>Add Services - Add new services to your stack</li> <li>Network Architecture - Understand network isolation</li> <li>Backup - Configure automated backups</li> </ul>"},{"location":"getting-started/installation/","title":"Installation","text":"<p>This guide will walk you through installing Omakase homelab infrastructure.</p>"},{"location":"getting-started/installation/#prerequisites","title":"Prerequisites","text":"<p>Before proceeding with installation, ensure you have completed all prerequisites.</p>"},{"location":"getting-started/installation/#installation-steps","title":"Installation Steps","text":""},{"location":"getting-started/installation/#1-clone-the-repository","title":"1. Clone the Repository","text":"<pre><code>git clone https://github.com/yourusername/omakase.git\ncd omakase\n</code></pre>"},{"location":"getting-started/installation/#2-set-up-infisical","title":"2. Set Up Infisical","text":"<p>Configure your Infisical authentication:</p> <pre><code>export INFISICAL_DOMAIN=\"your-infisical-domain\"\nexport INFISICAL_PROJECT_ID=\"your-project-id\"\nexport INFISICAL_CLIENT_ID=\"your-client-id\"\nexport INFISICAL_CLIENT_SECRET=\"your-client-secret\"\n</code></pre>"},{"location":"getting-started/installation/#3-configure-secrets","title":"3. Configure Secrets","text":"<p>Add all required secrets to your Infisical vault. See Secrets Management for details.</p> <p>Required environment variables: - <code>DATA_DIR</code> - Base directory for persistent data - <code>DOMAINNAME</code> - Base domain for services - <code>TRAEFIK_TRUSTED_IPS</code> - Trusted IP ranges - <code>PUID</code>/<code>PGID</code> - User/group IDs for non-root execution - <code>TZ</code> - Timezone</p>"},{"location":"getting-started/installation/#4-validate-configuration","title":"4. Validate Configuration","text":"<p>Before deploying, validate your compose files:</p> <pre><code>make config\n</code></pre> <p>This will verify: - Compose file syntax - Secret injection from Infisical - Network configuration</p>"},{"location":"getting-started/installation/#5-deploy-services","title":"5. Deploy Services","text":"<p>For development environment:</p> <pre><code>make up\n</code></pre> <p>For production environment:</p> <pre><code>INFISICAL_TOKEN=$(infisical login ...) infisical run --env=prod -- docker compose -f compose.yaml -f compose.prod.yaml up -d\n</code></pre>"},{"location":"getting-started/installation/#6-verify-deployment","title":"6. Verify Deployment","text":"<p>Check that all services are running:</p> <pre><code>docker compose ps\n</code></pre> <p>View logs:</p> <pre><code>docker compose logs -f\n</code></pre>"},{"location":"getting-started/installation/#post-installation","title":"Post-Installation","text":""},{"location":"getting-started/installation/#configure-dns","title":"Configure DNS","text":"<p>Point your domain's DNS records to your server's IP address:</p> <pre><code>*.yourdomain.com -&gt; your-server-ip\n</code></pre>"},{"location":"getting-started/installation/#access-services","title":"Access Services","text":"<p>Services will be available at: - Homepage: <code>https://home.yourdomain.com</code> - Traefik Dashboard: <code>https://traefik.yourdomain.com</code> - Portainer: <code>https://portainer.yourdomain.com</code></p> <p>All services are protected by Authelia SSO.</p>"},{"location":"getting-started/installation/#next-steps","title":"Next Steps","text":"<ul> <li>Configuration - Configure individual services</li> <li>Operations Guide - Set up backups and monitoring</li> <li>Troubleshooting - Common issues and solutions</li> </ul>"},{"location":"getting-started/prerequisites/","title":"Prerequisites","text":"<p>Before deploying Omakase, ensure you have the required infrastructure and understand the system requirements.</p>"},{"location":"getting-started/prerequisites/#system-requirements","title":"System Requirements","text":""},{"location":"getting-started/prerequisites/#minimum-configuration-15-20-services","title":"Minimum Configuration (15-20 services)","text":"Component Requirement CPU 4 cores RAM 8 GB Storage 200 GB Network 100 Mbps OS Linux (Debian 12 / Ubuntu 22.04+)"},{"location":"getting-started/prerequisites/#recommended-configuration-25-30-services","title":"Recommended Configuration (25-30 services)","text":"Component Requirement CPU 8+ cores RAM 16 GB Storage 500 GB Network 1 Gbps OS Debian 12 (Bookworm)"},{"location":"getting-started/prerequisites/#hardware-considerations","title":"Hardware Considerations","text":"<p>CPU: - Multi-threaded workloads (transcoding, backups, containers) - Intel/AMD x64 architecture required - ARM64 support experimental (some images may not be available)</p> <p>RAM: - Each service requires 50-500MB - Database services (PostgreSQL) can use 1-2GB - Media services (Jellyfin, Plex) with transcoding need 2-4GB - Leave headroom for OS and Docker overhead</p> <p>Storage: - System: 50GB for OS + Docker images - Data: 150GB+ for service persistent data - Media: Additional storage if using media services (1TB+ recommended) - SSD recommended for database performance</p>"},{"location":"getting-started/prerequisites/#software-prerequisites","title":"Software Prerequisites","text":""},{"location":"getting-started/prerequisites/#required-software","title":"Required Software","text":""},{"location":"getting-started/prerequisites/#1-linux-operating-system","title":"1. Linux Operating System","text":"<p>Supported Distributions:</p> Debian 12 (Recommended)Ubuntu 22.04/24.04 LTSOther <pre><code># Verify version\ncat /etc/os-release\n# Should show: VERSION=\"12 (bookworm)\"\n</code></pre> <pre><code># Verify version\nlsb_release -a\n# Should show: Ubuntu 22.04 LTS or 24.04 LTS\n</code></pre> <p>Any modern Linux distribution with: - Kernel 5.10+ - systemd - AppArmor or SELinux support</p> <p>Not Supported: - Windows (even with WSL2) - macOS (Docker Desktop limitations) - ARM64 (experimental, some services unavailable)</p>"},{"location":"getting-started/prerequisites/#2-docker-engine","title":"2. Docker Engine","text":"<p>Version: Docker 24.0+ with Docker Compose v2.20+</p> <p>Installation:</p> <pre><code># Install Docker (official script)\ncurl -fsSL https://get.docker.com -o get-docker.sh\nsudo sh get-docker.sh\n\n# Add user to docker group (optional, logout required)\nsudo usermod -aG docker $USER\n\n# Verify installation\ndocker --version\ndocker compose version\n\n# Expected output:\n# Docker version 28.x.x\n# Docker Compose version v2.39.x\n</code></pre> <p>Alternative Installation: See deployment guides for platform-specific instructions.</p>"},{"location":"getting-started/prerequisites/#3-git","title":"3. Git","text":"<pre><code># Install git\nsudo apt update\nsudo apt install -y git\n\n# Verify\ngit --version\n</code></pre>"},{"location":"getting-started/prerequisites/#4-make-optional-but-recommended","title":"4. Make (Optional but recommended)","text":"<pre><code># Install make\nsudo apt install -y make\n\n# Verify\nmake --version\n</code></pre>"},{"location":"getting-started/prerequisites/#secret-management-setup","title":"Secret Management Setup","text":"<p>You must choose ONE of these options:</p>"},{"location":"getting-started/prerequisites/#option-a-infisical-self-hosted-recommended-for-homelab","title":"Option A: Infisical Self-Hosted (Recommended for Homelab)","text":"<p>Pros: - Full control over secrets - No external dependencies - Free and open source - Can be deployed alongside Omakase</p> <p>Cons: - Requires separate setup - Additional resources (2GB RAM, 20GB storage)</p> <p>Setup Guide: See Secrets Management</p>"},{"location":"getting-started/prerequisites/#option-b-infisical-cloud-easiest","title":"Option B: Infisical Cloud (Easiest)","text":"<p>Pros: - No additional infrastructure needed - Always available - Automatic backups - Free tier available</p> <p>Cons: - External dependency - Secrets stored on third-party (encrypted)</p> <p>Setup: Sign up at Infisical Cloud</p>"},{"location":"getting-started/prerequisites/#option-c-environment-files-development-only","title":"Option C: Environment Files (Development Only)","text":"<p>Not for Production</p> <p>Using <code>.env</code> files is NOT recommended for production. Secrets will be in plain text on disk.</p> <p>Use only for: - Local testing - Development environments - Learning/evaluation</p>"},{"location":"getting-started/prerequisites/#network-requirements","title":"Network Requirements","text":""},{"location":"getting-started/prerequisites/#port-requirements","title":"Port Requirements","text":"<p>Omakase needs these ports available on your host:</p> Port Protocol Service Required Publicly Exposed 80 TCP Traefik HTTP Yes Optional* 443 TCP Traefik HTTPS Yes Optional* 8080 TCP Traefik Dashboard No Never <p>* Expose ports 80/443 only if accessing services from outside your local network. Otherwise, use VPN or reverse proxy.</p> <p>Additional ports: Each service may expose additional ports internally (Docker networks only).</p>"},{"location":"getting-started/prerequisites/#dns-domain-requirements","title":"DNS / Domain Requirements","text":"<p>You need a domain name for SSL certificates and service routing. Options:</p>"},{"location":"getting-started/prerequisites/#production-domains","title":"Production Domains","text":"<p>Public Domain (Recommended): - Purchase from registrar (Cloudflare, Namecheap, etc.) - Configure DNS A records pointing to your public IP - Required for Let's Encrypt SSL certificates - Cost: $10-15/year</p> <p>Dynamic DNS (DDNS): - Free subdomain (e.g., <code>yourname.duckdns.org</code>) - Automatic IP updates - Providers: DuckDNS, No-IP, Dynu - Works with Let's Encrypt</p>"},{"location":"getting-started/prerequisites/#developmentlocal-only","title":"Development/Local Only","text":"<p>Local Domain (<code>.local</code> or <code>.home.arpa</code>): - No cost, works on LAN only - Configure in local DNS or <code>/etc/hosts</code> - Self-signed certificates (browser warnings) - Not accessible from internet</p> <p>Example: <pre><code># /etc/hosts on your workstation\n192.168.1.100 traefik.home.arpa\n192.168.1.100 portainer.home.arpa\n192.168.1.100 authelia.home.arpa\n</code></pre></p>"},{"location":"getting-started/prerequisites/#firewall-considerations","title":"Firewall Considerations","text":"<p>If using a separate firewall/router (OPNsense, pfSense, etc.):</p> <ul> <li>Internal Access Only: No firewall rules needed</li> <li>External Access: Forward ports 80/443 to Omakase host</li> <li>VPN Access: Configure Wireguard/OpenVPN</li> </ul> <p>See deployment scenarios for architecture examples.</p>"},{"location":"getting-started/prerequisites/#knowledge-prerequisites","title":"Knowledge Prerequisites","text":""},{"location":"getting-started/prerequisites/#required-knowledge","title":"Required Knowledge","text":"<ul> <li>Basic Linux administration</li> <li>Command line navigation</li> <li>File permissions</li> <li> <p>Package management (apt)</p> </li> <li> <p>Docker fundamentals</p> </li> <li>Container concepts</li> <li>Docker Compose basics</li> <li> <p>Understanding volumes and networks</p> </li> <li> <p>Git basics</p> </li> <li>Clone repositories</li> <li>Pull updates</li> </ul>"},{"location":"getting-started/prerequisites/#recommended-knowledge","title":"Recommended Knowledge","text":"<ul> <li>Networking basics</li> <li>IP addressing and subnets</li> <li>Port forwarding</li> <li> <p>DNS concepts</p> </li> <li> <p>Security awareness</p> </li> <li>Password management</li> <li>SSL/TLS certificates</li> <li> <p>Firewall rules</p> </li> <li> <p>Backup/restore procedures</p> </li> </ul>"},{"location":"getting-started/prerequisites/#optional-knowledge","title":"Optional Knowledge","text":"<ul> <li>Reverse proxy configuration (Traefik/Nginx)</li> <li>YAML syntax</li> <li>Container orchestration</li> <li>Infrastructure as Code concepts</li> </ul> <p>Don't worry if you don't have all the recommended knowledge - the documentation guides you through each step!</p>"},{"location":"getting-started/prerequisites/#preparation-checklist","title":"Preparation Checklist","text":"<p>Before proceeding to installation, ensure:</p> <ul> <li> Linux system meets minimum requirements</li> <li> Docker Engine 24.0+ installed and running</li> <li> Docker Compose v2.20+ installed</li> <li> Git installed</li> <li> Secret management chosen (Infisical Cloud/Self-hosted)</li> <li> Domain name configured (public or local)</li> <li> Network ports 80/443 available</li> <li> Storage space allocated (200GB+ available)</li> <li> Backup storage planned (optional but recommended)</li> </ul>"},{"location":"getting-started/prerequisites/#estimated-deployment-time","title":"Estimated Deployment Time","text":"Task Time Prerequisites Setup 30-60 min Infisical Setup 30-60 min Omakase Installation 15-30 min Service Configuration 1-2 hours Testing &amp; Verification 30-60 min Total 3-5 hours <p>First-time deployment. Subsequent deployments: 15-30 minutes.</p>"},{"location":"getting-started/prerequisites/#next-steps","title":"Next Steps","text":"<p>Once prerequisites are met:</p> <ol> <li>Choose your deployment scenario</li> <li>Install Omakase</li> <li>Configure services</li> </ol>"},{"location":"getting-started/prerequisites/#troubleshooting-prerequisites","title":"Troubleshooting Prerequisites","text":""},{"location":"getting-started/prerequisites/#docker-wont-start","title":"Docker won't start","text":"<pre><code># Check Docker service status\nsudo systemctl status docker\n\n# Check logs\nsudo journalctl -u docker -n 50\n\n# Restart Docker\nsudo systemctl restart docker\n</code></pre>"},{"location":"getting-started/prerequisites/#insufficient-disk-space","title":"Insufficient disk space","text":"<pre><code># Check disk usage\ndf -h\n\n# Clean Docker resources\ndocker system prune -a --volumes\n</code></pre>"},{"location":"getting-started/prerequisites/#port-already-in-use","title":"Port already in use","text":"<pre><code># Check what's using port 80\nsudo lsof -i :80\n\n# Kill process or reconfigure\n</code></pre> <p>For more issues, see Troubleshooting Guide.</p>"},{"location":"infrastructure/authelia/","title":"Authelia","text":"<p>Authelia provides single sign-on (SSO) and two-factor authentication for all Omakase services.</p>"},{"location":"infrastructure/authelia/#overview","title":"Overview","text":"<p>Authelia features: - Single Sign-On - Login once, access all services - Two-Factor Authentication - TOTP, WebAuthn, Duo - Access Control - Fine-grained authorization rules - Session Management - Secure session handling - Password Reset - Self-service password recovery</p>"},{"location":"infrastructure/authelia/#configuration","title":"Configuration","text":""},{"location":"infrastructure/authelia/#service-architecture","title":"Service Architecture","text":"<p>Located in <code>compose/core/authelia/compose.yaml</code>:</p> <pre><code>services:\n  authelia:\n    image: ghcr.io/authelia/authelia:4.39.14\n    container_name: authelia\n    command: '--config /config/configuration.yml'\n    environment:\n      X_AUTHELIA_CONFIG_FILTERS: template  # Enable Go templating\n      AUTHELIA_SESSION_SECRET: ${AUTHELIA_SESSION_SECRET}\n      AUTHELIA_STORAGE_ENCRYPTION_KEY: ${AUTHELIA_STORAGE_ENCRYPTION_KEY}\n      AUTHELIA_STORAGE_POSTGRES_PASSWORD: ${AUTHELIA_DB_PASS}\n      AUTHELIA_IDENTITY_VALIDATION_RESET_PASSWORD_JWT_SECRET: ${...}\n      IDENTITY_PROVIDERS_OIDC_HMAC_SECRET: ${...}\n      IDENTITY_PROVIDERS_OIDC_JWKS: ${...}\n      # SMTP Configuration\n      AUTHELIA_NOTIFIER_SMTP_ADDRESS: submissions://${SMTP_SERVER}:${SMTP_PORT}\n      AUTHELIA_NOTIFIER_SMTP_USERNAME: ${SMTP_USERNAME}\n      AUTHELIA_NOTIFIER_SMTP_PASSWORD: ${SMTP_PASSWORD}\n      AUTHELIA_NOTIFIER_SMTP_SENDER: Authelia &lt;noreply@${TLD}&gt;\n    networks:\n      - vnet-ingress    # For Traefik access\n      - vnet-authelia   # Isolated network for DB and Redis\n    depends_on:\n      authelia-db:\n        condition: service_healthy\n      authelia-redict:\n        condition: service_healthy\n\n  authelia-db:\n    extends:\n      file: ../common/compose.yaml\n      service: postgres\n    environment:\n      POSTGRES_DB: ${AUTHELIA_DB_NAME:-authelia_db}\n      POSTGRES_USER: ${AUTHELIA_DB_USER:-authelia}\n      POSTGRES_PASSWORD: ${AUTHELIA_DB_PASS}\n    networks:\n      - vnet-authelia\n\n  authelia-redict:\n    extends:\n      file: ../common/compose.yaml\n      service: redict\n    networks:\n      - vnet-authelia\n</code></pre> <p>Backend Architecture</p> <p>Authelia uses PostgreSQL for persistent storage (users, OIDC sessions, TOTP secrets) and Redis (Redict) for session caching. This is more robust than file-based storage.</p>"},{"location":"infrastructure/authelia/#main-configuration","title":"Main Configuration","text":"<p>Located in <code>compose/core/authelia/config/configuration.yml</code>:</p> <pre><code>server:\n  address: tcp://:9091\n  endpoints:\n    authz:\n      forward-auth:\n        implementation: ForwardAuth  # Traefik integration\n\nauthentication_backend:\n  file:\n    path: /config/users.yml  # Note: users.yml not users_database.yml\n\nstorage:\n  postgres:\n    address: tcp://authelia-db:5432\n    database: {{ env \"POSTGRES_DB\" }}\n    username: {{ env \"POSTGRES_USER\" }}\n\nsession:\n  redis:\n    host: authelia-redict\n    port: 6379\n  cookies:\n    - authelia_url: https://auth.{{ env \"DOMAINNAME\" }}\n      default_redirection_url: https://{{ env \"DOMAINNAME\" }}\n      domain: {{ env \"DOMAINNAME\" }}\n\nnotifier:\n  smtp:\n    address: submissions://${SMTP_SERVER}:${SMTP_PORT}\n    # SMTP configured via environment variables\n\nregulation:\n  ban_time: 5m\n  find_time: 2m\n  max_retries: 3\n\nlog:\n  format: json\n  level: debug\n</code></pre> <p>Template System</p> <p>Configuration uses Go templates (<code>{{ env \"VARIABLE\" }}</code>) for environment variable expansion. This is enabled by <code>X_AUTHELIA_CONFIG_FILTERS: template</code>.</p>"},{"location":"infrastructure/authelia/#users-database","title":"Users Database","text":"<p>Located in <code>compose/core/authelia/config/users.yml</code>:</p> <pre><code>users:\n  john:\n    displayname: \"John Doe\"\n    password: \"$argon2id$...\"  # Generated hash\n    email: john@example.com\n    groups:\n      - admins\n      - users\n\n  jane:\n    displayname: \"Jane Smith\"\n    password: \"$argon2id$...\"\n    email: jane@example.com\n    groups:\n      - users\n</code></pre> <p>Note: File is named <code>users.yml</code>, not <code>users_database.yml</code>.</p>"},{"location":"infrastructure/authelia/#access-control-rules","title":"Access Control Rules","text":"<p>Fine-grained access policies with network-based rules:</p> <pre><code>access_control:\n  default_policy: deny\n\n  # Define named networks\n  networks:\n    - name: internal\n      networks:\n        - 10.0.0.0/8\n        - 172.16.0.0/12\n        - 192.168.0.0/16\n    - name: work\n      networks:\n        - 203.0.113.0/24  # Your public IP range\n\n  rules:\n    # Bypass auth portal itself\n    - domain: auth.{{ env \"DOMAINNAME\" }}\n      policy: bypass\n\n    # Bypass API endpoints (for programmatic access)\n    - domain: '*.{{ env \"DOMAINNAME\" }}'\n      policy: bypass\n      resources:\n        - '^/api$'\n        - '^/api/'\n\n    # Two-factor for Vaultwarden admin\n    - domain: vault.{{ env \"DOMAINNAME\" }}\n      policy: two_factor\n      resources:\n        - '^/admin$'\n      subject:\n        - group:admins\n\n    # Bypass for public services\n    - domain:\n        - docs.{{ env \"DOMAINNAME\" }}\n        - stream.{{ env \"DOMAINNAME\" }}\n        - immich.{{ env \"DOMAINNAME\" }}\n        - vault.{{ env \"DOMAINNAME\" }}\n      policy: bypass\n\n    # Bypass from internal networks\n    - domain: '*.{{ env \"DOMAINNAME\" }}'\n      networks:\n        - internal\n      policy: bypass\n\n    # One-factor from work networks\n    - domain: '*.{{ env \"DOMAINNAME\" }}'\n      networks:\n        - work\n      policy: one_factor\n\n    # Two-factor for everything else\n    - domain: '*.{{ env \"DOMAINNAME\" }}'\n      policy: two_factor\n</code></pre> <p>Network-Based Access Control</p> <p>Rules are evaluated top to bottom. The first matching rule is applied. This configuration:</p> <ol> <li>Bypasses specific public services (docs, stream, immich, vault)</li> <li>Bypasses all services from internal networks (RFC 1918)</li> <li>Requires one-factor from known work networks</li> <li>Requires two-factor from all other locations (default)</li> </ol> <p>API Endpoint Bypass</p> <p>API endpoints (<code>/api</code> and <code>/api/*</code>) are bypassed for programmatic access. Ensure services implement their own API authentication.</p>"},{"location":"infrastructure/authelia/#user-management","title":"User Management","text":""},{"location":"infrastructure/authelia/#add-new-user","title":"Add New User","text":"<ol> <li> <p>Generate password hash:    <pre><code>docker exec authelia authelia crypto hash generate argon2 --password 'your-password'\n</code></pre></p> </li> <li> <p>Add to <code>compose/core/authelia/config/users.yml</code>:    <pre><code>users:\n  newuser:\n    displayname: \"New User\"\n    password: \"$argon2id$...\"\n    email: newuser@example.com\n    groups:\n      - users\n</code></pre></p> </li> <li> <p>Restart Authelia:    <pre><code>docker compose restart authelia\n</code></pre></p> </li> </ol> <p>File-Based Authentication</p> <p>Authelia uses file-based authentication backend. User changes require restarting the container. For production with frequent user changes, consider LDAP or other backends.</p>"},{"location":"infrastructure/authelia/#change-user-password","title":"Change User Password","text":"<ol> <li> <p>Generate new hash:    <pre><code>docker exec authelia authelia crypto hash generate argon2 --password 'new-password'\n</code></pre></p> </li> <li> <p>Update <code>users.yml</code> with new hash</p> </li> <li> <p>Restart Authelia:    <pre><code>docker compose restart authelia\n</code></pre></p> </li> </ol>"},{"location":"infrastructure/authelia/#remove-user","title":"Remove User","text":"<p>Remove user entry from <code>users.yml</code> and restart Authelia.</p> <p>User Data Persistence</p> <p>User accounts are stored in <code>users.yml</code>. User sessions, TOTP secrets, and WebAuthn devices are stored in PostgreSQL. Removing a user from <code>users.yml</code> doesn't automatically clean up their database entries.</p>"},{"location":"infrastructure/authelia/#two-factor-authentication","title":"Two-Factor Authentication","text":""},{"location":"infrastructure/authelia/#totp-time-based-one-time-password","title":"TOTP (Time-based One-Time Password)","text":"<p>Users can enroll TOTP via Authelia portal:</p> <ol> <li>Access: <code>https://auth.yourdomain.com</code></li> <li>Login with username/password</li> <li>Navigate to Two-Factor</li> <li>Scan QR code with authenticator app (Google Authenticator, Authy, etc.)</li> </ol>"},{"location":"infrastructure/authelia/#webauthn","title":"WebAuthn","text":"<p>Hardware security keys (YubiKey, etc.):</p> <ol> <li>Access Authelia portal</li> <li>Navigate to WebAuthn</li> <li>Click Add Device</li> <li>Follow browser prompts</li> </ol>"},{"location":"infrastructure/authelia/#duo-push","title":"Duo Push","text":"<p>Configure Duo integration in <code>configuration.yml</code>:</p> <pre><code>duo_api:\n  hostname: api-xxxxx.duosecurity.com\n  integration_key: ${DUO_INTEGRATION_KEY}\n  secret_key: ${DUO_SECRET_KEY}\n</code></pre>"},{"location":"infrastructure/authelia/#integration-with-services","title":"Integration with Services","text":""},{"location":"infrastructure/authelia/#traefik-middleware","title":"Traefik Middleware","text":"<p>Services protected by Authelia use Traefik middleware:</p> <pre><code>labels:\n  - traefik.enable=true\n  - traefik.http.routers.myservice.rule=Host(`myservice.${DOMAINNAME}`)\n  - traefik.http.routers.myservice.middlewares=chain-authelia@file\n</code></pre>"},{"location":"infrastructure/authelia/#bypass-authentication","title":"Bypass Authentication","text":"<p>For services with own authentication:</p> <pre><code>labels:\n  - traefik.http.routers.myservice.middlewares=chain-no-auth@file\n</code></pre> <p>Or configure in Authelia access rules:</p> <pre><code>access_control:\n  rules:\n    - domain: \"myservice.yourdomain.com\"\n      policy: bypass\n</code></pre>"},{"location":"infrastructure/authelia/#api-access","title":"API Access","text":"<p>For programmatic access:</p> <pre><code>access_control:\n  rules:\n    - domain: \"api.yourdomain.com\"\n      resources:\n        - \"^/api/.*$\"\n      policy: bypass\n</code></pre>"},{"location":"infrastructure/authelia/#session-management","title":"Session Management","text":""},{"location":"infrastructure/authelia/#session-storage","title":"Session Storage","text":"<p>Authelia uses Redis (Redict) for session storage. The Redis instance is dedicated to Authelia and runs on the <code>vnet-authelia</code> network:</p> <pre><code>session:\n  redis:\n    host: authelia-redict  # Service name\n    port: 6379\n</code></pre> <p>The <code>authelia-redict</code> service extends the common <code>redict</code> base service with security hardening and resource limits.</p>"},{"location":"infrastructure/authelia/#session-timeout","title":"Session Timeout","text":"<p>Configure in <code>configuration.yml</code>:</p> <pre><code>session:\n  expiration: 1h        # Total session duration\n  inactivity: 5m        # Idle timeout\n  remember_me_duration: 30d  # \"Remember me\" duration\n</code></pre>"},{"location":"infrastructure/authelia/#logout","title":"Logout","text":"<p>Users can logout from: <code>https://auth.yourdomain.com/logout</code></p> <p>Or configure logout buttons in services to redirect to logout URL.</p>"},{"location":"infrastructure/authelia/#password-reset","title":"Password Reset","text":""},{"location":"infrastructure/authelia/#smtp-configuration","title":"SMTP Configuration","text":"<p>Enable password reset via email:</p> <pre><code>notifier:\n  smtp:\n    host: smtp.gmail.com\n    port: 587\n    username: ${SMTP_USERNAME}\n    password: ${SMTP_PASSWORD}\n    sender: authelia@yourdomain.com\n    subject: \"[Authelia] {title}\"\n</code></pre> <p>Store credentials in Infisical.</p>"},{"location":"infrastructure/authelia/#reset-flow","title":"Reset Flow","text":"<ol> <li>User clicks \"Forgot password\" on login page</li> <li>Enters email address</li> <li>Receives reset link via email</li> <li>Sets new password</li> <li>Password hash updated in PostgreSQL database (user data persists across restarts)</li> </ol>"},{"location":"infrastructure/authelia/#monitoring","title":"Monitoring","text":""},{"location":"infrastructure/authelia/#access-logs","title":"Access Logs","text":"<p>View authentication attempts:</p> <pre><code>docker compose logs authelia | grep \"authentication\"\n</code></pre>"},{"location":"infrastructure/authelia/#failed-logins","title":"Failed Logins","text":"<p>Monitor failed login attempts:</p> <pre><code>docker compose logs authelia | grep \"failed\"\n</code></pre>"},{"location":"infrastructure/authelia/#active-sessions","title":"Active Sessions","text":"<p>Check Redis for active sessions:</p> <pre><code>docker exec authelia-redict redis-cli keys \"authelia-session*\"\n</code></pre>"},{"location":"infrastructure/authelia/#troubleshooting","title":"Troubleshooting","text":""},{"location":"infrastructure/authelia/#cant-login","title":"Can't Login","text":"<p>Check credentials: <pre><code># Verify user exists\ndocker exec authelia cat /config/users.yml | grep username\n</code></pre></p> <p>Verify password hash: <pre><code># Generate test hash\ndocker exec authelia authelia crypto hash generate argon2 --password 'test-password'\n</code></pre></p> <p>Check logs: <pre><code>docker compose logs authelia | tail -50\n</code></pre></p>"},{"location":"infrastructure/authelia/#redirect-loop","title":"Redirect Loop","text":"<p>Check Traefik configuration: - Ensure middleware chain is correctly configured - Verify service is on <code>ingress</code> network</p> <p>Check Authelia URL: - Must be accessible at <code>https://auth.yourdomain.com</code></p>"},{"location":"infrastructure/authelia/#2fa-not-working","title":"2FA Not Working","text":"<p>Check time sync: <pre><code># TOTP requires accurate time\ndocker exec authelia date\n</code></pre></p> <p>Time must be synchronized (use NTP).</p> <p>Reset 2FA:</p> <p>Remove 2FA config from user's session in Redis: <pre><code># Connect to Authelia's Redis instance\ndocker exec authelia-redict redis-cli del \"authelia-session:username\"\n</code></pre></p>"},{"location":"infrastructure/authelia/#email-not-sending","title":"Email Not Sending","text":"<p>Test SMTP: <pre><code>docker exec authelia authelia crypto hash generate argon2 --password 'test'\n</code></pre></p> <p>Check SMTP logs in Authelia.</p>"},{"location":"infrastructure/authelia/#security-best-practices","title":"Security Best Practices","text":"<ol> <li>Use strong passwords - Enforce password complexity</li> <li>Enable 2FA - Require for admin accounts</li> <li>Limit access - Use access control rules</li> <li>Monitor logs - Review authentication logs regularly</li> <li>Rotate secrets - Change passwords periodically</li> <li>Backup users database - Include in backup strategy</li> <li>Use HTTPS only - Never access over HTTP</li> </ol>"},{"location":"infrastructure/authelia/#access-control-patterns","title":"Access Control Patterns","text":""},{"location":"infrastructure/authelia/#public-service","title":"Public Service","text":"<pre><code>- domain: \"public.yourdomain.com\"\n  policy: bypass\n</code></pre>"},{"location":"infrastructure/authelia/#admin-only-service","title":"Admin-Only Service","text":"<pre><code>- domain: \"admin.yourdomain.com\"\n  policy: two_factor\n  subject:\n    - \"group:admins\"\n</code></pre>"},{"location":"infrastructure/authelia/#group-based-access","title":"Group-Based Access","text":"<pre><code>- domain: \"developers.yourdomain.com\"\n  policy: one_factor\n  subject:\n    - \"group:developers\"\n    - \"group:admins\"\n</code></pre>"},{"location":"infrastructure/authelia/#network-based-access","title":"Network-Based Access","text":"<pre><code>- domain: \"internal.yourdomain.com\"\n  policy: bypass\n  networks:\n    - 192.168.1.0/24\n</code></pre>"},{"location":"infrastructure/authelia/#path-based-access","title":"Path-Based Access","text":"<pre><code>- domain: \"app.yourdomain.com\"\n  policy: bypass\n  resources:\n    - \"^/public/.*$\"\n\n- domain: \"app.yourdomain.com\"\n  policy: two_factor\n  resources:\n    - \"^/admin/.*$\"\n</code></pre>"},{"location":"infrastructure/authelia/#advanced-configuration","title":"Advanced Configuration","text":""},{"location":"infrastructure/authelia/#ldap-backend","title":"LDAP Backend","text":"<p>For integration with Active Directory:</p> <pre><code>authentication_backend:\n  ldap:\n    url: ldap://ldap.yourdomain.com\n    base_dn: dc=yourdomain,dc=com\n    username_attribute: uid\n    additional_users_dn: ou=users\n    users_filter: (&amp;({username_attribute}={input})(objectClass=person))\n</code></pre>"},{"location":"infrastructure/authelia/#openid-connect-oidc","title":"OpenID Connect (OIDC)","text":"<p>Authelia provides centralized OIDC/SSO for applications, eliminating the need for separate authentication in each service.</p>"},{"location":"infrastructure/authelia/#centralized-client-management","title":"Centralized Client Management","text":"<p>OIDC clients are managed using a modular, file-based system for maintainability:</p> <p>Architecture: <pre><code>compose/core/authelia/config/\n\u251c\u2500\u2500 configuration.yml          # Main config (references oidc-clients.yml)\n\u251c\u2500\u2500 oidc-clients.yml          # Centralized client list\n\u251c\u2500\u2500 oidc.d/                   # Individual client definitions\n\u2502   \u251c\u2500\u2500 pgadmin               # pgAdmin OIDC client\n\u2502   \u251c\u2500\u2500 vikunja               # Vikunja OIDC client\n\u2502   \u2514\u2500\u2500 &lt;service&gt;             # Additional clients\n\u2514\u2500\u2500 users.yml                 # User database\n</code></pre></p> <p>How it works:</p> <ol> <li>Each service has its own file in <code>oidc.d/&lt;service-name&gt;</code></li> <li><code>oidc-clients.yml</code> includes all client files</li> <li><code>configuration.yml</code> references <code>oidc-clients.yml</code></li> </ol> <p>In <code>configuration.yml</code>: <pre><code>identity_providers:\n  oidc:\n    clients:\n      {{- fileContent \"/config/oidc-clients.yml\" | nindent 6 }}\n    cors:\n      allowed_origins:\n        - https://{{ env \"DOMAINNAME\"}}\n    hmac_secret: '{{ env \"IDENTITY_PROVIDERS_OIDC_HMAC_SECRET\" }}'\n    jwks:\n      - key: |\n          {{- env \"IDENTITY_PROVIDERS_OIDC_JWKS\" | nindent 9 }}\n    lifespans:\n      access_token: 1h\n      authorize_code: 1m\n      id_token: 1h\n      refresh_token: 90m\n</code></pre></p> <p>In <code>oidc-clients.yml</code>: <pre><code># Infrastructure Services\n{{- fileContent \"/config/oidc.d/pgadmin\" | expandenv | nindent 0 }}\n\n# Productivity Services\n{{- fileContent \"/config/oidc.d/vikunja\" | expandenv | nindent 0 }}\n\n# Add new clients here\n</code></pre></p>"},{"location":"infrastructure/authelia/#adding-a-new-oidc-client","title":"Adding a New OIDC Client","text":"<p>Use the helper script for automated setup:</p> <pre><code># Navigate to scripts directory\ncd compose/core/authelia/scripts\n\n# Run the helper script\n./add-oidc-client.sh &lt;service-name&gt; '&lt;Display Name&gt;' '&lt;redirect-uri&gt;'\n\n# Example:\n./add-oidc-client.sh nextcloud 'Nextcloud' 'https://cloud.yourdomain.com/apps/user_oidc/code'\n</code></pre> <p>The script will: 1. Generate a secure random client secret 2. Hash it with Authelia's argon2id hasher 3. Create the client file in <code>oidc.d/&lt;service&gt;</code> 4. Provide secrets to add to Infisical 5. Show the line to add to <code>oidc-clients.yml</code></p> <p>Manual Process (if script not available):</p> <ol> <li> <p>Generate and hash client secret:    <pre><code># Generate secret\nCLIENT_SECRET=$(openssl rand -base64 32)\n\n# Hash with Authelia's tool\ndocker run --rm authelia/authelia:latest \\\n  authelia crypto hash generate argon2 --password \"$CLIENT_SECRET\"\n</code></pre></p> </li> <li> <p>Add secrets to Infisical:    <pre><code>OIDC_&lt;SERVICE&gt;_CLIENT_ID=&lt;service-name&gt;\nOIDC_&lt;SERVICE&gt;_CLIENT_SECRET_DIGEST='$argon2id$v=19$...'\n</code></pre></p> </li> <li> <p>Create client file <code>compose/core/authelia/config/oidc.d/&lt;service&gt;</code>:    <pre><code>- authorization_policy: 'two_factor'\n  client_id: '${OIDC_&lt;SERVICE&gt;_CLIENT_ID}'\n  client_name: '&lt;Service Display Name&gt;'\n  client_secret: '${OIDC_&lt;SERVICE&gt;_CLIENT_SECRET_DIGEST}'\n  public: false\n  redirect_uris:\n    - 'https://&lt;service&gt;.${DOMAINNAME}/&lt;callback-path&gt;'\n  scopes:\n    - email\n    - openid\n    - profile\n  token_endpoint_auth_method: 'client_secret_post'\n  userinfo_signed_response_alg: 'none'\n</code></pre></p> </li> <li> <p>Add to <code>oidc-clients.yml</code>:    <pre><code># Service Name - Description\n{{- fileContent \"/config/oidc.d/&lt;service&gt;\" | expandenv | nindent 0 }}\n</code></pre></p> </li> <li> <p>Restart Authelia:    <pre><code>docker compose restart authelia\n</code></pre></p> </li> </ol>"},{"location":"infrastructure/authelia/#oidc-client-configuration-options","title":"OIDC Client Configuration Options","text":"<p>Authorization Policies: - <code>two_factor</code>: Requires 2FA (recommended for sensitive services) - <code>one_factor</code>: Username/password only</p> <p>Client Types: - <code>public: false</code>: Confidential client with secret (most services) - <code>public: true</code>: Public client without secret (SPAs, mobile apps)</p> <p>Token Endpoint Auth Methods: - <code>client_secret_post</code>: Secret in POST body (recommended) - <code>client_secret_basic</code>: Secret in HTTP Basic Auth header</p> <p>Common Scopes: - <code>openid</code>: Required for OIDC - <code>email</code>: User's email address - <code>profile</code>: User's display name - <code>groups</code>: User's group memberships</p>"},{"location":"infrastructure/authelia/#oidc-discovery-endpoints","title":"OIDC Discovery Endpoints","text":"<p>Configure services with these endpoints:</p> <ul> <li>Discovery: <code>https://auth.yourdomain.com/.well-known/openid-configuration</code></li> <li>Authorization: <code>https://auth.yourdomain.com/api/oidc/authorization</code></li> <li>Token: <code>https://auth.yourdomain.com/api/oidc/token</code></li> <li>Userinfo: <code>https://auth.yourdomain.com/api/oidc/userinfo</code></li> <li>JWKS: <code>https://auth.yourdomain.com/jwks.json</code></li> </ul>"},{"location":"infrastructure/authelia/#troubleshooting-oidc","title":"Troubleshooting OIDC","text":"<p>Client not appearing: <pre><code># Verify configuration syntax\ndocker compose config | grep -A 20 \"identity_providers\"\n\n# Check secrets loaded\ndocker compose exec authelia env | grep OIDC_\n\n# Check logs for errors\ndocker compose logs authelia | grep -i oidc\n</code></pre></p> <p>Authentication failures: - Verify redirect URI matches exactly (including trailing slash) - Check authorization policy requirements (one_factor vs two_factor) - Verify client secret was hashed correctly (never use plain text) - Check CORS settings match service domain</p> <p>Test OIDC discovery: <pre><code>curl https://auth.yourdomain.com/.well-known/openid-configuration | jq\n</code></pre></p>"},{"location":"infrastructure/authelia/#rate-limiting","title":"Rate Limiting","text":"<p>Prevent brute-force attacks:</p> <pre><code>regulation:\n  max_retries: 3\n  find_time: 2m\n  ban_time: 5m\n</code></pre>"},{"location":"infrastructure/authelia/#required-secrets-in-infisical","title":"Required Secrets in Infisical","text":"<p>Authelia requires the following secrets to be configured in Infisical vault:</p>"},{"location":"infrastructure/authelia/#core-secrets","title":"Core Secrets","text":"<pre><code># Session encryption\nAUTHELIA_SESSION_SECRET           # Random string (64+ chars)\n\n# Database encryption key\nAUTHELIA_STORAGE_ENCRYPTION_KEY   # Random string (64+ chars)\n\n# Database credentials\nAUTHELIA_DB_NAME                  # Database name (default: authelia_db)\nAUTHELIA_DB_USER                  # Database user (default: authelia)\nAUTHELIA_DB_PASS                  # Database password\n\n# Password reset JWT secret\nAUTHELIA_IDENTITY_VALIDATION_RESET_PASSWORD_JWT_SECRET  # Random string (64+ chars)\n</code></pre>"},{"location":"infrastructure/authelia/#oidc-secrets","title":"OIDC Secrets","text":"<pre><code># OIDC provider secrets\nIDENTITY_PROVIDERS_OIDC_HMAC_SECRET  # Random string (64+ chars)\nIDENTITY_PROVIDERS_OIDC_JWKS         # RSA private key in PEM format\n</code></pre> <p>Generate OIDC JWKS: <pre><code># Generate RSA private key\ndocker run --rm authelia/authelia:latest \\\n  authelia crypto certificate rsa generate --bits 4096\n</code></pre></p>"},{"location":"infrastructure/authelia/#smtp-secrets-optional","title":"SMTP Secrets (Optional)","text":"<p>For password reset and notifications:</p> <pre><code>SMTP_SERVER        # SMTP server address\nSMTP_PORT          # SMTP port (587 for TLS, 465 for SSL)\nSMTP_USERNAME      # SMTP authentication username\nSMTP_PASSWORD      # SMTP authentication password\n</code></pre>"},{"location":"infrastructure/authelia/#oidc-client-secrets","title":"OIDC Client Secrets","text":"<p>For each OIDC client, add:</p> <pre><code># Pattern: OIDC_&lt;SERVICE&gt;_CLIENT_ID and OIDC_&lt;SERVICE&gt;_CLIENT_SECRET_DIGEST\nOIDC_PGADMIN_CLIENT_ID='pgadmin'\nOIDC_PGADMIN_CLIENT_SECRET_DIGEST='$argon2id$v=19$...'\n\nOIDC_VIKUNJA_CLIENT_ID='vikunja'\nOIDC_VIKUNJA_CLIENT_SECRET_DIGEST='$argon2id$v=19$...'\n</code></pre> <p>Generating Secrets</p> <p>Use Authelia's built-in tools for generating and hashing secrets:</p> <pre><code># Generate random secret\ndocker run --rm authelia/authelia:latest \\\n  authelia crypto rand --length 64 --charset alphanumeric\n\n# Hash password/secret with argon2id\ndocker run --rm authelia/authelia:latest \\\n  authelia crypto hash generate argon2 --password 'your-secret-here'\n</code></pre>"},{"location":"infrastructure/authelia/#see-also","title":"See Also","text":"<ul> <li>Traefik - Reverse proxy integration</li> <li>CrowdSec - Intrusion prevention system</li> <li>OIDC Management Guide - Detailed OIDC setup</li> <li>Security Best Practices - Security guidelines</li> <li>User Management - User maintenance</li> </ul>"},{"location":"infrastructure/cetusguard/","title":"Cetusguard","text":"<p>Cetusguard is a Docker socket proxy that provides secure, read-only access to the Docker API.</p>"},{"location":"infrastructure/cetusguard/#overview","title":"Overview","text":"<p>Cetusguard provides: - Docker API proxy - Safe access to Docker socket - Read-only by default - Prevents destructive operations - Filtered endpoints - Only exposes necessary APIs - Security isolation - Never expose raw Docker socket - Network-based access - Services connect via dedicated network</p>"},{"location":"infrastructure/cetusguard/#why-cetusguard","title":"Why Cetusguard?","text":"<p>Problem: Many services (Portainer, Homepage, Dozzle) need Docker API access. Directly mounting Docker socket (<code>/var/run/docker.sock</code>) gives full root access to the host.</p> <p>Solution: Cetusguard proxies Docker API with: - Read-only access - Filtered endpoints - Network isolation - Audit logging</p>"},{"location":"infrastructure/cetusguard/#configuration","title":"Configuration","text":""},{"location":"infrastructure/cetusguard/#basic-setup","title":"Basic Setup","text":"<p>Located in <code>compose/core/cetusguard/compose.yaml</code>:</p> <pre><code>services:\n  cetusguard:\n    image: docker.io/hectorm/cetusguard:v1.1.2\n    container_name: cetusguard\n    extends:\n      file: ../common/compose.yaml\n      service: base  # Includes: restart, no-new-privileges, etc.\n    privileged: true  # Required for Docker socket access\n    read_only: true   # Container filesystem read-only\n    mem_limit: 64M\n    mem_reservation: 32M\n    networks:\n      - vnet-socket\n    volumes:\n      - /var/run/docker.sock:/var/run/docker.sock:ro\n    expose:\n      - 2375  # Not exposed to host, only to vnet-socket network\n    environment:\n      CETUSGUARD_BACKEND_ADDR: unix:///var/run/docker.sock\n      CETUSGUARD_FRONTEND_ADDR: tcp://:2375\n      CETUSGUARD_LOG_LEVEL: '7'  # Debug level\n      CETUSGUARD_RULES: |\n        GET %API_PREFIX_EVENTS%\n        GET,HEAD,POST %API_PREFIX_EXEC%(/.*)?\n        GET,HEAD,POST %API_PREFIX_CONTAINERS%(/.*)?\n        GET,HEAD %API_PREFIX_IMAGES%(/.*)?\n        GET,HEAD %API_PREFIX_VOLUMES%(/.*)?\n        GET,HEAD %API_PREFIX_NETWORKS%(/.*)?\n        GET,HEAD %API_PREFIX_BUILD%(/.*)?\n\nnetworks:\n  vnet-socket:\n    name: vnet-socket\n    driver: bridge\n    ipam:\n      config:\n        - subnet: 192.168.91.0/24\n</code></pre> <p>Privileged Mode Required</p> <p>Cetusguard runs in privileged mode to access the Docker socket. This is necessary for socket proxying but the container filesystem is read-only and it's isolated on a dedicated network.</p> <p>Rule-Based Access Control</p> <p>Cetusguard uses a rules-based system instead of simple read-only mode. Rules define which HTTP methods are allowed for which API endpoints using pattern matching with API prefix variables.</p>"},{"location":"infrastructure/cetusguard/#service-integration","title":"Service Integration","text":""},{"location":"infrastructure/cetusguard/#monitoring-tools","title":"Monitoring Tools","text":"<p>Services that need Docker API access:</p> <p>Portainer: <pre><code>services:\n  portainer:\n    environment:\n      DOCKER_HOST: tcp://cetusguard:2375\n    networks:\n      - vnet-socket\n</code></pre></p> <p>Homepage: <pre><code>services:\n  homepage:\n    environment:\n      DOCKER_HOST: tcp://cetusguard:2375\n    networks:\n      - vnet-socket\n</code></pre></p> <p>Dozzle: <pre><code>services:\n  dozzle:\n    environment:\n      DOCKER_HOST: tcp://cetusguard:2375\n    networks:\n      - vnet-socket\n</code></pre></p>"},{"location":"infrastructure/cetusguard/#network-configuration","title":"Network Configuration","text":"<p>All services needing Docker API:</p> <ol> <li>Connect to <code>vnet-socket</code> network</li> <li>Set <code>DOCKER_HOST=tcp://cetusguard:2375</code></li> <li>Never mount Docker socket directly</li> </ol> <pre><code>services:\n  myservice:\n    networks:\n      - vnet-ingress  # For web access via Traefik\n      - vnet-socket   # For Docker API via Cetusguard\n    environment:\n      DOCKER_HOST: tcp://cetusguard:2375\n</code></pre>"},{"location":"infrastructure/cetusguard/#permissions-rules","title":"Permissions &amp; Rules","text":""},{"location":"infrastructure/cetusguard/#rule-based-access-control","title":"Rule-Based Access Control","text":"<p>Cetusguard uses a rules-based system with pattern matching:</p> <pre><code>CETUSGUARD_RULES: |\n  GET %API_PREFIX_EVENTS%                        # Event stream\n  GET,HEAD,POST %API_PREFIX_EXEC%(/.*)?         # Container exec\n  GET,HEAD,POST %API_PREFIX_CONTAINERS%(/.*)?   # Container operations\n  GET,HEAD %API_PREFIX_IMAGES%(/.*)?            # Image read-only\n  GET,HEAD %API_PREFIX_VOLUMES%(/.*)?           # Volume read-only\n  GET,HEAD %API_PREFIX_NETWORKS%(/.*)?          # Network read-only\n  GET,HEAD %API_PREFIX_BUILD%(/.*)?             # Build read-only\n</code></pre>"},{"location":"infrastructure/cetusguard/#api-prefix-variables","title":"API Prefix Variables","text":"<p>Cetusguard uses variables for API versioning:</p> <ul> <li><code>%API_PREFIX_EVENTS%</code> \u2192 <code>/events</code>, <code>/v1.*/events</code></li> <li><code>%API_PREFIX_EXEC%</code> \u2192 <code>/containers/.*/exec</code>, <code>/v1.*/containers/.*/exec</code></li> <li><code>%API_PREFIX_CONTAINERS%</code> \u2192 <code>/containers</code>, <code>/v1.*/containers</code></li> <li><code>%API_PREFIX_IMAGES%</code> \u2192 <code>/images</code>, <code>/v1.*/images</code></li> <li><code>%API_PREFIX_VOLUMES%</code> \u2192 <code>/volumes</code>, <code>/v1.*/volumes</code></li> <li><code>%API_PREFIX_NETWORKS%</code> \u2192 <code>/networks</code>, <code>/v1.*/networks</code></li> <li><code>%API_PREFIX_BUILD%</code> \u2192 <code>/build</code>, <code>/v1.*/build</code></li> </ul>"},{"location":"infrastructure/cetusguard/#allowed-operations","title":"Allowed Operations","text":"<p>Based on the rules configuration:</p> <p>Read Operations (GET, HEAD): - \u2705 List/inspect containers - \u2705 View container logs - \u2705 List/inspect images - \u2705 List/inspect volumes - \u2705 List/inspect networks - \u2705 Event stream monitoring - \u2705 Build information</p> <p>Write Operations (POST): - \u2705 Container exec (for interactive shells) - \u2705 Container operations (start, stop, restart, pause, unpause) - \u2705 Container creation (for management tools)</p> <p>Blocked Operations: - \u274c DELETE operations (cannot delete containers, images, etc.) - \u274c Image pull/push - \u274c PUT operations (cannot update configs)</p> <p>POST Operations Allowed</p> <p>Unlike typical \"read-only\" proxies, this configuration allows POST operations on containers and exec endpoints. This is necessary for management tools like Portainer to function properly, but it means services can start/stop containers and execute commands.</p>"},{"location":"infrastructure/cetusguard/#modifying-rules","title":"Modifying Rules","text":"<p>To restrict further, edit the rules:</p> <pre><code># Example: True read-only (no POST operations)\nCETUSGUARD_RULES: |\n  GET %API_PREFIX_EVENTS%\n  GET,HEAD %API_PREFIX_EXEC%(/.*)?\n  GET,HEAD %API_PREFIX_CONTAINERS%(/.*)?\n  GET,HEAD %API_PREFIX_IMAGES%(/.*)?\n  GET,HEAD %API_PREFIX_VOLUMES%(/.*)?\n  GET,HEAD %API_PREFIX_NETWORKS%(/.*)?\n  GET,HEAD %API_PREFIX_BUILD%(/.*)?\n</code></pre> <pre><code># Example: Allow specific operations only\nCETUSGUARD_RULES: |\n  GET %API_PREFIX_CONTAINERS%/json              # List only\n  GET %API_PREFIX_CONTAINERS%/.*/json          # Inspect only\n  GET %API_PREFIX_CONTAINERS%/.*/logs          # Logs only\n  GET %API_PREFIX_IMAGES%/json                  # Image list only\n</code></pre>"},{"location":"infrastructure/cetusguard/#security","title":"Security","text":""},{"location":"infrastructure/cetusguard/#security-options","title":"Security Options","text":"<p>Cetusguard configuration includes:</p> <pre><code>extends:\n  file: ../common/compose.yaml\n  service: base  # Includes no-new-privileges:true\nprivileged: true     # Required for Docker socket\nread_only: true      # Container filesystem read-only\nmem_limit: 64M       # Memory constraint\nmem_reservation: 32M # Reserved memory\n</code></pre> <p>Privileged Mode Caveat</p> <p>While Cetusguard runs in privileged mode (required for Docker socket access), security is maintained through:</p> <ul> <li>\u2705 Read-only container filesystem</li> <li>\u2705 Network isolation (<code>vnet-socket</code> only)</li> <li>\u2705 Rule-based API filtering</li> <li>\u2705 Memory limits</li> <li>\u2705 Docker socket mounted read-only</li> <li>\u2705 No host network access</li> <li>\u2705 Not exposed to external network</li> </ul>"},{"location":"infrastructure/cetusguard/#network-isolation","title":"Network Isolation","text":"<p>Cetusguard on dedicated network: - Only monitoring tools connect - No direct external access - No connection to other service networks</p> <pre><code>networks:\n  vnet-socket:\n    name: vnet-socket\n    driver: bridge\n    ipam:\n      config:\n        - subnet: 192.168.91.0/24\n</code></pre>"},{"location":"infrastructure/cetusguard/#socket-mounting","title":"Socket Mounting","text":"<p>Mount Docker socket read-only:</p> <pre><code>volumes:\n  - /var/run/docker.sock:/var/run/docker.sock:ro\n</code></pre>"},{"location":"infrastructure/cetusguard/#monitoring","title":"Monitoring","text":""},{"location":"infrastructure/cetusguard/#check-cetusguard-status","title":"Check Cetusguard Status","text":"<pre><code># Verify running\ndocker compose ps cetusguard\n\n# View logs\ndocker compose logs cetusguard\n\n# Test connection\ncurl http://cetusguard:2375/version\n</code></pre>"},{"location":"infrastructure/cetusguard/#api-access-test","title":"API Access Test","text":"<p>From service container:</p> <pre><code># List containers (allowed)\ndocker exec myservice curl http://cetusguard:2375/v1.43/containers/json\n\n# Try container start (allowed by rules)\ndocker exec myservice curl -X POST http://cetusguard:2375/v1.43/containers/{id}/start\n\n# Try delete operation (should fail - not in rules)\ndocker exec myservice curl -X DELETE http://cetusguard:2375/v1.43/containers/{id}\n\n# Try image pull (should fail - POST not allowed for images)\ndocker exec myservice curl -X POST http://cetusguard:2375/v1.43/images/create\n</code></pre>"},{"location":"infrastructure/cetusguard/#audit-logs","title":"Audit Logs","text":"<p>Monitor API requests:</p> <pre><code>docker compose logs cetusguard | grep \"method=POST\"\n</code></pre>"},{"location":"infrastructure/cetusguard/#troubleshooting","title":"Troubleshooting","text":""},{"location":"infrastructure/cetusguard/#service-cant-connect","title":"Service Can't Connect","text":"<p>Check network: <pre><code>docker network inspect vnet-socket\n</code></pre></p> <p>Verify both Cetusguard and service are on network.</p> <p>Check environment variable: <pre><code>docker exec myservice env | grep DOCKER_HOST\n</code></pre></p> <p>Should show: <code>DOCKER_HOST=tcp://cetusguard:2375</code></p> <p>Test connectivity: <pre><code>docker exec myservice ping cetusguard\ndocker exec myservice curl http://cetusguard:2375/version\n</code></pre></p>"},{"location":"infrastructure/cetusguard/#permission-denied","title":"Permission Denied","text":"<p>Expected behavior - Read-only mode blocks write operations.</p> <p>If write access needed: 1. Evaluate if truly necessary 2. Use allowlist for specific endpoints 3. Document why needed 4. Consider alternative solutions</p>"},{"location":"infrastructure/cetusguard/#api-version-mismatch","title":"API Version Mismatch","text":"<p>If service reports API version incompatibility:</p> <p>Check Docker API version: <pre><code>docker version --format '{{.Server.APIVersion}}'\n</code></pre></p> <p>Update service configuration to use correct API version: <pre><code>environment:\n  DOCKER_API_VERSION: \"1.43\"\n</code></pre></p>"},{"location":"infrastructure/cetusguard/#advanced-configuration","title":"Advanced Configuration","text":""},{"location":"infrastructure/cetusguard/#custom-rules","title":"Custom Rules","text":"<p>The <code>CETUSGUARD_RULES</code> environment variable uses a pattern-based syntax:</p> <p>Format: <code>&lt;methods&gt; &lt;pattern&gt;</code></p> <p>Examples: <pre><code>CETUSGUARD_RULES: |\n  # Allow GET and HEAD for all container endpoints\n  GET,HEAD %API_PREFIX_CONTAINERS%(/.*)?\n\n  # Allow POST only for specific actions\n  POST %API_PREFIX_CONTAINERS%/.*/start\n  POST %API_PREFIX_CONTAINERS%/.*/stop\n  POST %API_PREFIX_CONTAINERS%/.*/restart\n\n  # Allow exec access (GET for info, POST for execution)\n  GET,POST %API_PREFIX_EXEC%(/.*)?\n\n  # Read-only image access\n  GET,HEAD %API_PREFIX_IMAGES%(/.*)?\n</code></pre></p> <p>Pattern Syntax: - <code>%API_PREFIX_*%</code> - Expands to API paths with version support - <code>(/.*)?</code> - Optional regex for subpaths - <code>.*</code> - Wildcard matching</p>"},{"location":"infrastructure/cetusguard/#log-level","title":"Log Level","text":"<p>Adjust logging verbosity (0-7):</p> <pre><code>CETUSGUARD_LOG_LEVEL: '7'  # Debug (most verbose)\nCETUSGUARD_LOG_LEVEL: '6'  # Info\nCETUSGUARD_LOG_LEVEL: '4'  # Warning\nCETUSGUARD_LOG_LEVEL: '3'  # Error (least verbose)\n</code></pre>"},{"location":"infrastructure/cetusguard/#frontend-address","title":"Frontend Address","text":"<p>Change listening address/port:</p> <pre><code>CETUSGUARD_FRONTEND_ADDR: tcp://:2375      # Default - all interfaces in container\nCETUSGUARD_FRONTEND_ADDR: tcp://0.0.0.0:2375  # Explicit all interfaces\nCETUSGUARD_FRONTEND_ADDR: tcp://127.0.0.1:2375 # Loopback only (less useful in container)\n</code></pre> <p>No Rate Limiting or User-Agent Filtering</p> <p>The current Cetusguard configuration does not implement rate limiting or user-agent filtering. Access control is purely rule-based. All services on <code>vnet-socket</code> have equal access to allowed endpoints.</p>"},{"location":"infrastructure/cetusguard/#comparison-with-alternatives","title":"Comparison with Alternatives","text":""},{"location":"infrastructure/cetusguard/#socket-proxy","title":"Socket Proxy","text":"<p>Cetusguard advantages: - Actively maintained - More secure defaults - Better filtering capabilities - Modern architecture</p>"},{"location":"infrastructure/cetusguard/#tecnativa-docker-socket-proxy","title":"Tecnativa Docker Socket Proxy","text":"<p>Alternative option:</p> <pre><code>services:\n  socket-proxy:\n    image: tecnativa/docker-socket-proxy\n    environment:\n      CONTAINERS: 1\n      POST: 0\n</code></pre> <p>Cetusguard preferred for: - Better documentation - More granular control - Active development</p>"},{"location":"infrastructure/cetusguard/#best-practices","title":"Best Practices","text":"<ol> <li>Never expose Docker socket directly - Always use proxy</li> <li>Use read-only mode - Enable write only when necessary</li> <li>Dedicated network - Isolate socket access</li> <li>Audit access - Monitor logs for suspicious activity</li> <li>Minimal permissions - Only grant needed API access</li> <li>Regular updates - Keep Cetusguard updated</li> <li>Document exceptions - Note why write access granted</li> </ol>"},{"location":"infrastructure/cetusguard/#security-implications","title":"Security Implications","text":""},{"location":"infrastructure/cetusguard/#risk-without-proxy","title":"Risk Without Proxy","text":"<p>Direct Docker socket access (<code>/var/run/docker.sock</code>): - \u26a0\ufe0f Full root access to host - \u26a0\ufe0f Can create privileged containers - \u26a0\ufe0f Can mount host filesystem - \u26a0\ufe0f Can escape to host - \u26a0\ufe0f Complete system compromise</p>"},{"location":"infrastructure/cetusguard/#risk-with-cetusguard-current-configuration","title":"Risk With Cetusguard (Current Configuration)","text":"<p>With POST operations enabled: - \u2705 Network isolated (vnet-socket only) - \u2705 Cannot DELETE containers/images - \u2705 Cannot pull/push images - \u2705 Auditable access (logs) - \u26a0\ufe0f Can start/stop/restart containers - \u26a0\ufe0f Can execute commands in containers - \u26a0\ufe0f Can create new containers (if Portainer-like tools need it)</p> <p>Important Security Considerations</p> <p>The current configuration is not truly read-only. Services with access to Cetusguard can:</p> <ul> <li>Start, stop, restart, pause, unpause containers</li> <li>Execute arbitrary commands in running containers (<code>docker exec</code>)</li> <li>Potentially create containers (depends on exact rule interpretation)</li> </ul> <p>This is a trade-off for functionality (Portainer, management tools). If compromised, a service on <code>vnet-socket</code> could: - Stop critical services - Execute commands in other containers - Cause denial of service</p> <p>Mitigation: - Only trusted services connect to <code>vnet-socket</code> - Monitor Cetusguard logs for suspicious activity - Consider separate Cetusguard instances with different rules for different service tiers - Regularly audit services with Docker API access</p>"},{"location":"infrastructure/cetusguard/#recommended-rule-sets-by-trust-level","title":"Recommended Rule Sets by Trust Level","text":"<p>High Trust (Management Tools): <pre><code># Full management capability\nCETUSGUARD_RULES: |\n  GET %API_PREFIX_EVENTS%\n  GET,HEAD,POST %API_PREFIX_EXEC%(/.*)?\n  GET,HEAD,POST %API_PREFIX_CONTAINERS%(/.*)?\n  GET,HEAD %API_PREFIX_IMAGES%(/.*)?\n</code></pre></p> <p>Medium Trust (Monitoring Tools): <pre><code># Read-only plus exec for troubleshooting\nCETUSGUARD_RULES: |\n  GET %API_PREFIX_EVENTS%\n  GET,HEAD,POST %API_PREFIX_EXEC%(/.*)?\n  GET,HEAD %API_PREFIX_CONTAINERS%(/.*)?\n  GET,HEAD %API_PREFIX_IMAGES%(/.*)?\n</code></pre></p> <p>Low Trust (Display Only): <pre><code># Pure read-only\nCETUSGUARD_RULES: |\n  GET,HEAD %API_PREFIX_CONTAINERS%(/.*)?\n  GET,HEAD %API_PREFIX_IMAGES%(/.*)?\n</code></pre></p>"},{"location":"infrastructure/cetusguard/#migration-from-direct-socket","title":"Migration from Direct Socket","text":"<p>If currently using direct socket mounts:</p> <ol> <li> <p>Deploy Cetusguard:    <pre><code>make up\n</code></pre></p> </li> <li> <p>Update service configurations:    <pre><code># Remove:\n# volumes:\n#   - /var/run/docker.sock:/var/run/docker.sock\n\n# Add:\nnetworks:\n  - vnet-socket\nenvironment:\n  DOCKER_HOST: tcp://cetusguard:2375\n</code></pre></p> </li> <li> <p>Restart services:    <pre><code>docker compose restart myservice\n</code></pre></p> </li> <li> <p>Verify functionality:    <pre><code>docker compose logs myservice\n</code></pre></p> </li> </ol>"},{"location":"infrastructure/cetusguard/#performance","title":"Performance","text":""},{"location":"infrastructure/cetusguard/#resource-limits","title":"Resource Limits","text":"<p>Cetusguard is configured with conservative memory limits:</p> <pre><code>mem_limit: 64M        # Hard limit - container killed if exceeded\nmem_reservation: 32M  # Soft limit - guaranteed memory\n</code></pre> <p>Actual usage: - Typical memory usage: 8-15MB - CPU usage: negligible (&lt;1%) - Startup time: instant</p>"},{"location":"infrastructure/cetusguard/#network-overhead","title":"Network Overhead","text":"<p>Cetusguard adds minimal network overhead: - Latency: &lt;1ms for most operations - Throughput: No significant impact - Connection pooling: Maintains persistent connections</p>"},{"location":"infrastructure/cetusguard/#benchmarking","title":"Benchmarking","text":"<p>Test API response times:</p> <pre><code># Direct socket\ntime docker ps\n\n# Via Cetusguard\ntime docker -H tcp://cetusguard:2375 ps\n</code></pre> <p>Expected difference: 1-5ms (negligible for typical operations).</p>"},{"location":"infrastructure/cetusguard/#see-also","title":"See Also","text":"<ul> <li>Network Architecture - Network design</li> <li>Security Best Practices - Security guidelines</li> <li>Services Index - Available services</li> </ul>"},{"location":"infrastructure/crowdsec/","title":"CrowdSec","text":"<p>CrowdSec is the intrusion prevention system (IPS) that protects Omakase from attacks.</p>"},{"location":"infrastructure/crowdsec/#overview","title":"Overview","text":"<p>CrowdSec provides: - Real-time threat detection - Analyzes logs for attack patterns - Automatic blocking - Bans malicious IPs - Community intelligence - Shares and receives threat intel - Bouncer integration - Enforces decisions in Traefik - Multi-service protection - Protects all web services</p>"},{"location":"infrastructure/crowdsec/#architecture","title":"Architecture","text":""},{"location":"infrastructure/crowdsec/#components","title":"Components","text":"<p>CrowdSec Agent: - Analyzes logs from services - Detects attack patterns - Makes blocking decisions - Shares threat intelligence</p> <p>CrowdSec Bouncer: - Traefik plugin - Queries CrowdSec decisions - Blocks malicious requests - Integrated via Traefik middleware</p>"},{"location":"infrastructure/crowdsec/#configuration","title":"Configuration","text":""},{"location":"infrastructure/crowdsec/#crowdsec-agent","title":"CrowdSec Agent","text":"<p>Located in <code>compose/core/traefik/compose.yaml</code>:</p> <pre><code>services:\n  crowdsec:\n    image: ghcr.io/crowdsecurity/crowdsec:v1.7.3\n    container_name: crowdsec\n    environment:\n      BOUNCER_KEY_TRAEFIK: ${TRAEFIK_CROWDSEC_BOUNCER}\n      COLLECTIONS: |\n        crowdsecurity/appsec-generic-rules\n        crowdsecurity/appsec-virtual-patching\n        crowdsecurity/traefik\n        Dominic-Wagner/vaultwarden\n        LePresidente/authelia\n        openappsec/openappsec\n      CROWDSEC_CTI_API_KEY: ${CROWDSEC_CTI_API_KEY}\n      DOCKER_HOST: \"tcp://cetusguard:2375\"\n      TELEGRAM_BOT_ID: ${TELEGRAM_BOT_ID}\n      TELEGRAM_CHAT_ID: ${TELEGRAM_CHAT_ID}\n    networks:\n      - vnet-traefik\n      - vnet-socket\n    volumes:\n      - ./crowdsec/config.yaml:/etc/crowdsec/config.yaml.local:ro\n      - ./crowdsec/profiles.yaml:/etc/crowdsec/profiles.yaml.local:ro\n      - ./crowdsec/telegram.yaml:/etc/crowdsec/notifications/telegram.yaml:ro\n      - ./crowdsec/ip-whitelist.yaml:/etc/crowdsec/parsers/s02-enrich/ip-whitelist.yaml:ro\n      - ./crowdsec/acquis.d:/etc/crowdsec/acquis.d:ro\n      - ${DATA_DIR}/traefik/crowdsec/data:/var/lib/crowdsec/data\n      - ${DATA_DIR}/traefik/crowdsec/etc:/etc/crowdsec\n</code></pre> <p>Key Configuration Features</p> <ul> <li>Docker Label Parsing: Uses <code>use_container_labels: true</code> to read logs directly from containers</li> <li>AppSec WAF: Includes Application Security (AppSec) with virtual patching</li> <li>CTI Integration: CrowdSec Cyber Threat Intelligence API for enhanced threat detection</li> <li>Cetusguard Proxy: Accesses Docker API via secure proxy</li> <li>Telegram Notifications: Real-time alerts with CTI scores</li> <li>Custom Profiles: Background noise score-based ban duration</li> </ul>"},{"location":"infrastructure/crowdsec/#data-sources","title":"Data Sources","text":"<p>Docker Container Logs (<code>acquis.d/docker.yaml</code>): <pre><code>source: docker\nuse_container_labels: true  # Reads logs from containers with crowdsec.enable label\ncheck_interval: 10s\n</code></pre></p> <p>Containers are monitored when labeled: <pre><code>labels:\n  crowdsec.enable: true\n  crowdsec.labels.type: traefik\n</code></pre></p> <p>AppSec WAF (<code>acquis.d/appsec.yaml</code>): <pre><code>listen_addr: 0.0.0.0:7422\nappsec_config: crowdsecurity/virtual-patching\nname: appsecComponent\nsource: appsec\n</code></pre></p>"},{"location":"infrastructure/crowdsec/#traefik-bouncer","title":"Traefik Bouncer","text":"<p>Configured via Traefik middleware in <code>compose/core/traefik/rules/crowdsec.yml</code>:</p> <pre><code>http:\n  middlewares:\n    crowdsec:\n      plugin:\n        crowdsec-bouncer:\n          enabled: true\n          crowdseclapihost: 'crowdsec:8080'\n          crowdsecappsechost: 'crowdsec:7422'  # AppSec WAF\n          crowdseclapikey: '{{ env \"BOUNCER_KEY_TRAEFIK\" }}'\n          rediscacheenabled: true\n          rediscachehost: 'traefik-redict:6379'\n          clienttrustedips:\n            - \"10.0.0.0/8\"\n            - \"172.16.0.0/12\"\n            - \"192.168.0.0/16\"\n          forwardedheaderstrustedips:\n            - \"10.0.1.1\"  # HAProxy upstream\n</code></pre> <p>Redis Cache</p> <p>The bouncer uses Redis (Redict) for caching decisions, significantly improving performance by reducing API calls to CrowdSec.</p> <p>Applied to all services via middleware chain:</p> <pre><code>labels:\n  - traefik.http.routers.myservice.middlewares=chain-authelia@file\n</code></pre> <p>The <code>chain-authelia</code> middleware includes CrowdSec protection automatically.</p>"},{"location":"infrastructure/crowdsec/#collections","title":"Collections","text":""},{"location":"infrastructure/crowdsec/#install-collections","title":"Install Collections","text":"<p>Collections define attack scenarios to detect:</p> <pre><code># List available collections\ndocker exec crowdsec cscli collections list\n\n# Install collection\ndocker exec crowdsec cscli collections install crowdsecurity/traefik\ndocker exec crowdsec cscli collections install crowdsecurity/http-cve\ndocker exec crowdsec cscli collections install crowdsecurity/whitelist-good-actors\n\n# Update collections\ndocker exec crowdsec cscli collections upgrade --all\n</code></pre>"},{"location":"infrastructure/crowdsec/#pre-installed-collections","title":"Pre-installed Collections","text":"<p>These collections are automatically installed via environment variables:</p> <ul> <li><code>crowdsecurity/appsec-generic-rules</code> - Generic AppSec WAF rules</li> <li><code>crowdsecurity/appsec-virtual-patching</code> - Virtual patching for known vulnerabilities</li> <li><code>crowdsecurity/traefik</code> - Traefik-specific attack patterns</li> <li><code>Dominic-Wagner/vaultwarden</code> - Vaultwarden protection</li> <li><code>LePresidente/authelia</code> - Authelia SSO protection</li> <li><code>openappsec/openappsec</code> - OpenAppSec integration</li> </ul>"},{"location":"infrastructure/crowdsec/#additional-recommended-collections","title":"Additional Recommended Collections","text":"<ul> <li><code>crowdsecurity/http-cve</code> - HTTP CVE exploits</li> <li><code>crowdsecurity/base-http-scenarios</code> - Common HTTP attacks</li> <li><code>crowdsecurity/whitelist-good-actors</code> - Whitelist known good bots</li> <li><code>crowdsecurity/wordpress</code> - WordPress protection (if applicable)</li> </ul>"},{"location":"infrastructure/crowdsec/#decisions-management","title":"Decisions Management","text":""},{"location":"infrastructure/crowdsec/#view-decisions","title":"View Decisions","text":"<p>List active blocks:</p> <pre><code># All decisions\ndocker exec crowdsec cscli decisions list\n\n# Filter by IP\ndocker exec crowdsec cscli decisions list --ip 1.2.3.4\n\n# Filter by type\ndocker exec crowdsec cscli decisions list --type ban\n</code></pre>"},{"location":"infrastructure/crowdsec/#add-decision","title":"Add Decision","text":"<p>Manually block an IP:</p> <pre><code># Ban for 24 hours\ndocker exec crowdsec cscli decisions add --ip 1.2.3.4 --duration 24h --reason \"Manual ban\"\n\n# Ban forever\ndocker exec crowdsec cscli decisions add --ip 1.2.3.4 --duration 0 --reason \"Permanent ban\"\n\n# Ban range\ndocker exec crowdsec cscli decisions add --range 1.2.3.0/24 --duration 24h\n</code></pre>"},{"location":"infrastructure/crowdsec/#remove-decision","title":"Remove Decision","text":"<p>Unblock an IP:</p> <pre><code># Remove specific decision\ndocker exec crowdsec cscli decisions delete --ip 1.2.3.4\n\n# Remove all decisions for IP\ndocker exec crowdsec cscli decisions delete --ip 1.2.3.4 --all\n\n# Remove expired decisions\ndocker exec crowdsec cscli decisions delete --expired\n</code></pre>"},{"location":"infrastructure/crowdsec/#alerts","title":"Alerts","text":""},{"location":"infrastructure/crowdsec/#view-alerts","title":"View Alerts","text":"<p>Alerts show detected attack attempts:</p> <pre><code># List recent alerts\ndocker exec crowdsec cscli alerts list\n\n# Show alert details\ndocker exec crowdsec cscli alerts inspect &lt;alert-id&gt;\n\n# Filter by scenario\ndocker exec crowdsec cscli alerts list --scenario crowdsecurity/http-probing\n</code></pre>"},{"location":"infrastructure/crowdsec/#alert-statistics","title":"Alert Statistics","text":"<pre><code># View alert stats\ndocker exec crowdsec cscli alerts stats\n\n# By scenario\ndocker exec crowdsec cscli alerts stats --scenario\n</code></pre>"},{"location":"infrastructure/crowdsec/#whitelists","title":"Whitelists","text":""},{"location":"infrastructure/crowdsec/#whitelist-ips","title":"Whitelist IPs","text":"<p>Prevent blocking trusted IPs:</p> <pre><code># Add to whitelist\ndocker exec crowdsec cscli decisions add --ip 192.168.1.100 --type whitelist\n\n# Whitelist range\ndocker exec crowdsec cscli decisions add --range 192.168.1.0/24 --type whitelist\n</code></pre>"},{"location":"infrastructure/crowdsec/#whitelist-configuration","title":"Whitelist Configuration","text":"<p>In <code>compose/core/traefik/crowdsec/ip-whitelist.yaml</code>:</p> <pre><code>name: my/whitelists\ndescription: \"Custom whitelist\"\nwhitelist:\n  reason: \"custom whitelist\"\n  cidr:\n    - \"192.168.0.0/16\"  # Private networks\n    - \"172.16.0.0/12\"\n    - \"10.0.0.0/8\"\n</code></pre> <p>RFC 1918 Private Networks</p> <p>By default, all RFC 1918 private networks are whitelisted. Add your public IPs if needed: <pre><code>- \"203.0.113.0/24\"  # Your public IP range\n</code></pre></p>"},{"location":"infrastructure/crowdsec/#cyber-threat-intelligence-cti","title":"Cyber Threat Intelligence (CTI)","text":""},{"location":"infrastructure/crowdsec/#cti-api-integration","title":"CTI API Integration","text":"<p>CrowdSec integrates with the CTI API for enhanced threat detection (<code>config.yaml</code>):</p> <pre><code>api:\n  cti:\n    key: ${CROWDSEC_CTI_API_KEY}\n    cache_timeout: 60m\n    cache_size: 50\n    enabled: true\n    log_level: trace\n</code></pre> <p>CTI provides: - Background Noise Score: Measures how often an IP attacks globally - False Positive Detection: Identifies legitimate services misidentified as threats - Threat Classifications: Categorizes attack types - Attack History: Global attack statistics per IP</p>"},{"location":"infrastructure/crowdsec/#custom-profiles-with-cti","title":"Custom Profiles with CTI","text":"<p>Ban duration based on CTI background noise score (<code>profiles.yaml</code>):</p> <pre><code>name: bn_score\nfilters:\n  - Alert.Remediation == true &amp;&amp; Alert.GetScope() == \"Ip\"\n  - CrowdsecCTI(Alert.GetValue()).GetBackgroundNoiseScore() &gt; 0\n  - !CrowdsecCTI(Alert.GetValue()).IsFalsePositive()\ndecisions:\n  - type: ban\n    duration: 12h\nduration_expr: \"Sprintf('%dm', (240 + (120 * CrowdsecCTI(Alert.GetValue()).GetBackgroundNoiseScore())))\"\n# Formula: 4 hours + 2 hours per background noise score point\n# Max score: 10 = up to 24 hours ban\nnotifications:\n  - telegram\n</code></pre> <p>Default IP remediation (fallback): <pre><code>name: default_ip_remediation\ndecisions:\n  - type: ban\n    duration: 12h\nduration_expr: \"Sprintf('%dh', (GetDecisionsCount(Alert.GetValue()) + 1) * 12)\"\n# Progressive bans: 12h, 24h, 36h, etc.\nnotifications:\n  - telegram\n</code></pre></p>"},{"location":"infrastructure/crowdsec/#notifications","title":"Notifications","text":""},{"location":"infrastructure/crowdsec/#telegram-alerts","title":"Telegram Alerts","text":"<p>Real-time notifications configured in <code>telegram.yaml</code>:</p> <pre><code>type: http\nname: telegram\nurl: https://api.telegram.org/bot${TELEGRAM_BOT_ID}/sendMessage\n</code></pre> <p>Alert format includes: - Banned IP address - Action type and duration - Triggering scenario - CTI scores (overall, last day, week, month) - Threat classifications - Links to Shodan and CrowdSec CTI</p> <p>Setup: 1. Create Telegram bot via @BotFather 2. Get bot token (TELEGRAM_BOT_ID) 3. Get chat ID (TELEGRAM_CHAT_ID) 4. Add to Infisical secrets 5. Restart CrowdSec</p>"},{"location":"infrastructure/crowdsec/#hub-management","title":"Hub Management","text":""},{"location":"infrastructure/crowdsec/#browse-hub","title":"Browse Hub","text":"<p>CrowdSec Hub contains collections, scenarios, and parsers:</p> <pre><code># List all hub items\ndocker exec crowdsec cscli hub list\n\n# Search hub\ndocker exec crowdsec cscli hub search wordpress\n\n# Update hub\ndocker exec crowdsec cscli hub update\n</code></pre>"},{"location":"infrastructure/crowdsec/#install-scenarios","title":"Install Scenarios","text":"<pre><code># Install specific scenario\ndocker exec crowdsec cscli scenarios install crowdsecurity/http-bad-user-agent\n\n# List installed scenarios\ndocker exec crowdsec cscli scenarios list\n\n# Upgrade scenarios\ndocker exec crowdsec cscli scenarios upgrade --all\n</code></pre>"},{"location":"infrastructure/crowdsec/#install-parsers","title":"Install Parsers","text":"<pre><code># Install parser\ndocker exec crowdsec cscli parsers install crowdsecurity/nginx-logs\n\n# List parsers\ndocker exec crowdsec cscli parsers list\n</code></pre>"},{"location":"infrastructure/crowdsec/#application-security-appsec-waf","title":"Application Security (AppSec) WAF","text":""},{"location":"infrastructure/crowdsec/#appsec-component","title":"AppSec Component","text":"<p>CrowdSec includes a Web Application Firewall (WAF) with virtual patching:</p> <p>Configuration (<code>acquis.d/appsec.yaml</code>): <pre><code>listen_addr: 0.0.0.0:7422\nappsec_config: crowdsecurity/virtual-patching\nname: appsecComponent\nsource: appsec\n</code></pre></p> <p>Integration with Traefik: <pre><code>crowdsecappsechost: 'crowdsec:7422'\ncrowdsecappsecenabled: true\n</code></pre></p>"},{"location":"infrastructure/crowdsec/#virtual-patching","title":"Virtual Patching","text":"<p>AppSec provides protection against: - SQL Injection - Database query manipulation - XSS (Cross-Site Scripting) - JavaScript injection - Path Traversal - Directory traversal attacks - Command Injection - OS command execution - SSRF (Server-Side Request Forgery) - Internal service access - Known CVEs - Exploits for known vulnerabilities</p> <p>Virtual patches are applied automatically without code changes, protecting against: - Log4Shell - Spring4Shell - ProxyShell - And many more...</p>"},{"location":"infrastructure/crowdsec/#appsec-metrics","title":"AppSec Metrics","text":"<pre><code># View AppSec metrics\ndocker exec crowdsec cscli metrics show appsec\n\n# View blocked AppSec attacks\ndocker exec crowdsec cscli decisions list --origin cscli\n</code></pre>"},{"location":"infrastructure/crowdsec/#monitoring","title":"Monitoring","text":""},{"location":"infrastructure/crowdsec/#metrics","title":"Metrics","text":"<p>View CrowdSec metrics:</p> <pre><code># Overall metrics\ndocker exec crowdsec cscli metrics\n\n# Parser metrics\ndocker exec crowdsec cscli metrics show parsers\n\n# Scenario metrics\ndocker exec crowdsec cscli metrics show scenarios\n\n# Local API metrics\ndocker exec crowdsec cscli metrics show lapi\n</code></pre>"},{"location":"infrastructure/crowdsec/#dashboard","title":"Dashboard","text":"<p>Access web dashboard (if configured):</p> <pre><code># Set up Metabase dashboard\ndocker exec crowdsec cscli dashboard setup\n</code></pre>"},{"location":"infrastructure/crowdsec/#logs","title":"Logs","text":"<pre><code># View CrowdSec logs\ndocker compose logs -f crowdsec\n\n# Check specific log level\ndocker compose logs crowdsec | grep ERROR\n</code></pre>"},{"location":"infrastructure/crowdsec/#central-api","title":"Central API","text":""},{"location":"infrastructure/crowdsec/#enroll-instance","title":"Enroll Instance","text":"<p>Share and receive threat intelligence:</p> <pre><code># Enroll with CrowdSec Central API\ndocker exec crowdsec cscli capi register\n\n# View enrollment status\ndocker exec crowdsec cscli capi status\n</code></pre>"},{"location":"infrastructure/crowdsec/#threat-intelligence","title":"Threat Intelligence","text":"<p>Once enrolled, your instance: - Shares attack signals anonymously - Receives global threat intelligence - Benefits from community protection</p>"},{"location":"infrastructure/crowdsec/#bouncer-management","title":"Bouncer Management","text":""},{"location":"infrastructure/crowdsec/#list-bouncers","title":"List Bouncers","text":"<pre><code># List registered bouncers\ndocker exec crowdsec cscli bouncers list\n</code></pre>"},{"location":"infrastructure/crowdsec/#add-bouncer","title":"Add Bouncer","text":"<pre><code># Create bouncer API key\ndocker exec crowdsec cscli bouncers add traefik-bouncer\n\n# Returns API key - add to Infisical as CROWDSEC_BOUNCER_API_KEY\n</code></pre>"},{"location":"infrastructure/crowdsec/#remove-bouncer","title":"Remove Bouncer","text":"<pre><code>docker exec crowdsec cscli bouncers delete traefik-bouncer\n</code></pre>"},{"location":"infrastructure/crowdsec/#troubleshooting","title":"Troubleshooting","text":""},{"location":"infrastructure/crowdsec/#bouncer-not-blocking","title":"Bouncer Not Blocking","text":"<p>Check bouncer connection: <pre><code>docker compose logs traefik | grep crowdsec\n</code></pre></p> <p>Verify API key: <pre><code>docker exec crowdsec cscli bouncers list\n</code></pre></p> <p>Test decision enforcement: <pre><code># Add test ban\ndocker exec crowdsec cscli decisions add --ip YOUR_IP --duration 5m\n\n# Try accessing site - should be blocked\ncurl https://yourdomain.com\n\n# Remove ban\ndocker exec crowdsec cscli decisions delete --ip YOUR_IP\n</code></pre></p>"},{"location":"infrastructure/crowdsec/#no-alerts-detected","title":"No Alerts Detected","text":"<p>Check log parsing: <pre><code># View parsed logs\ndocker exec crowdsec cscli metrics show parsers\n\n# Check acquisition sources\ndocker exec crowdsec cscli metrics show acquisition\n</code></pre></p> <p>Verify Docker API access via Cetusguard: <pre><code># Check CrowdSec can reach Docker API\ndocker exec crowdsec wget -O- http://cetusguard:2375/containers/json | jq\n\n# Verify containers are labeled correctly\ndocker inspect traefik | jq '.[0].Config.Labels' | grep crowdsec\n</code></pre></p> <p>Check container labels: Containers must have these labels to be monitored: <pre><code>labels:\n  crowdsec.enable: true\n  crowdsec.labels.type: traefik  # or other service type\n</code></pre></p> <p>Test scenarios: <pre><code># Trigger test alert (path traversal)\ncurl https://yourdomain.com/../../etc/passwd\n\n# Test AppSec WAF (SQL injection)\ncurl \"https://yourdomain.com/?id=1' OR '1'='1\"\n</code></pre></p>"},{"location":"infrastructure/crowdsec/#legitimate-user-blocked","title":"Legitimate User Blocked","text":"<p>Check why blocked: <pre><code>docker exec crowdsec cscli alerts list --ip USER_IP\n</code></pre></p> <p>Remove block: <pre><code>docker exec crowdsec cscli decisions delete --ip USER_IP\n</code></pre></p> <p>Whitelist if trusted: <pre><code>docker exec crowdsec cscli decisions add --ip USER_IP --type whitelist\n</code></pre></p>"},{"location":"infrastructure/crowdsec/#performance-issues","title":"Performance Issues","text":"<p>Check metrics: <pre><code>docker exec crowdsec cscli metrics\n</code></pre></p> <p>Reduce log verbosity if high CPU usage.</p> <p>Adjust scenario thresholds if too sensitive.</p>"},{"location":"infrastructure/crowdsec/#custom-scenarios","title":"Custom Scenarios","text":""},{"location":"infrastructure/crowdsec/#create-custom-scenario","title":"Create Custom Scenario","text":"<p>In <code>compose/crowdsec/config/scenarios/custom-scenario.yaml</code>:</p> <pre><code>type: leaky\nname: myorg/custom-attack\ndescription: \"Detect custom attack pattern\"\nfilter: \"evt.Meta.log_type == 'http_access-log'\"\nleakspeed: 10s\ncapacity: 5\ngroupby: evt.Meta.source_ip\nblackhole: 1m\nlabels:\n  service: web\n  type: custom_attack\n  remediation: true\n</code></pre> <p>Reload CrowdSec: <pre><code>docker compose restart crowdsec\n</code></pre></p>"},{"location":"infrastructure/crowdsec/#security-best-practices","title":"Security Best Practices","text":"<ol> <li>Keep collections updated - Run <code>cscli collections upgrade --all</code> regularly (Renovate handles Docker image updates)</li> <li>Monitor Telegram alerts - Real-time notifications keep you informed</li> <li>Whitelist trusted IPs - Add your public IPs to <code>ip-whitelist.yaml</code></li> <li>Review CTI scores - High background noise scores = serious threats</li> <li>Test blocking - Verify decisions are enforced via Traefik bouncer</li> <li>Monitor AppSec - Check WAF metrics for blocked attacks</li> <li>Check Redis cache - Ensure bouncer cache is working for performance</li> <li>Enroll in CAPI - Benefit from global community intelligence</li> <li>Review profiles - Adjust ban durations based on your threat model</li> <li>Backup configuration - CrowdSec config and data are in <code>${DATA_DIR}/traefik/crowdsec</code></li> </ol>"},{"location":"infrastructure/crowdsec/#required-secrets-in-infisical","title":"Required Secrets in Infisical","text":"<ul> <li><code>TRAEFIK_CROWDSEC_BOUNCER</code> - Bouncer API key</li> <li><code>CROWDSEC_CTI_API_KEY</code> - CTI API key (from console.crowdsec.net)</li> <li><code>TELEGRAM_BOT_ID</code> - Telegram bot token</li> <li><code>TELEGRAM_CHAT_ID</code> - Telegram chat ID for notifications</li> </ul>"},{"location":"infrastructure/crowdsec/#performance-tuning","title":"Performance Tuning","text":""},{"location":"infrastructure/crowdsec/#reduce-memory-usage","title":"Reduce Memory Usage","text":"<pre><code>environment:\n  CSCLI_MEMORY_LIMIT: 256M\n</code></pre>"},{"location":"infrastructure/crowdsec/#optimize-parsers","title":"Optimize Parsers","text":"<p>Disable unused parsers: <pre><code>docker exec crowdsec cscli parsers remove unused-parser\n</code></pre></p>"},{"location":"infrastructure/crowdsec/#adjust-capacities","title":"Adjust Capacities","text":"<p>Fine-tune scenario capacities in custom scenarios to reduce false positives.</p>"},{"location":"infrastructure/crowdsec/#integration-examples","title":"Integration Examples","text":""},{"location":"infrastructure/crowdsec/#fail2ban-migration","title":"Fail2ban Migration","text":"<p>Migrate from Fail2ban: - Install equivalent collections - Adjust thresholds to match Fail2ban rules - Remove Fail2ban configuration</p>"},{"location":"infrastructure/crowdsec/#nginx-logs","title":"Nginx Logs","text":"<p>Parse Nginx logs: <pre><code>docker exec crowdsec cscli parsers install crowdsecurity/nginx-logs\n</code></pre></p> <p>Mount Nginx log directory to CrowdSec.</p>"},{"location":"infrastructure/crowdsec/#wordpress-protection","title":"WordPress Protection","text":"<pre><code>docker exec crowdsec cscli collections install crowdsecurity/wordpress\n</code></pre>"},{"location":"infrastructure/crowdsec/#see-also","title":"See Also","text":"<ul> <li>Traefik - Reverse proxy integration</li> <li>Security Best Practices - Security guidelines</li> <li>Monitoring - Monitoring setup</li> </ul>"},{"location":"infrastructure/network-architecture/","title":"Network Architecture","text":"<p>Omakase uses a multi-layered network architecture for security and isolation.</p>"},{"location":"infrastructure/network-architecture/#network-overview","title":"Network Overview","text":""},{"location":"infrastructure/network-architecture/#shared-networks","title":"Shared Networks","text":"<p>Two shared networks for cross-service communication:</p> <p>vnet-ingress (192.168.90.0/24): - Public-facing services - Connected to Traefik reverse proxy - Protected by Authelia SSO - Monitored by CrowdSec IPS</p> <p>vnet-socket (192.168.91.0/24): - Docker API access - Connected through Cetusguard proxy - Access via Cetusguard proxy - Used by monitoring tools (Dozzle, Portainer, Homepage)</p>"},{"location":"infrastructure/network-architecture/#service-specific-networks","title":"Service-Specific Networks","text":"<p>Each service has its own isolated network: <code>vnet-&lt;service&gt;</code></p> <p>Benefits: - Network segmentation - Reduced attack surface - Traffic isolation - Simplified firewall rules</p>"},{"location":"infrastructure/network-architecture/#network-configuration","title":"Network Configuration","text":""},{"location":"infrastructure/network-architecture/#defining-networks","title":"Defining Networks","text":"<p>Shared networks are defined in service compose files (e.g., <code>compose/core/traefik/compose.yaml</code>):</p> <pre><code>networks:\n  vnet-ingress:\n    name: vnet-ingress\n    driver: bridge\n    ipam:\n      config:\n        - subnet: 192.168.90.0/24\n\n  vnet-socket:\n    name: vnet-socket\n    driver: bridge\n    ipam:\n      config:\n        - subnet: 192.168.91.0/24\n</code></pre>"},{"location":"infrastructure/network-architecture/#service-network","title":"Service Network","text":"<p>Each service defines its own isolated network with small subnet sizes:</p> <pre><code>networks:\n  vnet-myservice:\n    name: vnet-myservice\n    driver: bridge\n    ipam:\n      config:\n        - subnet: 192.168.X.Y/29  # /29 = 8 IPs, /28 = 16 IPs\n</code></pre> <p>Subnet Sizing</p> <ul> <li>Shared networks: /24 (254 hosts) for vnet-ingress and vnet-socket</li> <li>Service networks: /29 (6 usable IPs) or /28 (14 usable IPs)</li> <li>Small subnets minimize attack surface and resource usage</li> </ul>"},{"location":"infrastructure/network-architecture/#subnet-allocation","title":"Subnet Allocation","text":"<p>Check allocated subnets: <pre><code>make network\n</code></pre></p> <p>Allocation Strategy:</p> <ul> <li>Shared networks (large /24 subnets):</li> <li><code>192.168.90.0/24</code> - vnet-ingress</li> <li> <p><code>192.168.91.0/24</code> - vnet-socket</p> </li> <li> <p>Service networks (small /29 or /28 subnets):</p> </li> <li><code>192.168.10.0/29</code> - vnet-traefik</li> <li><code>192.168.20.16/29</code> - vnet-authelia</li> <li><code>192.168.20.32/29</code> - vnet-immich</li> <li><code>192.168.21.16/28</code> - vnet-local-ai</li> </ul> <p>Subnet Size Guidelines: - <code>/29</code> (6 usable IPs): Simple service with 1-2 containers - <code>/28</code> (14 usable IPs): Service with multiple containers (3+) - <code>/24</code> (254 usable IPs): Shared networks only</p> <p>Non-Sequential Allocation</p> <p>Service subnets are not allocated sequentially. Always check <code>make network</code> before adding a new service to avoid conflicts.</p>"},{"location":"infrastructure/network-architecture/#service-network-patterns","title":"Service Network Patterns","text":""},{"location":"infrastructure/network-architecture/#web-accessible-service","title":"Web-Accessible Service","text":"<p>Service with web interface:</p> <pre><code>services:\n  myservice:\n    networks:\n      - vnet-ingress   # For Traefik access\n      - vnet-myservice # Service isolation\n    labels:\n      - traefik.enable=true\n      - traefik.docker.network=vnet-ingress\n      - traefik.http.routers.myservice.rule=Host(`myservice.${DOMAINNAME}`)\n\nnetworks:\n  vnet-ingress:\n    external: true\n  vnet-myservice:\n    name: vnet-myservice\n    driver: bridge\n    ipam:\n      config:\n        - subnet: 192.168.X.Y/29\n</code></pre>"},{"location":"infrastructure/network-architecture/#service-with-database","title":"Service with Database","text":"<p>Service with dedicated database:</p> <pre><code>services:\n  myservice:\n    networks:\n      - vnet-ingress\n      - vnet-myservice\n    environment:\n      DB_HOST: myservice-db\n\n  myservice-db:\n    image: postgres:16\n    networks:\n      - vnet-myservice  # Only on service network\n    # No vnet-ingress - not web accessible\n\nnetworks:\n  vnet-ingress:\n    external: true\n  vnet-myservice:\n    name: vnet-myservice\n    driver: bridge\n    ipam:\n      config:\n        - subnet: 192.168.X.Y/29\n</code></pre>"},{"location":"infrastructure/network-architecture/#docker-api-access","title":"Docker API Access","text":"<p>Service needing Docker API:</p> <pre><code>services:\n  monitoring-tool:\n    networks:\n      - vnet-ingress\n      - vnet-socket    # For Docker API access\n    environment:\n      DOCKER_HOST: tcp://cetusguard:2375\n\nnetworks:\n  vnet-ingress:\n    external: true\n  vnet-socket:\n    external: true\n</code></pre>"},{"location":"infrastructure/network-architecture/#network-security","title":"Network Security","text":""},{"location":"infrastructure/network-architecture/#isolation-rules","title":"Isolation Rules","text":"<ol> <li>Default deny - Services only connect to required networks</li> <li>Minimal exposure - Databases never on ingress network</li> <li>Proxy all Docker API - No direct socket access</li> <li>Separate data and control - Service traffic on dedicated networks</li> </ol>"},{"location":"infrastructure/network-architecture/#network-policies","title":"Network Policies","text":"<p>Web services: - \u2705 Connect to <code>vnet-ingress</code> - \u2705 Connect to own <code>vnet-service</code> - \u274c Never directly to other service networks</p> <p>Databases: - \u2705 Connect to own <code>vnet-service</code> - \u274c Never to <code>vnet-ingress</code> - \u274c Never to other service networks</p> <p>Monitoring tools: - \u2705 Connect to <code>vnet-ingress</code> - \u2705 Connect to <code>vnet-socket</code> - \u274c Never directly to service networks</p>"},{"location":"infrastructure/network-architecture/#firewall-rules","title":"Firewall Rules","text":"<p>Services communicate through defined networks only:</p> <pre><code># Service A cannot reach Service B database\n# Even though both are running on same host\n# Because they're on different networks\n</code></pre>"},{"location":"infrastructure/network-architecture/#traffic-flow","title":"Traffic Flow","text":""},{"location":"infrastructure/network-architecture/#web-request-flow","title":"Web Request Flow","text":"<ol> <li>External request \u2192 Port 80 (Traefik)</li> <li>Traefik (on vnet-ingress) \u2192 Receives request</li> <li>CrowdSec \u2192 Analyzes traffic</li> <li>Authelia \u2192 Authenticates user</li> <li>Service (on vnet-ingress) \u2192 Receives authorized request</li> <li>Service \u2192 Database (on vnet-service) \u2192 Internal communication</li> </ol>"},{"location":"infrastructure/network-architecture/#service-to-service","title":"Service-to-Service","text":"<p>Services that need to communicate must:</p> <ol> <li>Share a common network OR</li> <li>Use vnet-ingress (less secure, only if needed) OR</li> <li>Create dedicated shared network (preferred)</li> </ol> <p>Example shared network for service-to-service: <pre><code>networks:\n  vnet-shared:\n    name: vnet-shared\n    driver: bridge\n    ipam:\n      config:\n        - subnet: 192.168.X.Y/29\n</code></pre></p>"},{"location":"infrastructure/network-architecture/#dns-resolution","title":"DNS Resolution","text":""},{"location":"infrastructure/network-architecture/#internal-dns","title":"Internal DNS","text":"<p>Docker provides automatic DNS resolution within networks:</p> <pre><code># Service can reach database by name\nenvironment:\n  DB_HOST: myservice-db  # Resolves within vnet-myservice\n</code></pre>"},{"location":"infrastructure/network-architecture/#external-dns","title":"External DNS","text":"<p>Configure DNS to point to your server: <pre><code>*.yourdomain.com \u2192 server-ip\n</code></pre></p> <p>Traefik handles internal routing based on Host rules.</p>"},{"location":"infrastructure/network-architecture/#network-troubleshooting","title":"Network Troubleshooting","text":""},{"location":"infrastructure/network-architecture/#check-network-connectivity","title":"Check Network Connectivity","text":"<pre><code># List networks\ndocker network ls\n\n# Inspect network\ndocker network inspect vnet-service\n\n# Check which containers on network\ndocker network inspect vnet-service | jq '.[0].Containers'\n\n# Test connectivity from container\ndocker exec myservice ping myservice-db\ndocker exec myservice nslookup myservice-db\n</code></pre>"},{"location":"infrastructure/network-architecture/#network-conflicts","title":"Network Conflicts","text":"<p>If subnet conflicts occur:</p> <pre><code># View all allocated subnets\nmake network\n\n# Or manually\ndocker network inspect $(docker network ls -q) | jq '.[].IPAM.Config'\n</code></pre> <p>Choose unused subnet range for new service.</p>"},{"location":"infrastructure/network-architecture/#connection-refused","title":"Connection Refused","text":"<p>Check if services are on same network:</p> <pre><code>docker inspect myservice | jq '.[0].NetworkSettings.Networks'\ndocker inspect myservice-db | jq '.[0].NetworkSettings.Networks'\n</code></pre> <p>Both should share at least one network.</p>"},{"location":"infrastructure/network-architecture/#network-monitoring","title":"Network Monitoring","text":""},{"location":"infrastructure/network-architecture/#traffic-analysis","title":"Traffic Analysis","text":"<p>View network traffic: <pre><code>docker stats --format \"table {{.Name}}\\t{{.NetIO}}\"\n</code></pre></p>"},{"location":"infrastructure/network-architecture/#connection-count","title":"Connection Count","text":"<p>Check active connections: <pre><code>docker exec myservice netstat -an | grep ESTABLISHED | wc -l\n</code></pre></p>"},{"location":"infrastructure/network-architecture/#dns-resolution_1","title":"DNS Resolution","text":"<p>Test DNS: <pre><code>docker exec myservice nslookup myservice-db\ndocker exec myservice ping myservice-db\n</code></pre></p>"},{"location":"infrastructure/network-architecture/#best-practices","title":"Best Practices","text":"<ol> <li>One service network per service - Always create dedicated <code>vnet-&lt;service&gt;</code></li> <li>Minimal network connections - Only connect to required networks</li> <li>Never expose Docker socket - Always use Cetusguard proxy</li> <li>Document network topology - Keep subnet allocation updated</li> <li>Use network aliases - For complex setups</li> <li>Monitor network usage - Track bandwidth consumption</li> <li>Test network isolation - Verify services can't reach unrelated services</li> </ol>"},{"location":"infrastructure/network-architecture/#network-diagram","title":"Network Diagram","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Internet                                                 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                  \u2502\n                  \u2502 :443/:80\n                  \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Traefik (vnet-ingress)                                  \u2502\n\u2502   - HTTP routing (port 80)                              \u2502\n\u2502   - SSL upstream                                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n          \u2502                     \u2502\n          \u2502                     \u2502\n    \u250c\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2510        \u250c\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n    \u2502 Authelia   \u2502        \u2502  CrowdSec   \u2502\n    \u2502   (SSO)    \u2502        \u2502    (IPS)    \u2502\n    \u2514\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518        \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n          \u2502\n          \u2502\n    \u250c\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n    \u2502 vnet-ingress (192.168.90.0/24)       \u2502\n    \u2502   - All web-accessible services      \u2502\n    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n          \u2502         \u2502         \u2502\n    \u250c\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n    \u2502 Service \u2502 \u2502Service\u2502 \u2502  Service  \u2502\n    \u2502    A    \u2502 \u2502   B   \u2502 \u2502     C     \u2502\n    \u2514\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n          \u2502        \u2502          \u2502\n    \u250c\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n    \u2502vnet-svcA\u2502 \u2502vnet-  \u2502 \u2502 vnet-svcC \u2502\n    \u2502         \u2502 \u2502 svcB  \u2502 \u2502           \u2502\n    \u2502 \u250c\u2500\u2500\u2500\u2500\u2500\u2510 \u2502 \u2502 \u250c\u2500\u2500\u2500\u2510 \u2502 \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n    \u2502 \u2502DB A \u2502 \u2502 \u2502 \u2502DB \u2502 \u2502 \u2502  \u2502DB C \u2502  \u2502\n    \u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2518 \u2502 \u2502 \u2514\u2500\u2500\u2500\u2518 \u2502 \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 vnet-socket (192.168.91.0/24)                \u2502\n\u2502   - Cetusguard (Docker API proxy)            \u2502\n\u2502   - Monitoring tools                         \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"infrastructure/network-architecture/#see-also","title":"See Also","text":"<ul> <li>Traefik - Reverse proxy configuration</li> <li>Authelia - SSO authentication</li> <li>CrowdSec - Intrusion prevention</li> <li>Cetusguard - Docker socket protection</li> </ul>"},{"location":"infrastructure/traefik/","title":"Traefik","text":"<p>Traefik is the reverse proxy and ingress controller for all web services in Omakase.</p>"},{"location":"infrastructure/traefik/#overview","title":"Overview","text":"<p>Traefik provides: - Automatic SSL certificates via Let's Encrypt - Dynamic routing based on Docker labels - Load balancing for scaled services - Middleware chains for authentication and security - Dashboard for monitoring and troubleshooting</p>"},{"location":"infrastructure/traefik/#configuration","title":"Configuration","text":""},{"location":"infrastructure/traefik/#core-configuration","title":"Core Configuration","text":"<p>Traefik is configured via command-line arguments in <code>compose/core/traefik/compose.yaml</code>. Key configuration includes:</p> <p>Entry Points: <pre><code>'--entrypoints.web.address=:80'\n'--entrypoints.web.asDefault=true'\n'--entryPoints.web.forwardedHeaders.trustedIPs=${TRAEFIK_TRUSTED_IPS}'\n'--entryPoints.web.proxyProtocol.trustedIPs=${TRAEFIK_TRUSTED_IPS}'\n</code></pre></p> <p>Additional Entry Points (for specific services): - <code>metrics</code> (8899) - Prometheus metrics - <code>deluge</code> (7623/tcp) - Deluge torrent client - <code>jellyfin-svc</code> (1900/udp) - Jellyfin service discovery - <code>jellyfin-clt</code> (7359/udp) - Jellyfin client discovery - <code>unifi-stun</code> (3487/udp) - UniFi STUN - <code>unifi-speed</code> (6789/udp) - UniFi speed test - <code>unifi-discovery</code> (10001/udp) - UniFi device discovery</p> <p>Docker Provider: <pre><code>'--providers.docker.endpoint=tcp://cetusguard:2375'  # Via Cetusguard proxy\n'--providers.docker.exposedByDefault=false'          # Explicit opt-in\n'--providers.docker.network=vnet-ingress'            # Default network\n</code></pre></p> <p>File Provider: <pre><code>'--providers.file.directory=/rules'  # Dynamic configuration files\n</code></pre></p> <p>No traefik.yml File</p> <p>Unlike typical Traefik setups, this configuration uses command-line arguments instead of a <code>traefik.yml</code> file. All static configuration is defined in the compose file's <code>command:</code> section.</p>"},{"location":"infrastructure/traefik/#dynamic-configuration","title":"Dynamic Configuration","text":"<p>Located in <code>compose/core/traefik/rules/</code>:</p> <p>Middleware Chain (<code>chain-authelia.yml</code>): <pre><code>http:\n  middlewares:\n    chain-authelia:\n      chain:\n        middlewares:\n          - middlewares-rate-limit      # Rate limiting\n          - middlewares-secure-headers  # Security headers\n          - middlewares-authelia        # SSO authentication\n          - middlewares-compress        # Gzip compression\n          - crowdsec                    # IPS protection\n</code></pre></p> <p>CrowdSec Integration (<code>crowdsec.yml</code>): <pre><code>http:\n  middlewares:\n    crowdsec:\n      plugin:\n        crowdsec-bouncer:\n          enabled: true\n          crowdseclapihost: 'crowdsec:8080'\n          crowdsecappsechost: 'crowdsec:7422'\n          rediscacheenabled: true\n          rediscachehost: 'traefik-redict:6379'\n</code></pre></p> <p>Security Headers (<code>middlewares-secure-headers.yml</code>): <pre><code>http:\n  middlewares:\n    middlewares-secure-headers:\n      headers:\n        browserXssFilter: true\n        contentTypeNosniff: true\n        customFrameOptionsValue: SAMEORIGIN\n        stsIncludeSubdomains: true\n        stsPreload: true\n        stsSeconds: 15552000\n        referrerPolicy: same-origin\n        permissionsPolicy: camera=(), microphone=(self), geolocation=()\n</code></pre></p>"},{"location":"infrastructure/traefik/#service-integration","title":"Service Integration","text":""},{"location":"infrastructure/traefik/#basic-web-service","title":"Basic Web Service","text":"<p>Add Traefik labels to your service:</p> <pre><code>services:\n  myservice:\n    image: myapp:latest\n    networks:\n      - vnet-ingress  # Must be on the ingress network\n    labels:\n      - traefik.enable=true\n      - traefik.http.routers.myservice.rule=Host(`myservice.${DOMAINNAME}`)\n      - traefik.http.routers.myservice.entrypoints=web\n      - traefik.http.services.myservice.loadbalancer.server.port=8080\n</code></pre> <p>Network Requirement</p> <p>Services must be on the <code>vnet-ingress</code> network to be accessible via Traefik. This is Omakase's shared network for public-facing services.</p> <p>No SSL Configuration in Labels</p> <p>Unlike typical Traefik setups, this configuration does not use Let's Encrypt directly. SSL termination is handled upstream (e.g., HAProxy, Cloudflare, or external load balancer). You don't need <code>tls.certresolver</code> labels.</p>"},{"location":"infrastructure/traefik/#service-with-authentication","title":"Service with Authentication","text":"<p>Protect service with Authelia SSO:</p> <pre><code>labels:\n  - traefik.enable=true\n  - traefik.http.routers.myservice.rule=Host(`myservice.${DOMAINNAME}`)\n  - traefik.http.routers.myservice.entrypoints=web\n  - traefik.http.routers.myservice.middlewares=chain-authelia@file\n  - traefik.http.services.myservice.loadbalancer.server.port=8080\n</code></pre> <p>The <code>chain-authelia@file</code> middleware applies: - Rate limiting - Security headers - Authelia SSO authentication - Gzip compression - CrowdSec IPS protection</p>"},{"location":"infrastructure/traefik/#service-with-custom-domain","title":"Service with Custom Domain","text":"<p>Use custom subdomain:</p> <pre><code>labels:\n  - traefik.http.routers.myservice.rule=Host(`custom.${DOMAINNAME}`)\n</code></pre> <p>Multiple subdomains:</p> <pre><code>labels:\n  - traefik.http.routers.myservice.rule=Host(`app1.${DOMAINNAME}`) || Host(`app2.${DOMAINNAME}`)\n</code></pre>"},{"location":"infrastructure/traefik/#service-with-path-prefix","title":"Service with Path Prefix","text":"<p>Route based on path:</p> <pre><code>labels:\n  - traefik.http.routers.myservice.rule=Host(`${DOMAINNAME}`) &amp;&amp; PathPrefix(`/api`)\n  - traefik.http.middlewares.myservice-strip.stripprefix.prefixes=/api\n  - traefik.http.routers.myservice.middlewares=myservice-strip\n</code></pre>"},{"location":"infrastructure/traefik/#middlewares","title":"Middlewares","text":""},{"location":"infrastructure/traefik/#security-headers","title":"Security Headers","text":"<p>Automatically applied via middleware chain:</p> <pre><code>http:\n  middlewares:\n    security-headers:\n      headers:\n        stsSeconds: 31536000\n        stsIncludeSubdomains: true\n        stsPreload: true\n        forceSTSHeader: true\n        contentTypeNosniff: true\n        browserXssFilter: true\n        referrerPolicy: \"strict-origin-when-cross-origin\"\n</code></pre>"},{"location":"infrastructure/traefik/#rate-limiting","title":"Rate Limiting","text":"<p>Limit request rates:</p> <pre><code>labels:\n  - traefik.http.middlewares.myservice-ratelimit.ratelimit.average=100\n  - traefik.http.middlewares.myservice-ratelimit.ratelimit.burst=50\n  - traefik.http.routers.myservice.middlewares=myservice-ratelimit\n</code></pre>"},{"location":"infrastructure/traefik/#ip-whitelist","title":"IP Whitelist","text":"<p>Allow specific IPs only:</p> <pre><code>labels:\n  - traefik.http.middlewares.myservice-whitelist.ipwhitelist.sourcerange=192.168.1.0/24,10.0.0.0/8\n  - traefik.http.routers.myservice.middlewares=myservice-whitelist\n</code></pre>"},{"location":"infrastructure/traefik/#basic-auth","title":"Basic Auth","text":"<p>Alternative to Authelia for simple services:</p> <pre><code>labels:\n  - traefik.http.middlewares.myservice-auth.basicauth.users=user:$$apr1$$...\n  - traefik.http.routers.myservice.middlewares=myservice-auth\n</code></pre> <p>Generate password: <pre><code>htpasswd -nb username password\n</code></pre></p>"},{"location":"infrastructure/traefik/#redirect","title":"Redirect","text":"<p>Redirect to another URL:</p> <pre><code>labels:\n  - traefik.http.middlewares.redirect-https.redirectscheme.scheme=https\n  - traefik.http.middlewares.redirect-https.redirectscheme.permanent=true\n</code></pre>"},{"location":"infrastructure/traefik/#ssltls-certificates","title":"SSL/TLS Certificates","text":"<p>Upstream SSL Termination</p> <p>Omakase's Traefik does not handle SSL certificates directly. This is by design for the reference architecture where SSL termination happens upstream (e.g., OPNSense HAProxy, Cloudflare, cloud load balancer).</p>"},{"location":"infrastructure/traefik/#architecture-options","title":"Architecture Options","text":"<p>Option 1: Upstream SSL Termination (Default/Recommended) <pre><code>Internet \u2192 [Firewall/HAProxy with SSL] \u2192 Traefik (HTTP only) \u2192 Services\n</code></pre></p> <ul> <li>SSL certificates managed at firewall/load balancer level</li> <li>Traefik receives traffic on port 80 (HTTP)</li> <li>Internal communication uses HTTP or can be encrypted separately</li> <li><code>TRAEFIK_TRUSTED_IPS</code> validates requests come from trusted proxy</li> </ul> <p>Option 2: Direct SSL with Let's Encrypt (Requires modification) <pre><code>Internet \u2192 Traefik (HTTPS) \u2192 Services\n</code></pre></p> <p>To enable Let's Encrypt, you would need to: 1. Add <code>websecure</code> entrypoint (port 443) 2. Add <code>certificatesResolvers</code> configuration 3. Update service labels to use <code>entrypoints=websecure</code> and <code>tls.certresolver=letsencrypt</code> 4. Expose port 443 in compose file</p> <p>This is not the default configuration but can be adapted for simpler deployments.</p>"},{"location":"infrastructure/traefik/#dashboard","title":"Dashboard","text":""},{"location":"infrastructure/traefik/#access","title":"Access","text":"<p>Dashboard protected by Authelia: - URL: <code>https://traefik.${DOMAINNAME}</code></p>"},{"location":"infrastructure/traefik/#features","title":"Features","text":"<ul> <li>HTTP routers: View all routes</li> <li>Services: Backend service status</li> <li>Middlewares: Applied middleware chains</li> <li>Certificates: SSL certificate status</li> </ul>"},{"location":"infrastructure/traefik/#monitoring","title":"Monitoring","text":""},{"location":"infrastructure/traefik/#view-logs","title":"View Logs","text":"<pre><code>docker compose logs -f traefik\n</code></pre>"},{"location":"infrastructure/traefik/#check-routes","title":"Check Routes","text":"<pre><code># Health check\ndocker exec traefik traefik healthcheck --ping\n\n# View running command/configuration\ndocker inspect traefik | jq '.[0].Args'\n\n# View dynamic configuration files\ndocker exec traefik ls -la /rules/\ndocker exec traefik cat /rules/chain-authelia.yml\n</code></pre>"},{"location":"infrastructure/traefik/#docker-api-access","title":"Docker API Access","text":"<p>Cetusguard Proxy</p> <p>Traefik does not connect to the Docker socket directly. Instead, it uses the Cetusguard proxy for security:</p> <pre><code>'--providers.docker.endpoint=tcp://cetusguard:2375'\n</code></pre> <p>This provides: - Read-only access to Docker API - No container manipulation capabilities - Network isolation from host Docker socket - Audit logging of API requests</p> <p>See Cetusguard documentation for more details.</p>"},{"location":"infrastructure/traefik/#test-routing","title":"Test Routing","text":"<pre><code># Test specific host (internal)\ncurl -H \"Host: myservice.yourdomain.com\" http://localhost\n\n# Test from external (if SSL upstream)\ncurl https://myservice.yourdomain.com\n</code></pre>"},{"location":"infrastructure/traefik/#troubleshooting","title":"Troubleshooting","text":""},{"location":"infrastructure/traefik/#service-not-accessible","title":"Service Not Accessible","text":"<p>Check Traefik can see service: <pre><code>docker compose logs traefik | grep myservice\n</code></pre></p> <p>Verify Docker labels: <pre><code>docker inspect myservice | jq '.[0].Config.Labels'\n</code></pre></p> <p>Check service on vnet-ingress network: <pre><code>docker network inspect vnet-ingress | jq '.[].Containers'\n</code></pre></p> <p>Verify Traefik can reach Docker API: <pre><code># Check Cetusguard is running\ndocker compose ps cetusguard\n\n# Check Traefik can communicate with Cetusguard\ndocker exec traefik ping -c 2 cetusguard\n</code></pre></p>"},{"location":"infrastructure/traefik/#upstream-sslproxy-issues","title":"Upstream SSL/Proxy Issues","text":"<p>Trusted IPs not configured: <pre><code># Verify TRAEFIK_TRUSTED_IPS is set correctly\ndocker inspect traefik | jq '.[0].Args[] | select(contains(\"trustedIPs\"))'\n</code></pre></p> <p>Check forwarded headers: <pre><code># Enable access logs temporarily to see headers\ndocker compose logs traefik | grep \"User-Agent\"\n</code></pre></p>"},{"location":"infrastructure/traefik/#wrong-backend","title":"Wrong Backend","text":"<p>Check service port: <pre><code>labels:\n  - traefik.http.services.myservice.loadbalancer.server.port=8080\n</code></pre></p> <p>Ensure port matches container's exposed port.</p>"},{"location":"infrastructure/traefik/#redirect-loop","title":"Redirect Loop","text":"<p>Check middleware chain: <pre><code>docker compose logs traefik | grep middleware\n</code></pre></p> <p>Avoid duplicate redirects: - Don't redirect to HTTPS if Traefik already does it - Check application's redirect configuration</p>"},{"location":"infrastructure/traefik/#advanced-configuration","title":"Advanced Configuration","text":""},{"location":"infrastructure/traefik/#load-balancing","title":"Load Balancing","text":"<p>For scaled services:</p> <pre><code>deploy:\n  replicas: 3\nlabels:\n  - traefik.http.services.myservice.loadbalancer.sticky.cookie=true\n  - traefik.http.services.myservice.loadbalancer.sticky.cookie.name=lb\n</code></pre>"},{"location":"infrastructure/traefik/#circuit-breaker","title":"Circuit Breaker","text":"<p>Prevent cascading failures:</p> <pre><code>labels:\n  - traefik.http.middlewares.myservice-cb.circuitbreaker.expression=NetworkErrorRatio() &gt; 0.30\n</code></pre>"},{"location":"infrastructure/traefik/#retry","title":"Retry","text":"<p>Retry failed requests:</p> <pre><code>labels:\n  - traefik.http.middlewares.myservice-retry.retry.attempts=3\n  - traefik.http.middlewares.myservice-retry.retry.initialinterval=100ms\n</code></pre>"},{"location":"infrastructure/traefik/#compression","title":"Compression","text":"<p>Enable gzip compression:</p> <pre><code>labels:\n  - traefik.http.middlewares.myservice-compress.compress=true\n</code></pre>"},{"location":"infrastructure/traefik/#request-headers","title":"Request Headers","text":"<p>Modify request headers:</p> <pre><code>labels:\n  - traefik.http.middlewares.myservice-headers.headers.customrequestheaders.X-Forwarded-Proto=https\n</code></pre>"},{"location":"infrastructure/traefik/#best-practices","title":"Best Practices","text":"<ol> <li>Always use middleware chains - Apply the full <code>chain-authelia@file</code> for protected services</li> <li>Pin Traefik version - Don't use <code>:latest</code> tag (Renovate manages updates)</li> <li>Use vnet-ingress network - All public services must be on this network</li> <li>Specify network in labels - When service is on multiple networks: <code>traefik.docker.network=vnet-ingress</code></li> <li>Test in development - Use <code>compose.dev.yaml</code> for testing routing</li> <li>Monitor CrowdSec - Check that CrowdSec bouncer is working via dashboard</li> <li>Verify trusted IPs - Ensure <code>TRAEFIK_TRUSTED_IPS</code> includes all upstream proxies</li> <li>Document custom middleware - Keep middleware definitions in <code>/rules/</code> directory</li> <li>Never expose Docker socket - Always use Cetusguard proxy</li> <li>Check Redis cache - CrowdSec bouncer uses Redis for performance</li> </ol>"},{"location":"infrastructure/traefik/#performance-tuning","title":"Performance Tuning","text":""},{"location":"infrastructure/traefik/#connection-limits","title":"Connection Limits","text":"<pre><code>entryPoints:\n  websecure:\n    transport:\n      respondingTimeouts:\n        readTimeout: 60s\n        writeTimeout: 60s\n      lifeCycle:\n        requestAcceptGraceTimeout: 10s\n        graceTimeOut: 10s\n</code></pre>"},{"location":"infrastructure/traefik/#buffer-sizes","title":"Buffer Sizes","text":"<pre><code>entryPoints:\n  websecure:\n    transport:\n      respondingTimeouts:\n        idleTimeout: 180s\n</code></pre>"},{"location":"infrastructure/traefik/#see-also","title":"See Also","text":"<ul> <li>Authelia - SSO authentication</li> <li>CrowdSec - Intrusion prevention</li> <li>Network Architecture - Network design</li> </ul>"},{"location":"infrastructure/vpn/","title":"VPN Access","text":"<p>Guide for setting up remote VPN access to your Omakase homelab.</p>"},{"location":"infrastructure/vpn/#overview","title":"Overview","text":"<p>VPN provides: - Secure remote access - Access services from anywhere - Encrypted tunnel - Protect traffic over public networks - Network-level access - Access all services as if on local network - Alternative to public exposure - Keep services private</p>"},{"location":"infrastructure/vpn/#vpn-options","title":"VPN Options","text":""},{"location":"infrastructure/vpn/#wireguard-recommended","title":"WireGuard (Recommended)","text":"<p>Modern, lightweight VPN protocol:</p> <p>Advantages: - Fast performance - Simple configuration - Built into Linux kernel - Low overhead - Strong cryptography</p> <p>Use cases: - Personal devices (phone, laptop) - Always-on access - Road warrior setup</p>"},{"location":"infrastructure/vpn/#openvpn","title":"OpenVPN","text":"<p>Traditional VPN solution:</p> <p>Advantages: - Widely supported - Works through most firewalls - TCP/UDP modes - Extensive features</p> <p>Use cases: - Legacy device support - Complex network scenarios - Site-to-site VPN</p>"},{"location":"infrastructure/vpn/#tailscale-easiest","title":"Tailscale (Easiest)","text":"<p>Mesh VPN built on WireGuard:</p> <p>Advantages: - Zero configuration - Automatic key management - Works behind NAT - Cross-platform apps - Free tier available</p> <p>Use cases: - Quick setup - Multiple devices - Non-technical users</p>"},{"location":"infrastructure/vpn/#wireguard-setup","title":"WireGuard Setup","text":""},{"location":"infrastructure/vpn/#server-installation","title":"Server Installation","text":"<ol> <li>Add WireGuard to compose (not included by default):</li> </ol> <p>Create <code>compose/wireguard/compose.yaml</code>:</p> <pre><code>services:\n  wireguard:\n    image: linuxserver/wireguard:latest\n    container_name: wireguard\n    cap_add:\n      - NET_ADMIN\n      - SYS_MODULE\n    environment:\n      PUID: ${PUID}\n      PGID: ${PGID}\n      TZ: ${TZ}\n      SERVERURL: ${WIREGUARD_SERVER_URL}\n      SERVERPORT: 51820\n      PEERS: 5  # Number of clients\n      PEERDNS: auto\n      INTERNAL_SUBNET: 10.13.13.0/24\n    volumes:\n      - ${DATA_DIR}/wireguard/config:/config\n      - /lib/modules:/lib/modules:ro\n    ports:\n      - 51820:51820/udp\n    sysctls:\n      - net.ipv4.conf.all.src_valid_mark=1\n    restart: unless-stopped\n    security_opt:\n      - no-new-privileges:true\n</code></pre> <ol> <li>Configure environment:</li> </ol> <p>Add to Infisical: <pre><code>WIREGUARD_SERVER_URL=vpn.yourdomain.com\n</code></pre></p> <ol> <li> <p>Deploy WireGuard: <pre><code>make up\n</code></pre></p> </li> <li> <p>Generate client configs: <pre><code>docker compose logs wireguard\n</code></pre></p> </li> </ol> <p>QR codes and config files in <code>${DATA_DIR}/wireguard/config/peer*/</code></p>"},{"location":"infrastructure/vpn/#client-configuration","title":"Client Configuration","text":"<p>Mobile (iOS/Android): 1. Install WireGuard app 2. Scan QR code from logs 3. Connect</p> <p>Desktop (Linux/macOS/Windows): 1. Install WireGuard client 2. Import config file: <code>peer1/peer1.conf</code> 3. Activate connection</p> <p>Config file format: <pre><code>[Interface]\nPrivateKey = &lt;client-private-key&gt;\nAddress = 10.13.13.2/32\nDNS = 10.13.13.1\n\n[Peer]\nPublicKey = &lt;server-public-key&gt;\nEndpoint = vpn.yourdomain.com:51820\nAllowedIPs = 192.168.0.0/16  # Access homelab network\nPersistentKeepalive = 25\n</code></pre></p>"},{"location":"infrastructure/vpn/#firewall-configuration","title":"Firewall Configuration","text":"<p>Open UDP port 51820:</p> <pre><code># UFW\nsudo ufw allow 51820/udp\n\n# iptables\nsudo iptables -A INPUT -p udp --dport 51820 -j ACCEPT\n</code></pre>"},{"location":"infrastructure/vpn/#tailscale-setup-easiest-option","title":"Tailscale Setup (Easiest Option)","text":""},{"location":"infrastructure/vpn/#installation","title":"Installation","text":"<ol> <li> <p>Sign up: https://tailscale.com</p> </li> <li> <p>Install on server: <pre><code>curl -fsSL https://tailscale.com/install.sh | sh\nsudo tailscale up\n</code></pre></p> </li> <li> <p>Install on clients: Download apps from https://tailscale.com/download</p> </li> <li> <p>Access services: Use Tailscale IPs or MagicDNS names</p> </li> </ol>"},{"location":"infrastructure/vpn/#docker-integration","title":"Docker Integration","text":"<p>Run Tailscale as sidecar:</p> <pre><code>services:\n  tailscale:\n    image: tailscale/tailscale:latest\n    container_name: tailscale\n    hostname: omakase\n    environment:\n      TS_AUTHKEY: ${TAILSCALE_AUTH_KEY}\n      TS_STATE_DIR: /var/lib/tailscale\n    volumes:\n      - ${DATA_DIR}/tailscale:/var/lib/tailscale\n      - /dev/net/tun:/dev/net/tun\n    cap_add:\n      - NET_ADMIN\n      - SYS_MODULE\n    restart: unless-stopped\n</code></pre>"},{"location":"infrastructure/vpn/#advantages","title":"Advantages","text":"<ul> <li>Zero port forwarding - Works behind NAT</li> <li>Automatic encryption - No manual key management</li> <li>MagicDNS - Access services by name</li> <li>Access controls - Manage in web UI</li> <li>Exit nodes - Route traffic through homelab</li> </ul>"},{"location":"infrastructure/vpn/#network-configuration","title":"Network Configuration","text":""},{"location":"infrastructure/vpn/#split-tunnel","title":"Split Tunnel","text":"<p>Only route homelab traffic through VPN:</p> <p>WireGuard: <pre><code>AllowedIPs = 192.168.0.0/16  # Only homelab\n</code></pre></p> <p>Advantages: - Faster internet speed - Lower latency - Less server load</p>"},{"location":"infrastructure/vpn/#full-tunnel","title":"Full Tunnel","text":"<p>Route all traffic through VPN:</p> <p>WireGuard: <pre><code>AllowedIPs = 0.0.0.0/0, ::/0  # All traffic\n</code></pre></p> <p>Use cases: - Public WiFi security - Hide browsing from ISP - Access geo-restricted content</p>"},{"location":"infrastructure/vpn/#dns-configuration","title":"DNS Configuration","text":""},{"location":"infrastructure/vpn/#local-dns-resolution","title":"Local DNS Resolution","text":"<p>Access services by name:</p> <p>Option 1: Hosts file on client: <pre><code>10.13.13.1 home.yourdomain.com\n10.13.13.1 portainer.yourdomain.com\n</code></pre></p> <p>Option 2: Internal DNS server (Pi-hole, AdGuard): Configure VPN DNS to point to internal DNS server.</p>"},{"location":"infrastructure/vpn/#magicdns-tailscale","title":"MagicDNS (Tailscale)","text":"<p>Enable in Tailscale admin: - Access services: <code>http://omakase:8080</code> - No manual DNS configuration needed</p>"},{"location":"infrastructure/vpn/#security-best-practices","title":"Security Best Practices","text":"<ol> <li>Strong keys - Use generated WireGuard keys, never create manually</li> <li>Limited peer count - Only create necessary clients</li> <li>Regular rotation - Rotate keys periodically</li> <li>Revoke unused peers - Remove old devices</li> <li>Monitor connections - Check who's connected</li> <li>Firewall rules - Limit VPN network access if needed</li> <li>2FA where possible - Use Tailscale's SSO with 2FA</li> </ol>"},{"location":"infrastructure/vpn/#monitoring","title":"Monitoring","text":""},{"location":"infrastructure/vpn/#wireguard-status","title":"WireGuard Status","text":"<pre><code># Check peers\ndocker exec wireguard wg show\n\n# View logs\ndocker compose logs wireguard\n\n# Connection status\ndocker exec wireguard wg show wg0\n</code></pre>"},{"location":"infrastructure/vpn/#tailscale-status","title":"Tailscale Status","text":"<pre><code># Connection status\nsudo tailscale status\n\n# Network map\nsudo tailscale netcheck\n\n# Peer list\nsudo tailscale status --json\n</code></pre>"},{"location":"infrastructure/vpn/#troubleshooting","title":"Troubleshooting","text":""},{"location":"infrastructure/vpn/#cant-connect","title":"Can't Connect","text":"<p>Check server running: <pre><code>docker compose ps wireguard\n</code></pre></p> <p>Check firewall: <pre><code>sudo ufw status | grep 51820\n</code></pre></p> <p>Check port forwarding on router (if behind NAT).</p> <p>Verify endpoint: <pre><code># Test UDP port open\nnc -u -z vpn.yourdomain.com 51820\n</code></pre></p>"},{"location":"infrastructure/vpn/#connected-but-cant-access-services","title":"Connected But Can't Access Services","text":"<p>Check routing: <pre><code># On client\nip route | grep wg\nping 192.168.1.1\n</code></pre></p> <p>Check AllowedIPs: Ensure client config includes homelab subnet: <pre><code>AllowedIPs = 192.168.0.0/16\n</code></pre></p> <p>Check server IP forwarding: <pre><code># On server\nsysctl net.ipv4.ip_forward\n# Should be: net.ipv4.ip_forward = 1\n</code></pre></p> <p>Enable if needed: <pre><code>echo \"net.ipv4.ip_forward=1\" | sudo tee -a /etc/sysctl.conf\nsudo sysctl -p\n</code></pre></p>"},{"location":"infrastructure/vpn/#slow-performance","title":"Slow Performance","text":"<p>Check MTU: <pre><code>[Interface]\nMTU = 1420  # Try lower values: 1380, 1280\n</code></pre></p> <p>Reduce keepalive: <pre><code>[Peer]\nPersistentKeepalive = 25  # Increase to 60 for less overhead\n</code></pre></p> <p>Use split tunnel instead of full tunnel.</p>"},{"location":"infrastructure/vpn/#access-patterns","title":"Access Patterns","text":""},{"location":"infrastructure/vpn/#mobile-access","title":"Mobile Access","text":"<p>Setup for accessing homelab from phone:</p> <ol> <li>Install WireGuard mobile app</li> <li>Scan QR code or import config</li> <li>Toggle connection when needed</li> <li>Access services at <code>https://service.yourdomain.com</code></li> </ol>"},{"location":"infrastructure/vpn/#laptop-road-warrior","title":"Laptop Road Warrior","text":"<p>Always-on VPN for remote work:</p> <ol> <li>Install WireGuard desktop client</li> <li>Import config</li> <li>Set to auto-connect</li> <li>Work as if on local network</li> </ol>"},{"location":"infrastructure/vpn/#site-to-site","title":"Site-to-Site","text":"<p>Connect two locations:</p> <ol> <li>Setup WireGuard on both sites</li> <li>Configure as peers</li> <li>Route networks between sites</li> <li>Access resources on both networks</li> </ol>"},{"location":"infrastructure/vpn/#alternative-ssh-tunnel","title":"Alternative: SSH Tunnel","text":"<p>For quick, one-off access without VPN:</p> <pre><code># Forward port through SSH\nssh -L 8080:localhost:8080 user@homelab-server\n\n# Access at http://localhost:8080\n</code></pre> <p>SOCKS proxy: <pre><code># Create SOCKS proxy\nssh -D 9999 user@homelab-server\n\n# Configure browser to use localhost:9999 as SOCKS proxy\n</code></pre></p>"},{"location":"infrastructure/vpn/#public-access-considerations","title":"Public Access Considerations","text":""},{"location":"infrastructure/vpn/#when-to-use-vpn","title":"When to Use VPN","text":"<ul> <li>\u2705 Want to keep services private</li> <li>\u2705 Don't want to expose ports publicly</li> <li>\u2705 Need access from trusted devices only</li> <li>\u2705 Want encrypted access over public WiFi</li> </ul>"},{"location":"infrastructure/vpn/#when-to-use-public-access","title":"When to Use Public Access","text":"<ul> <li>\u2705 Need to share with others</li> <li>\u2705 Access from many devices</li> <li>\u2705 Don't want VPN complexity</li> <li>\u2705 Use Authelia + CrowdSec protection</li> </ul> <p>Hybrid approach: VPN for admin services, public for user-facing.</p>"},{"location":"infrastructure/vpn/#see-also","title":"See Also","text":"<ul> <li>Network Architecture - Network design</li> <li>Security Best Practices - Security guidelines</li> <li>Traefik - Reverse proxy setup</li> </ul>"},{"location":"operations/backup/","title":"Backup","text":"<p>Omakase uses Restic for automated, encrypted backups to Backblaze B2 cloud storage.</p>"},{"location":"operations/backup/#overview","title":"Overview","text":"<p>The backup system provides: - Automated daily backups at 3:30 AM - Integrity checks at 5:15 AM - Automated pruning at 4:00 AM to manage storage - Encrypted backups to Backblaze B2 - Telegram notifications for backup status</p>"},{"location":"operations/backup/#configuration","title":"Configuration","text":"<p>Backup configuration is located in <code>compose/backup/compose.yaml</code>.</p>"},{"location":"operations/backup/#required-secrets","title":"Required Secrets","text":"<p>Configure these in Infisical:</p> Variable Description <code>B2_ACCOUNT_ID</code> Backblaze B2 account ID <code>B2_ACCOUNT_KEY</code> Backblaze B2 application key <code>RESTIC_REPOSITORY</code> Restic repository URL <code>RESTIC_PASSWORD</code> Encryption password for backups <code>TELEGRAM_BOT_TOKEN</code> Telegram bot token for notifications <code>TELEGRAM_CHAT_ID</code> Telegram chat ID for notifications"},{"location":"operations/backup/#backup-schedule","title":"Backup Schedule","text":"<p>Default cron schedules: <pre><code>- \"30 3 * * *\"  # Backup at 3:30 AM\n- \"15 5 * * *\"  # Check at 5:15 AM\n- \"0 4 * * *\"   # Prune at 4:00 AM\n</code></pre></p>"},{"location":"operations/backup/#manual-operations","title":"Manual Operations","text":""},{"location":"operations/backup/#manual-backup","title":"Manual Backup","text":"<pre><code>docker exec restic-backup restic backup /data\n</code></pre>"},{"location":"operations/backup/#list-snapshots","title":"List Snapshots","text":"<pre><code>docker exec restic-backup restic snapshots\n</code></pre>"},{"location":"operations/backup/#restore-data","title":"Restore Data","text":"<p>Restore latest snapshot: <pre><code>docker exec restic-backup restic restore latest --target /restore\n</code></pre></p> <p>Restore specific snapshot: <pre><code>docker exec restic-backup restic restore &lt;snapshot-id&gt; --target /restore\n</code></pre></p>"},{"location":"operations/backup/#check-repository-integrity","title":"Check Repository Integrity","text":"<pre><code>docker exec restic-backup restic check\n</code></pre>"},{"location":"operations/backup/#view-backup-statistics","title":"View Backup Statistics","text":"<pre><code>docker exec restic-backup restic stats\n</code></pre>"},{"location":"operations/backup/#backup-retention-policy","title":"Backup Retention Policy","text":"<p>Configured in the prune script: - Keep daily backups for 7 days - Keep weekly backups for 4 weeks - Keep monthly backups for 12 months - Keep yearly backups for 10 years</p>"},{"location":"operations/backup/#what-gets-backed-up","title":"What Gets Backed Up","text":"<p>Backup includes all data in <code>${DATA_DIR}</code>: - Service configurations - Application data - Databases - User files</p> <p>Excluded: - Temporary files - Cache directories - Container images (can be rebuilt)</p>"},{"location":"operations/backup/#monitoring-backups","title":"Monitoring Backups","text":""},{"location":"operations/backup/#telegram-notifications","title":"Telegram Notifications","text":"<p>Receive notifications for: - Successful backups - Failed backups - Check results - Prune operations</p>"},{"location":"operations/backup/#manual-monitoring","title":"Manual Monitoring","text":"<p>Check recent backup logs: <pre><code>docker compose logs backup\n</code></pre></p> <p>View last backup status: <pre><code>docker exec restic-backup restic snapshots --last\n</code></pre></p>"},{"location":"operations/backup/#disaster-recovery","title":"Disaster Recovery","text":""},{"location":"operations/backup/#full-system-recovery","title":"Full System Recovery","text":"<ol> <li>Install fresh Omakase instance</li> <li>Configure Restic with same credentials</li> <li>List available snapshots:    <pre><code>docker exec restic-backup restic snapshots\n</code></pre></li> <li>Restore latest snapshot:    <pre><code>docker exec restic-backup restic restore latest --target ${DATA_DIR}\n</code></pre></li> <li>Fix permissions:    <pre><code>chown -R ${PUID}:${PGID} ${DATA_DIR}\n</code></pre></li> <li>Start services:    <pre><code>make up\n</code></pre></li> </ol>"},{"location":"operations/backup/#selective-restore","title":"Selective Restore","text":"<p>Restore specific service: <pre><code>docker exec restic-backup restic restore latest \\\n  --target /restore \\\n  --include ${DATA_DIR}/service-name\n</code></pre></p>"},{"location":"operations/backup/#troubleshooting","title":"Troubleshooting","text":""},{"location":"operations/backup/#backup-fails","title":"Backup Fails","text":"<p>Check Backblaze credentials: <pre><code>make config | grep B2_\n</code></pre></p> <p>Test connectivity: <pre><code>docker exec restic-backup restic snapshots\n</code></pre></p>"},{"location":"operations/backup/#repository-locked","title":"Repository Locked","text":"<p>If backup fails with \"repository is already locked\": <pre><code>docker exec restic-backup restic unlock\n</code></pre></p>"},{"location":"operations/backup/#storage-full","title":"Storage Full","text":"<p>Check repository size: <pre><code>docker exec restic-backup restic stats\n</code></pre></p> <p>Run manual prune: <pre><code>docker exec restic-backup restic prune\n</code></pre></p>"},{"location":"operations/backup/#best-practices","title":"Best Practices","text":"<ol> <li>Test restores regularly - Verify backups are working</li> <li>Monitor notifications - Set up Telegram for alerts</li> <li>Verify encryption - Keep <code>RESTIC_PASSWORD</code> secure</li> <li>Monitor storage costs - Check Backblaze usage</li> <li>Document recovery procedures - Keep this guide accessible</li> </ol>"},{"location":"operations/backup/#see-also","title":"See Also","text":"<ul> <li>Maintenance - Regular maintenance tasks</li> <li>Troubleshooting - Common issues</li> <li>Secrets Management - Managing backup credentials</li> </ul>"},{"location":"operations/maintenance/","title":"Maintenance","text":"<p>Regular maintenance tasks to keep your Omakase homelab running smoothly.</p>"},{"location":"operations/maintenance/#daily-tasks","title":"Daily Tasks","text":""},{"location":"operations/maintenance/#monitor-services","title":"Monitor Services","text":"<p>Check service health: <pre><code>docker compose ps\n</code></pre></p> <p>View recent logs: <pre><code>docker compose logs --tail=100\n</code></pre></p>"},{"location":"operations/maintenance/#check-backup-status","title":"Check Backup Status","text":"<p>Verify daily backups completed: <pre><code>docker compose logs backup | grep -i \"backup completed\"\n</code></pre></p>"},{"location":"operations/maintenance/#weekly-tasks","title":"Weekly Tasks","text":""},{"location":"operations/maintenance/#update-docker-images","title":"Update Docker Images","text":"<p>Pull latest images: <pre><code>make pull\n</code></pre></p> <p>Restart services with new images: <pre><code>make restart\n</code></pre></p>"},{"location":"operations/maintenance/#review-security-alerts","title":"Review Security Alerts","text":"<p>Check CrowdSec decisions: <pre><code>docker exec crowdsec cscli decisions list\n</code></pre></p> <p>Review blocked IPs: <pre><code>docker exec crowdsec cscli alerts list\n</code></pre></p>"},{"location":"operations/maintenance/#check-disk-usage","title":"Check Disk Usage","text":"<p>Monitor storage: <pre><code>df -h ${DATA_DIR}\n</code></pre></p> <p>Check Docker disk usage: <pre><code>docker system df\n</code></pre></p>"},{"location":"operations/maintenance/#monthly-tasks","title":"Monthly Tasks","text":""},{"location":"operations/maintenance/#clean-unused-resources","title":"Clean Unused Resources","text":"<p>Remove unused containers, images, volumes: <pre><code>make clean\n</code></pre></p> <p>Or manually: <pre><code>docker system prune -a --volumes\n</code></pre></p>"},{"location":"operations/maintenance/#review-logs","title":"Review Logs","text":"<p>Archive old logs if needed: <pre><code>find ${DATA_DIR}/*/logs -name \"*.log\" -mtime +30 -exec gzip {} \\;\n</code></pre></p>"},{"location":"operations/maintenance/#test-backup-restore","title":"Test Backup Restore","text":"<p>Perform test restore to verify backups: <pre><code>docker exec restic-backup restic restore latest --target /tmp/restore-test\n</code></pre></p>"},{"location":"operations/maintenance/#update-documentation","title":"Update Documentation","text":"<p>Review and update service documentation as configurations change.</p>"},{"location":"operations/maintenance/#quarterly-tasks","title":"Quarterly Tasks","text":""},{"location":"operations/maintenance/#security-audit","title":"Security Audit","text":"<ol> <li>Review user access in Authelia</li> <li>Rotate sensitive credentials</li> <li>Review CrowdSec security collections</li> <li>Update security policies</li> </ol>"},{"location":"operations/maintenance/#performance-review","title":"Performance Review","text":"<ol> <li>Check resource usage:    <pre><code>docker stats\n</code></pre></li> <li>Identify resource-heavy services</li> <li>Optimize configurations if needed</li> </ol>"},{"location":"operations/maintenance/#dependency-updates","title":"Dependency Updates","text":"<p>Review and test major version updates: 1. Check Renovate PRs 2. Read changelogs 3. Test in development environment 4. Deploy to production</p>"},{"location":"operations/maintenance/#as-needed-tasks","title":"As-Needed Tasks","text":""},{"location":"operations/maintenance/#add-new-service","title":"Add New Service","text":"<p>Follow the Adding Services guide.</p>"},{"location":"operations/maintenance/#rotate-secrets","title":"Rotate Secrets","text":"<ol> <li>Generate new secret:    <pre><code>make pwgen\n</code></pre></li> <li>Update in Infisical</li> <li>Restart affected services:    <pre><code>docker compose restart &lt;service&gt;\n</code></pre></li> </ol>"},{"location":"operations/maintenance/#scale-resources","title":"Scale Resources","text":"<p>Adjust CPU/memory limits in compose files: <pre><code>deploy:\n  resources:\n    limits:\n      cpus: '2.0'\n      memory: 2G\n</code></pre></p>"},{"location":"operations/maintenance/#monitoring-checklist","title":"Monitoring Checklist","text":"<p>Daily: - [ ] Check service status - [ ] Verify backup completion - [ ] Review error logs</p> <p>Weekly: - [ ] Update images - [ ] Review security alerts - [ ] Check disk usage</p> <p>Monthly: - [ ] Clean unused resources - [ ] Test backup restore - [ ] Review logs</p> <p>Quarterly: - [ ] Security audit - [ ] Performance review - [ ] Dependency updates</p>"},{"location":"operations/maintenance/#maintenance-windows","title":"Maintenance Windows","text":"<p>For major updates that require downtime:</p> <ol> <li>Notify users (if shared homelab)</li> <li>Backup current state:    <pre><code>docker exec restic-backup restic backup /data\n</code></pre></li> <li>Stop services:    <pre><code>make down\n</code></pre></li> <li>Perform maintenance</li> <li>Start services:    <pre><code>make up\n</code></pre></li> <li>Verify functionality:    <pre><code>docker compose ps\ndocker compose logs\n</code></pre></li> </ol>"},{"location":"operations/maintenance/#automation","title":"Automation","text":"<p>Consider automating routine tasks:</p>"},{"location":"operations/maintenance/#watchtower-for-auto-updates","title":"Watchtower for Auto-Updates","text":"<p>Warning: Not recommended for production. Use Renovate instead for controlled updates.</p>"},{"location":"operations/maintenance/#monitoring-alerts","title":"Monitoring Alerts","text":"<p>Set up alerts for: - Service failures - Disk space warnings - Backup failures (via Telegram) - Security incidents (CrowdSec)</p>"},{"location":"operations/maintenance/#emergency-procedures","title":"Emergency Procedures","text":""},{"location":"operations/maintenance/#service-down","title":"Service Down","text":"<ol> <li>Check logs:    <pre><code>docker compose logs &lt;service&gt;\n</code></pre></li> <li>Restart service:    <pre><code>docker compose restart &lt;service&gt;\n</code></pre></li> <li>If persistent, restore from backup</li> </ol>"},{"location":"operations/maintenance/#system-resources-exhausted","title":"System Resources Exhausted","text":"<ol> <li>Identify resource hog:    <pre><code>docker stats\n</code></pre></li> <li>Stop non-critical services:    <pre><code>docker compose stop &lt;service&gt;\n</code></pre></li> <li>Clean up:    <pre><code>make clean\n</code></pre></li> </ol>"},{"location":"operations/maintenance/#security-incident","title":"Security Incident","text":"<ol> <li>Check CrowdSec alerts</li> <li>Review service logs</li> <li>Block malicious IPs:    <pre><code>docker exec crowdsec cscli decisions add --ip &lt;ip&gt; --duration 24h\n</code></pre></li> <li>Rotate compromised credentials</li> </ol>"},{"location":"operations/maintenance/#see-also","title":"See Also","text":"<ul> <li>Backup - Backup procedures</li> <li>Troubleshooting - Common issues</li> <li>Monitoring - Monitoring setup</li> </ul>"},{"location":"operations/monitoring/","title":"Monitoring","text":"<p>Omakase provides multiple monitoring tools to track service health and performance.</p>"},{"location":"operations/monitoring/#monitoring-stack","title":"Monitoring Stack","text":""},{"location":"operations/monitoring/#dozzle-real-time-logs","title":"Dozzle - Real-time Logs","text":"<p>Web-based real-time log viewer for all containers.</p> <p>Access: <code>https://dozzle.yourdomain.com</code></p> <p>Features: - Real-time log streaming - Multi-container view - Search and filter logs - No database required</p> <p>Usage: <pre><code># Dozzle automatically discovers all containers\n# Access via web interface for real-time logs\n</code></pre></p>"},{"location":"operations/monitoring/#homepage-service-dashboard","title":"Homepage - Service Dashboard","text":"<p>Centralized dashboard for all services.</p> <p>Access: <code>https://home.yourdomain.com</code></p> <p>Features: - Service status indicators - Quick access links - Custom widgets - Docker integration</p> <p>Configuration: Edit <code>compose/homepage/config/services.yaml</code></p>"},{"location":"operations/monitoring/#portainer-container-management","title":"Portainer - Container Management","text":"<p>Full container management interface.</p> <p>Access: <code>https://portainer.yourdomain.com</code></p> <p>Features: - Container lifecycle management - Resource monitoring - Stack deployment - Volume management - Network inspection</p>"},{"location":"operations/monitoring/#traefik-dashboard","title":"Traefik Dashboard","text":"<p>Reverse proxy monitoring and routing visualization.</p> <p>Access: <code>https://traefik.yourdomain.com</code></p> <p>Features: - Active routes - Service health - Certificate status - Middleware chains</p>"},{"location":"operations/monitoring/#monitoring-commands","title":"Monitoring Commands","text":""},{"location":"operations/monitoring/#service-status","title":"Service Status","text":"<p>Check all services: <pre><code>docker compose ps\n</code></pre></p> <p>Check specific service: <pre><code>docker compose ps &lt;service-name&gt;\n</code></pre></p>"},{"location":"operations/monitoring/#resource-usage","title":"Resource Usage","text":"<p>Real-time resource monitoring: <pre><code>docker stats\n</code></pre></p> <p>Specific container: <pre><code>docker stats &lt;container-name&gt;\n</code></pre></p>"},{"location":"operations/monitoring/#logs","title":"Logs","text":"<p>View logs: <pre><code># All services\ndocker compose logs\n\n# Specific service\ndocker compose logs &lt;service-name&gt;\n\n# Follow logs\ndocker compose logs -f &lt;service-name&gt;\n\n# Last N lines\ndocker compose logs --tail=100 &lt;service-name&gt;\n\n# Since timestamp\ndocker compose logs --since 2024-01-01T10:00:00\n</code></pre></p>"},{"location":"operations/monitoring/#health-checks","title":"Health Checks","text":"<p>Check container health: <pre><code>docker inspect --format='{{.State.Health.Status}}' &lt;container-name&gt;\n</code></pre></p> <p>View health check logs: <pre><code>docker inspect &lt;container-name&gt; | jq '.[0].State.Health'\n</code></pre></p>"},{"location":"operations/monitoring/#metrics-to-monitor","title":"Metrics to Monitor","text":""},{"location":"operations/monitoring/#system-resources","title":"System Resources","text":"<p>CPU Usage: <pre><code>docker stats --no-stream --format \"table {{.Container}}\\t{{.CPUPerc}}\"\n</code></pre></p> <p>Memory Usage: <pre><code>docker stats --no-stream --format \"table {{.Container}}\\t{{.MemUsage}}\"\n</code></pre></p> <p>Disk Usage: <pre><code># Docker disk usage\ndocker system df\n\n# Data directory usage\ndu -sh ${DATA_DIR}/*\n\n# System disk usage\ndf -h\n</code></pre></p> <p>Network Usage: <pre><code>docker stats --no-stream --format \"table {{.Container}}\\t{{.NetIO}}\"\n</code></pre></p>"},{"location":"operations/monitoring/#service-health","title":"Service Health","text":"<p>Container Status: <pre><code># Running containers\ndocker ps\n\n# All containers including stopped\ndocker ps -a\n\n# Filter by status\ndocker ps --filter \"status=exited\"\n</code></pre></p> <p>Network Connectivity: <pre><code># List networks\ndocker network ls\n\n# Inspect network\ndocker network inspect vnet-service\n\n# Check subnet allocations\nmake network\n</code></pre></p>"},{"location":"operations/monitoring/#security-monitoring","title":"Security Monitoring","text":"<p>CrowdSec Alerts: <pre><code># List recent alerts\ndocker exec crowdsec cscli alerts list\n\n# List active decisions (blocks)\ndocker exec crowdsec cscli decisions list\n\n# View metrics\ndocker exec crowdsec cscli metrics\n</code></pre></p> <p>Authelia Authentication: <pre><code># View authentication logs\ndocker compose logs authelia | grep \"authentication\"\n</code></pre></p>"},{"location":"operations/monitoring/#alerting","title":"Alerting","text":""},{"location":"operations/monitoring/#telegram-notifications","title":"Telegram Notifications","text":"<p>Configured for backup operations. See Backup.</p>"},{"location":"operations/monitoring/#email-alerts","title":"Email Alerts","text":"<p>Configure SMTP in Authelia for: - Failed login attempts - Password reset requests - 2FA notifications</p>"},{"location":"operations/monitoring/#log-monitoring","title":"Log Monitoring","text":"<p>Use Dozzle to set up: - Log filters for errors - Real-time monitoring - Search saved queries</p>"},{"location":"operations/monitoring/#performance-monitoring","title":"Performance Monitoring","text":""},{"location":"operations/monitoring/#response-times","title":"Response Times","text":"<p>Monitor via Traefik dashboard: - Request rates - Response times - Error rates</p>"},{"location":"operations/monitoring/#database-performance","title":"Database Performance","text":"<p>PostgreSQL: <pre><code># Connection stats\ndocker exec postgres psql -U user -d dbname -c \"SELECT * FROM pg_stat_activity;\"\n\n# Database size\ndocker exec postgres psql -U user -c \"\\l+\"\n</code></pre></p>"},{"location":"operations/monitoring/#storage-performance","title":"Storage Performance","text":"<p>I/O Statistics: <pre><code>iostat -x 1\n</code></pre></p> <p>Disk Performance: <pre><code>docker run --rm -v ${DATA_DIR}:/data alpine sh -c \"dd if=/dev/zero of=/data/testfile bs=1M count=1024 &amp;&amp; rm /data/testfile\"\n</code></pre></p>"},{"location":"operations/monitoring/#dashboard-setup","title":"Dashboard Setup","text":""},{"location":"operations/monitoring/#homepage-widgets","title":"Homepage Widgets","text":"<p>Edit <code>compose/homepage/config/services.yaml</code>:</p> <pre><code>- Service Name:\n    - Description: Service description\n      icon: service-icon.png\n      href: https://service.yourdomain.com\n      ping: http://service:port\n      container: container-name\n</code></pre>"},{"location":"operations/monitoring/#grafana-optional","title":"Grafana (Optional)","text":"<p>For advanced monitoring, consider adding: - Prometheus for metrics collection - Grafana for visualization - Loki for log aggregation</p>"},{"location":"operations/monitoring/#monitoring-checklist","title":"Monitoring Checklist","text":"<p>Daily: - [ ] Check Homepage dashboard - [ ] Review error logs in Dozzle - [ ] Verify all services running</p> <p>Weekly: - [ ] Check resource usage trends - [ ] Review CrowdSec security alerts - [ ] Check disk space utilization</p> <p>Monthly: - [ ] Review performance metrics - [ ] Analyze resource consumption - [ ] Optimize underperforming services</p>"},{"location":"operations/monitoring/#troubleshooting-monitoring","title":"Troubleshooting Monitoring","text":""},{"location":"operations/monitoring/#dozzle-not-showing-logs","title":"Dozzle Not Showing Logs","text":"<p>Check Cetusguard connection: <pre><code>docker compose logs dozzle\n</code></pre></p> <p>Verify Docker socket proxy is running: <pre><code>docker compose ps cetusguard\n</code></pre></p>"},{"location":"operations/monitoring/#homepage-not-updating","title":"Homepage Not Updating","text":"<p>Check service status: <pre><code>docker compose ps homepage\n</code></pre></p> <p>Verify configuration: <pre><code>docker compose logs homepage\n</code></pre></p>"},{"location":"operations/monitoring/#portainer-connection-issues","title":"Portainer Connection Issues","text":"<p>Check API access through Cetusguard: <pre><code>curl http://cetusguard:2375/v1.43/containers/json\n</code></pre></p>"},{"location":"operations/monitoring/#see-also","title":"See Also","text":"<ul> <li>Maintenance - Regular maintenance tasks</li> <li>Troubleshooting - Common issues</li> <li>Performance - Performance optimization</li> </ul>"},{"location":"operations/performance/","title":"Performance Optimization","text":"<p>Guidelines for optimizing Omakase homelab performance.</p>"},{"location":"operations/performance/#resource-allocation","title":"Resource Allocation","text":""},{"location":"operations/performance/#cpu-limits","title":"CPU Limits","text":"<p>Set appropriate CPU limits for each service:</p> <pre><code>deploy:\n  resources:\n    limits:\n      cpus: '2.0'      # Maximum 2 CPU cores\n    reservations:\n      cpus: '0.5'      # Minimum 0.5 CPU cores\n</code></pre> <p>Recommended allocations: - Lightweight services (Traefik, Authelia): 0.5-1 CPU - Medium services (Nextcloud, Jellyfin): 1-2 CPUs - Heavy services (Local AI, Immich): 2-4 CPUs</p>"},{"location":"operations/performance/#memory-limits","title":"Memory Limits","text":"<p>Prevent memory exhaustion:</p> <pre><code>deploy:\n  resources:\n    limits:\n      memory: 2G       # Maximum 2GB RAM\n    reservations:\n      memory: 512M     # Minimum 512MB RAM\n</code></pre> <p>Recommended allocations: - Lightweight services: 256M-512M - Medium services: 512M-2G - Heavy services: 2G-8G - Databases: 1G-4G</p>"},{"location":"operations/performance/#monitor-resource-usage","title":"Monitor Resource Usage","text":"<pre><code># Real-time monitoring\ndocker stats\n\n# Identify resource hogs\ndocker stats --no-stream | sort -k 3 -h\n</code></pre>"},{"location":"operations/performance/#network-performance","title":"Network Performance","text":""},{"location":"operations/performance/#network-isolation","title":"Network Isolation","text":"<p>Use dedicated networks per service to reduce broadcast traffic:</p> <pre><code>networks:\n  vnet-service:\n    driver: bridge\n    ipam:\n      config:\n        - subnet: 192.168.X.0/24\n</code></pre>"},{"location":"operations/performance/#traefik-optimization","title":"Traefik Optimization","text":"<p>Enable HTTP/2: <pre><code>entryPoints:\n  websecure:\n    http2:\n      maxConcurrentStreams: 250\n</code></pre></p> <p>Enable compression: <pre><code>http:\n  middlewares:\n    compression:\n      compress: {}\n</code></pre></p> <p>Connection limits: <pre><code>entryPoints:\n  websecure:\n    transport:\n      respondingTimeouts:\n        readTimeout: 60s\n        writeTimeout: 60s\n</code></pre></p>"},{"location":"operations/performance/#storage-performance","title":"Storage Performance","text":""},{"location":"operations/performance/#volume-configuration","title":"Volume Configuration","text":"<p>Use named volumes for databases:</p> <pre><code>volumes:\n  postgres_data:\n    driver: local\n    driver_opts:\n      type: none\n      o: bind\n      device: ${DATA_DIR}/postgres/data\n</code></pre>"},{"location":"operations/performance/#database-optimization","title":"Database Optimization","text":"<p>PostgreSQL: <pre><code>environment:\n  POSTGRES_INITDB_ARGS: \"-E UTF8 --locale=C\"\n  # Tune for your RAM\n  POSTGRES_SHARED_BUFFERS: \"256MB\"\n  POSTGRES_EFFECTIVE_CACHE_SIZE: \"1GB\"\n  POSTGRES_MAX_CONNECTIONS: \"100\"\n</code></pre></p> <p>Redict (Redis alternative): <pre><code>command: &gt;\n  --save 60 1000\n  --maxmemory 256mb\n  --maxmemory-policy allkeys-lru\n</code></pre></p>"},{"location":"operations/performance/#disk-io","title":"Disk I/O","text":"<p>Monitor disk performance: <pre><code>iostat -x 1\n</code></pre></p> <p>Use SSD for databases - Store database volumes on SSD for best performance.</p> <p>Mount options - Use <code>noatime</code> to reduce write operations: <pre><code>mount -o remount,noatime ${DATA_DIR}\n</code></pre></p>"},{"location":"operations/performance/#application-optimization","title":"Application Optimization","text":""},{"location":"operations/performance/#caching","title":"Caching","text":"<p>Enable application-level caching where available:</p> <p>Nextcloud: <pre><code>environment:\n  REDIS_HOST: redict\n  REDIS_HOST_PORT: 6379\n</code></pre></p> <p>Immich: <pre><code>environment:\n  IMMICH_MACHINE_LEARNING_ENABLED: \"true\"\n  IMMICH_MACHINE_LEARNING_URL: http://immich-ml:3003\n</code></pre></p>"},{"location":"operations/performance/#concurrent-connections","title":"Concurrent Connections","text":"<p>Tune application workers:</p> <p>Gunicorn-based apps: <pre><code>environment:\n  GUNICORN_WORKERS: 4\n  GUNICORN_THREADS: 2\n</code></pre></p> <p>Node.js apps: <pre><code>environment:\n  NODE_OPTIONS: \"--max-old-space-size=2048\"\n  UV_THREADPOOL_SIZE: 4\n</code></pre></p>"},{"location":"operations/performance/#container-optimization","title":"Container Optimization","text":""},{"location":"operations/performance/#multi-stage-builds","title":"Multi-stage Builds","text":"<p>For custom images, use multi-stage builds to reduce image size.</p>"},{"location":"operations/performance/#image-selection","title":"Image Selection","text":"<p>Prefer Alpine-based images when possible: - Smaller size - Faster startup - Lower memory footprint</p>"},{"location":"operations/performance/#restart-policies","title":"Restart Policies","text":"<p>Use appropriate restart policies:</p> <pre><code>restart: unless-stopped  # Recommended for most services\nrestart: always         # Critical services only\nrestart: on-failure     # Services that should stay down when intentionally stopped\n</code></pre>"},{"location":"operations/performance/#monitoring-performance","title":"Monitoring Performance","text":""},{"location":"operations/performance/#identify-bottlenecks","title":"Identify Bottlenecks","text":"<p>CPU bottlenecks: <pre><code>docker stats --format \"table {{.Name}}\\t{{.CPUPerc}}\" | sort -k 2 -h\n</code></pre></p> <p>Memory bottlenecks: <pre><code>docker stats --format \"table {{.Name}}\\t{{.MemPerc}}\" | sort -k 2 -h\n</code></pre></p> <p>I/O bottlenecks: <pre><code>docker stats --format \"table {{.Name}}\\t{{.BlockIO}}\"\n</code></pre></p> <p>Network bottlenecks: <pre><code>docker stats --format \"table {{.Name}}\\t{{.NetIO}}\"\n</code></pre></p>"},{"location":"operations/performance/#performance-metrics","title":"Performance Metrics","text":"<p>Track over time: - Response times (Traefik dashboard) - Database query times - Container startup times - Backup durations</p>"},{"location":"operations/performance/#scaling-strategies","title":"Scaling Strategies","text":""},{"location":"operations/performance/#horizontal-scaling","title":"Horizontal Scaling","text":"<p>For services that support it, deploy multiple instances:</p> <pre><code>deploy:\n  replicas: 3\n</code></pre>"},{"location":"operations/performance/#vertical-scaling","title":"Vertical Scaling","text":"<p>Increase resources for resource-constrained services:</p> <pre><code>deploy:\n  resources:\n    limits:\n      cpus: '4.0'\n      memory: 8G\n</code></pre>"},{"location":"operations/performance/#load-balancing","title":"Load Balancing","text":"<p>Use Traefik's load balancing for scaled services:</p> <pre><code>labels:\n  - traefik.http.services.myservice.loadbalancer.sticky.cookie=true\n</code></pre>"},{"location":"operations/performance/#system-level-optimization","title":"System-Level Optimization","text":""},{"location":"operations/performance/#kernel-parameters","title":"Kernel Parameters","text":"<p>Optimize for containerized workloads:</p> <pre><code># Increase file descriptors\nulimit -n 65536\n\n# Optimize network\nsysctl -w net.core.somaxconn=1024\nsysctl -w net.ipv4.tcp_max_syn_backlog=2048\n</code></pre>"},{"location":"operations/performance/#swap-configuration","title":"Swap Configuration","text":"<pre><code># Reduce swappiness for better performance\nsysctl vm.swappiness=10\n</code></pre>"},{"location":"operations/performance/#docker-daemon","title":"Docker Daemon","text":"<p>Optimize Docker daemon in <code>/etc/docker/daemon.json</code>:</p> <pre><code>{\n  \"log-driver\": \"json-file\",\n  \"log-opts\": {\n    \"max-size\": \"10m\",\n    \"max-file\": \"3\"\n  },\n  \"storage-driver\": \"overlay2\",\n  \"default-ulimits\": {\n    \"nofile\": {\n      \"Name\": \"nofile\",\n      \"Hard\": 64000,\n      \"Soft\": 64000\n    }\n  }\n}\n</code></pre>"},{"location":"operations/performance/#benchmarking","title":"Benchmarking","text":""},{"location":"operations/performance/#web-service-response-time","title":"Web Service Response Time","text":"<pre><code># Using curl\ncurl -w \"@curl-format.txt\" -o /dev/null -s https://service.yourdomain.com\n\n# curl-format.txt content:\n#     time_namelookup:  %{time_namelookup}\\n\n#        time_connect:  %{time_connect}\\n\n#     time_appconnect:  %{time_appconnect}\\n\n#    time_pretransfer:  %{time_pretransfer}\\n\n#       time_redirect:  %{time_redirect}\\n\n#  time_starttransfer:  %{time_starttransfer}\\n\n#                     ----------\\n\n#          time_total:  %{time_total}\\n\n</code></pre>"},{"location":"operations/performance/#database-performance","title":"Database Performance","text":"<pre><code># PostgreSQL\ndocker exec postgres pgbench -U user -d dbname -c 10 -t 100\n\n# Redict\ndocker exec redict redis-benchmark -h localhost -p 6379 -n 100000\n</code></pre>"},{"location":"operations/performance/#performance-checklist","title":"Performance Checklist","text":"<p>Initial Setup: - [ ] Set resource limits for all services - [ ] Use dedicated networks for isolation - [ ] Enable caching where available - [ ] Use SSD for databases</p> <p>Regular Optimization: - [ ] Monitor resource usage weekly - [ ] Identify and address bottlenecks - [ ] Review and adjust resource limits - [ ] Update to optimized image versions</p> <p>Scaling: - [ ] Identify services that need more resources - [ ] Consider horizontal scaling for stateless services - [ ] Implement load balancing where needed - [ ] Monitor performance after scaling changes</p>"},{"location":"operations/performance/#see-also","title":"See Also","text":"<ul> <li>Monitoring - Performance monitoring</li> <li>Maintenance - Regular maintenance</li> <li>Troubleshooting - Performance issues</li> </ul>"},{"location":"operations/troubleshooting/","title":"Troubleshooting","text":"<p>Common issues and solutions for Omakase homelab.</p>"},{"location":"operations/troubleshooting/#service-wont-start","title":"Service Won't Start","text":""},{"location":"operations/troubleshooting/#symptom","title":"Symptom","text":"<p>Service fails to start or immediately exits.</p>"},{"location":"operations/troubleshooting/#diagnosis","title":"Diagnosis","text":"<pre><code># Check service status\ndocker compose ps &lt;service&gt;\n\n# View logs\ndocker compose logs &lt;service&gt;\n\n# Inspect container\ndocker inspect &lt;container-name&gt;\n</code></pre>"},{"location":"operations/troubleshooting/#common-causes","title":"Common Causes","text":""},{"location":"operations/troubleshooting/#missing-secrets","title":"Missing Secrets","text":"<p>Error: <code>required variable ... not set</code></p> <p>Solution: Verify secrets in Infisical: <pre><code>make config | grep &lt;SERVICE&gt;\n</code></pre></p> <p>Add missing secrets to Infisical vault.</p>"},{"location":"operations/troubleshooting/#permission-issues","title":"Permission Issues","text":"<p>Error: <code>permission denied</code> in logs</p> <p>Solution: Fix directory permissions: <pre><code>chown -R ${PUID}:${PGID} ${DATA_DIR}/&lt;service&gt;\nchmod -R 755 ${DATA_DIR}/&lt;service&gt;\n</code></pre></p>"},{"location":"operations/troubleshooting/#port-conflicts","title":"Port Conflicts","text":"<p>Error: <code>port is already allocated</code></p> <p>Solution: Check which service is using the port: <pre><code>docker ps\nnetstat -tulpn | grep &lt;port&gt;\n</code></pre></p>"},{"location":"operations/troubleshooting/#network-conflicts","title":"Network Conflicts","text":"<p>Error: <code>network ... overlaps with other</code></p> <p>Solution: Check allocated subnets: <pre><code>make network\n</code></pre></p> <p>Adjust subnet in compose file to avoid conflicts.</p>"},{"location":"operations/troubleshooting/#infisical-authentication-fails","title":"Infisical Authentication Fails","text":""},{"location":"operations/troubleshooting/#symptom_1","title":"Symptom","text":"<p>Commands fail with authentication errors.</p>"},{"location":"operations/troubleshooting/#solution","title":"Solution","text":"<p>Verify environment variables: <pre><code>echo $INFISICAL_DOMAIN\necho $INFISICAL_PROJECT_ID\necho $INFISICAL_CLIENT_ID\n</code></pre></p> <p>Re-authenticate: <pre><code>infisical login\n</code></pre></p> <p>Check <code>.env</code> file or export variables: <pre><code>export INFISICAL_DOMAIN=\"your-domain\"\nexport INFISICAL_PROJECT_ID=\"your-project-id\"\nexport INFISICAL_CLIENT_ID=\"your-client-id\"\nexport INFISICAL_CLIENT_SECRET=\"your-client-secret\"\n</code></pre></p>"},{"location":"operations/troubleshooting/#cant-access-service","title":"Can't Access Service","text":""},{"location":"operations/troubleshooting/#symptom_2","title":"Symptom","text":"<p>Service not accessible via browser.</p>"},{"location":"operations/troubleshooting/#diagnosis_1","title":"Diagnosis","text":""},{"location":"operations/troubleshooting/#check-service-status","title":"Check Service Status","text":"<pre><code>docker compose ps &lt;service&gt;\n</code></pre>"},{"location":"operations/troubleshooting/#check-traefik-routing","title":"Check Traefik Routing","text":"<pre><code># View Traefik logs\ndocker compose logs traefik | grep &lt;service&gt;\n\n# Access Traefik dashboard\n# https://traefik.yourdomain.com\n</code></pre>"},{"location":"operations/troubleshooting/#check-dns","title":"Check DNS","text":"<pre><code>nslookup &lt;service&gt;.yourdomain.com\nping &lt;service&gt;.yourdomain.com\n</code></pre>"},{"location":"operations/troubleshooting/#common-causes_1","title":"Common Causes","text":""},{"location":"operations/troubleshooting/#dns-not-configured","title":"DNS Not Configured","text":"<p>Solution: Add DNS record pointing to server IP: <pre><code>*.yourdomain.com -&gt; your-server-ip\n</code></pre></p>"},{"location":"operations/troubleshooting/#authelia-blocking-access","title":"Authelia Blocking Access","text":"<p>Solution: Check Authelia logs: <pre><code>docker compose logs authelia\n</code></pre></p> <p>Verify user is authenticated and has access.</p>"},{"location":"operations/troubleshooting/#certificate-issues","title":"Certificate Issues","text":"<p>Error: SSL certificate errors</p> <p>Solution: Check Let's Encrypt logs: <pre><code>docker compose logs traefik | grep acme\n</code></pre></p> <p>Verify domain is publicly accessible on port 80/443.</p>"},{"location":"operations/troubleshooting/#wrong-network-configuration","title":"Wrong Network Configuration","text":"<p>Solution: Verify service is on <code>ingress</code> network: <pre><code>networks:\n  - ingress\n</code></pre></p>"},{"location":"operations/troubleshooting/#database-connection-fails","title":"Database Connection Fails","text":""},{"location":"operations/troubleshooting/#symptom_3","title":"Symptom","text":"<p>Service can't connect to database.</p>"},{"location":"operations/troubleshooting/#diagnosis_2","title":"Diagnosis","text":"<pre><code># Check database is running\ndocker compose ps postgres\n\n# Check database logs\ndocker compose logs postgres\n\n# Test connection from service container\ndocker exec &lt;service&gt; ping postgres\n</code></pre>"},{"location":"operations/troubleshooting/#solutions","title":"Solutions","text":""},{"location":"operations/troubleshooting/#database-not-ready","title":"Database Not Ready","text":"<p>Solution: Add healthcheck and depends_on: <pre><code>depends_on:\n  postgres:\n    condition: service_healthy\n</code></pre></p>"},{"location":"operations/troubleshooting/#wrong-database-credentials","title":"Wrong Database Credentials","text":"<p>Solution: Verify credentials in Infisical: <pre><code>make config | grep DB_\n</code></pre></p>"},{"location":"operations/troubleshooting/#network-isolation","title":"Network Isolation","text":"<p>Solution: Ensure both services on same network: <pre><code>networks:\n  - vnet-service\n</code></pre></p>"},{"location":"operations/troubleshooting/#backup-fails","title":"Backup Fails","text":""},{"location":"operations/troubleshooting/#symptom_4","title":"Symptom","text":"<p>Restic backup fails to complete.</p>"},{"location":"operations/troubleshooting/#diagnosis_3","title":"Diagnosis","text":"<pre><code># Check backup logs\ndocker compose logs backup\n\n# Test Backblaze connection\ndocker exec restic-backup restic snapshots\n</code></pre>"},{"location":"operations/troubleshooting/#common-causes_2","title":"Common Causes","text":""},{"location":"operations/troubleshooting/#invalid-backblaze-credentials","title":"Invalid Backblaze Credentials","text":"<p>Solution: Verify B2 credentials in Infisical: <pre><code>make config | grep B2_\n</code></pre></p>"},{"location":"operations/troubleshooting/#repository-locked","title":"Repository Locked","text":"<p>Error: <code>repository is already locked</code></p> <p>Solution: Unlock repository: <pre><code>docker exec restic-backup restic unlock\n</code></pre></p>"},{"location":"operations/troubleshooting/#storage-full","title":"Storage Full","text":"<p>Solution: Check repository size and prune: <pre><code>docker exec restic-backup restic stats\ndocker exec restic-backup restic prune\n</code></pre></p>"},{"location":"operations/troubleshooting/#high-resource-usage","title":"High Resource Usage","text":""},{"location":"operations/troubleshooting/#symptom_5","title":"Symptom","text":"<p>Server running slow, high CPU/memory usage.</p>"},{"location":"operations/troubleshooting/#diagnosis_4","title":"Diagnosis","text":"<pre><code># Check container resource usage\ndocker stats\n\n# Check system resources\nhtop\ndf -h\n</code></pre>"},{"location":"operations/troubleshooting/#solutions_1","title":"Solutions","text":""},{"location":"operations/troubleshooting/#memory-leak","title":"Memory Leak","text":"<p>Identify problematic container: <pre><code>docker stats --no-stream | sort -k 4 -h\n</code></pre></p> <p>Restart affected service: <pre><code>docker compose restart &lt;service&gt;\n</code></pre></p>"},{"location":"operations/troubleshooting/#too-many-services","title":"Too Many Services","text":"<p>Stop non-critical services: <pre><code>docker compose stop &lt;service&gt;\n</code></pre></p>"},{"location":"operations/troubleshooting/#insufficient-resources","title":"Insufficient Resources","text":"<p>Add resource limits to compose files: <pre><code>deploy:\n  resources:\n    limits:\n      cpus: '1.0'\n      memory: 1G\n</code></pre></p>"},{"location":"operations/troubleshooting/#crowdsec-blocking-legitimate-traffic","title":"CrowdSec Blocking Legitimate Traffic","text":""},{"location":"operations/troubleshooting/#symptom_6","title":"Symptom","text":"<p>Your IP is blocked by CrowdSec.</p>"},{"location":"operations/troubleshooting/#solution_1","title":"Solution","text":"<p>Check decisions: <pre><code>docker exec crowdsec cscli decisions list\n</code></pre></p> <p>Remove your IP: <pre><code>docker exec crowdsec cscli decisions delete --ip &lt;your-ip&gt;\n</code></pre></p> <p>Add IP to whitelist in CrowdSec config.</p>"},{"location":"operations/troubleshooting/#docker-socket-permission-denied","title":"Docker Socket Permission Denied","text":""},{"location":"operations/troubleshooting/#symptom_7","title":"Symptom","text":"<p>Error: <code>permission denied while trying to connect to Docker daemon</code></p>"},{"location":"operations/troubleshooting/#solution_2","title":"Solution","text":"<p>This should never happen - services should use Cetusguard proxy, not direct socket access.</p> <p>Check service is connecting to Cetusguard: <pre><code>environment:\n  DOCKER_HOST: tcp://cetusguard:2375\n</code></pre></p>"},{"location":"operations/troubleshooting/#configuration-validation-fails","title":"Configuration Validation Fails","text":""},{"location":"operations/troubleshooting/#symptom_8","title":"Symptom","text":"<p><code>make config</code> shows errors.</p>"},{"location":"operations/troubleshooting/#diagnosis_5","title":"Diagnosis","text":"<pre><code># Validate compose syntax\ndocker compose -f compose.yaml config\n\n# Check for missing secrets\nmake config 2&gt;&amp;1 | grep \"not set\"\n</code></pre>"},{"location":"operations/troubleshooting/#solutions_2","title":"Solutions","text":""},{"location":"operations/troubleshooting/#yaml-syntax-error","title":"YAML Syntax Error","text":"<p>Check compose file syntax: - Correct indentation (2 spaces) - No tabs - Proper quoting</p>"},{"location":"operations/troubleshooting/#missing-environment-variables","title":"Missing Environment Variables","text":"<p>Add to Infisical or <code>.env</code> file.</p>"},{"location":"operations/troubleshooting/#logs-not-appearing","title":"Logs Not Appearing","text":""},{"location":"operations/troubleshooting/#symptom_9","title":"Symptom","text":"<p><code>docker compose logs</code> shows no output.</p>"},{"location":"operations/troubleshooting/#solutions_3","title":"Solutions","text":""},{"location":"operations/troubleshooting/#check-log-driver","title":"Check Log Driver","text":"<p>Verify logging configuration: <pre><code>docker inspect &lt;container&gt; | grep LogConfig\n</code></pre></p>"},{"location":"operations/troubleshooting/#increase-log-retention","title":"Increase Log Retention","text":"<p>In compose file: <pre><code>logging:\n  options:\n    max-size: \"10m\"\n    max-file: \"3\"\n</code></pre></p>"},{"location":"operations/troubleshooting/#general-debugging-steps","title":"General Debugging Steps","text":"<ol> <li> <p>Check service logs:    <pre><code>docker compose logs -f &lt;service&gt;\n</code></pre></p> </li> <li> <p>Verify configuration:    <pre><code>make config\n</code></pre></p> </li> <li> <p>Check service status:    <pre><code>docker compose ps\n</code></pre></p> </li> <li> <p>Inspect container:    <pre><code>docker inspect &lt;container&gt;\n</code></pre></p> </li> <li> <p>Test connectivity:    <pre><code>docker exec &lt;container&gt; ping &lt;other-service&gt;\n</code></pre></p> </li> <li> <p>Check resource usage:    <pre><code>docker stats\n</code></pre></p> </li> <li> <p>Review recent changes:    <pre><code>git log --oneline -10\n</code></pre></p> </li> </ol>"},{"location":"operations/troubleshooting/#getting-help","title":"Getting Help","text":"<p>If you can't resolve the issue:</p> <ol> <li>Check GitHub Issues</li> <li>Review service-specific documentation in <code>docs/services/</code></li> <li>Check upstream documentation for the service</li> <li>Search for error messages in service logs</li> </ol>"},{"location":"operations/troubleshooting/#see-also","title":"See Also","text":"<ul> <li>Maintenance - Regular maintenance tasks</li> <li>Backup - Backup and restore procedures</li> <li>Installation - Initial setup</li> </ul>"},{"location":"security/","title":"Security","text":"<p>Security is a core principle of Omakase homelab infrastructure. This section covers security architecture, best practices, and management.</p>"},{"location":"security/#security-overview","title":"Security Overview","text":"<p>Omakase implements defense-in-depth with multiple security layers:</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 External Threats                            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n               \u2502\n        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n        \u2502   CrowdSec   \u2502  \u2190 Layer 1: Intrusion Prevention\n        \u2502     (IPS)    \u2502\n        \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n               \u2502\n        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n        \u2502   Authelia   \u2502  \u2190 Layer 2: Authentication\n        \u2502     (SSO)    \u2502\n        \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n               \u2502\n        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n        \u2502   Traefik    \u2502  \u2190 Layer 3: Reverse Proxy\n        \u2502  (Security   \u2502     + Security Headers\n        \u2502   Headers)   \u2502\n        \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n               \u2502\n        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n        \u2502   Network    \u2502  \u2190 Layer 4: Network Isolation\n        \u2502  Isolation   \u2502\n        \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n               \u2502\n        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n        \u2502  Container   \u2502  \u2190 Layer 5: Container Security\n        \u2502   Security   \u2502\n        \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n               \u2502\n        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n        \u2502   Secrets    \u2502  \u2190 Layer 6: Secret Management\n        \u2502  Management  \u2502\n        \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"security/#security-layers","title":"Security Layers","text":""},{"location":"security/#1-intrusion-prevention-crowdsec","title":"1. Intrusion Prevention (CrowdSec)","text":"<p>Purpose: Block malicious traffic before it reaches services.</p> <p>Features: - Real-time threat detection - Automatic IP blocking - Community threat intelligence - Attack pattern recognition</p> <p>Learn more: CrowdSec Documentation</p>"},{"location":"security/#2-authentication-authelia","title":"2. Authentication (Authelia)","text":"<p>Purpose: Verify user identity and enforce access control.</p> <p>Features: - Single Sign-On (SSO) - Two-Factor Authentication (2FA) - Fine-grained access control - Session management</p> <p>Learn more: Authelia Documentation</p>"},{"location":"security/#3-reverse-proxy-traefik","title":"3. Reverse Proxy (Traefik)","text":"<p>Purpose: Secure routing and SSL termination.</p> <p>Features: - Automatic SSL certificates - Security headers - Request filtering - Rate limiting</p> <p>Learn more: Traefik Documentation</p>"},{"location":"security/#4-network-isolation","title":"4. Network Isolation","text":"<p>Purpose: Segment services to limit blast radius.</p> <p>Features: - Per-service networks - Shared network minimization - No direct inter-service communication - Docker socket protection</p> <p>Learn more: Network Architecture</p>"},{"location":"security/#5-container-security","title":"5. Container Security","text":"<p>Purpose: Harden containers against compromise.</p> <p>Features: - No new privileges - Resource limits - Read-only filesystems where possible - Non-root execution</p> <p>Mandatory security options: <pre><code>security_opt:\n  - no-new-privileges:true\nuser: \"${PUID}:${PGID}\"\nread_only: true  # When possible\n</code></pre></p>"},{"location":"security/#6-secret-management","title":"6. Secret Management","text":"<p>Purpose: Secure storage and injection of credentials.</p> <p>Features: - External secret vault (Infisical) - Zero secrets in git - Environment variable injection - Encrypted storage</p> <p>Learn more: Secrets Management</p>"},{"location":"security/#security-checklist","title":"Security Checklist","text":""},{"location":"security/#initial-setup","title":"Initial Setup","text":"<ul> <li> Configure Infisical for secret management</li> <li> Generate strong passwords (use <code>make pwgen</code>)</li> <li> Set up Authelia users with 2FA</li> <li> Configure CrowdSec collections</li> <li> Enable automatic SSL certificates</li> <li> Review and configure access control rules</li> <li> Set up backup encryption</li> </ul>"},{"location":"security/#ongoing-maintenance","title":"Ongoing Maintenance","text":"<ul> <li> Review CrowdSec alerts weekly</li> <li> Rotate credentials quarterly</li> <li> Update Docker images regularly</li> <li> Monitor authentication logs</li> <li> Review user access permissions</li> <li> Test backup restores</li> <li> Audit security configurations</li> </ul>"},{"location":"security/#before-adding-services","title":"Before Adding Services","text":"<ul> <li> Review service security documentation</li> <li> Configure dedicated network (<code>vnet-service</code>)</li> <li> Set security options (<code>no-new-privileges</code>)</li> <li> Define resource limits</li> <li> Store secrets in Infisical</li> <li> Apply Authelia protection</li> <li> Test access controls</li> </ul>"},{"location":"security/#common-security-patterns","title":"Common Security Patterns","text":""},{"location":"security/#web-service-with-authentication","title":"Web Service with Authentication","text":"<pre><code>services:\n  myservice:\n    image: myservice:latest\n    container_name: myservice\n    restart: unless-stopped\n    security_opt:\n      - no-new-privileges:true\n    user: \"${PUID}:${PGID}\"\n    networks:\n      - ingress\n      - vnet-myservice\n    environment:\n      SECRET_KEY: \"${MYSERVICE_SECRET_KEY:?err}\"\n    deploy:\n      resources:\n        limits:\n          cpus: '1.0'\n          memory: 1G\n    labels:\n      - traefik.enable=true\n      - traefik.http.routers.myservice.rule=Host(`myservice.${DOMAINNAME}`)\n      - traefik.http.routers.myservice.middlewares=chain-authelia@file\n      - traefik.http.routers.myservice.tls.certresolver=letsencrypt\n</code></pre>"},{"location":"security/#database-service","title":"Database Service","text":"<pre><code>services:\n  myservice-db:\n    image: postgres:16\n    container_name: myservice-db\n    restart: unless-stopped\n    security_opt:\n      - no-new-privileges:true\n    user: \"${PUID}:${PGID}\"\n    networks:\n      - vnet-myservice  # Only on service network\n    environment:\n      POSTGRES_PASSWORD: \"${MYSERVICE_DB_PASSWORD:?err}\"\n    volumes:\n      - myservice_db_data:/var/lib/postgresql/data\n    deploy:\n      resources:\n        limits:\n          memory: 1G\n    # NO ingress network - not publicly accessible\n    # NO Traefik labels - no external access\n</code></pre>"},{"location":"security/#service-with-docker-api-access","title":"Service with Docker API Access","text":"<pre><code>services:\n  monitoring:\n    image: monitoring-tool:latest\n    container_name: monitoring\n    restart: unless-stopped\n    security_opt:\n      - no-new-privileges:true\n    networks:\n      - ingress\n      - vnet-socket  # For Docker API\n    environment:\n      DOCKER_HOST: tcp://cetusguard:2375  # Never direct socket!\n</code></pre>"},{"location":"security/#security-incidents","title":"Security Incidents","text":""},{"location":"security/#response-procedure","title":"Response Procedure","text":"<ol> <li> <p>Identify: Determine scope of incident    <pre><code>docker compose logs &lt;service&gt; | grep -i error\ndocker exec crowdsec cscli alerts list\n</code></pre></p> </li> <li> <p>Contain: Stop affected services    <pre><code>docker compose stop &lt;service&gt;\n</code></pre></p> </li> <li> <p>Investigate: Analyze logs and traffic    <pre><code>docker compose logs &lt;service&gt; &gt; incident.log\ndocker exec crowdsec cscli alerts inspect &lt;alert-id&gt;\n</code></pre></p> </li> <li> <p>Remediate: Fix vulnerability</p> </li> <li>Rotate compromised credentials</li> <li>Update vulnerable images</li> <li> <p>Adjust security rules</p> </li> <li> <p>Recover: Restore from backup if needed    <pre><code>docker exec restic-backup restic restore latest --target /restore\n</code></pre></p> </li> <li> <p>Review: Prevent recurrence</p> </li> <li>Document incident</li> <li>Update security policies</li> <li>Implement additional controls</li> </ol>"},{"location":"security/#indicators-of-compromise","title":"Indicators of Compromise","text":"<p>Watch for: - Unexpected authentication failures - Unusual resource usage - Modified configuration files - Unknown containers/images - Unexpected network connections - CrowdSec ban spikes</p>"},{"location":"security/#compliance-and-standards","title":"Compliance and Standards","text":""},{"location":"security/#applied-standards","title":"Applied Standards","text":"<p>Omakase follows industry best practices:</p> <ul> <li>CIS Docker Benchmark - Container hardening</li> <li>OWASP Top 10 - Web application security</li> <li>NIST Cybersecurity Framework - Risk management</li> <li>Zero Trust Architecture - Never trust, always verify</li> </ul>"},{"location":"security/#security-features-mapping","title":"Security Features Mapping","text":"Security Control Implementation Authentication Authelia SSO + 2FA Authorization Access control rules Encryption in Transit TLS via Traefik Encryption at Rest Restic backup encryption Network Segmentation Per-service networks Intrusion Detection CrowdSec IPS Secrets Management Infisical vault Container Hardening Security options + resource limits Audit Logging Docker logs + CrowdSec Backup &amp; Recovery Automated Restic backups"},{"location":"security/#security-resources","title":"Security Resources","text":""},{"location":"security/#documentation","title":"Documentation","text":"<ul> <li>Secrets Management - Credential handling</li> <li>Best Practices - Security guidelines</li> <li>CrowdSec - Intrusion prevention</li> <li>Authelia - Authentication</li> <li>Network Architecture - Network security</li> </ul>"},{"location":"security/#external-resources","title":"External Resources","text":"<ul> <li>CIS Docker Benchmark</li> <li>OWASP Top 10</li> <li>Docker Security</li> <li>Traefik Security</li> </ul>"},{"location":"security/#security-contact","title":"Security Contact","text":"<p>For security issues: - Report vulnerabilities via GitHub security advisories - Report vulnerabilities responsibly - Never commit sensitive data to git</p>"},{"location":"security/#quick-reference","title":"Quick Reference","text":""},{"location":"security/#check-security-status","title":"Check Security Status","text":"<pre><code># Service status\ndocker compose ps\n\n# CrowdSec alerts\ndocker exec crowdsec cscli alerts list\n\n# Failed auth attempts\ndocker compose logs authelia | grep \"authentication failed\"\n\n# Open ports\nsudo netstat -tulpn | grep LISTEN\n\n# Resource usage\ndocker stats\n</code></pre>"},{"location":"security/#emergency-actions","title":"Emergency Actions","text":"<pre><code># Block IP immediately\ndocker exec crowdsec cscli decisions add --ip 1.2.3.4 --duration 24h\n\n# Stop compromised service\ndocker compose stop &lt;service&gt;\n\n# Rotate credential\nmake pwgen\n# Update in Infisical\ndocker compose restart &lt;service&gt;\n\n# Full shutdown\nmake down\n</code></pre>"},{"location":"security/#see-also","title":"See Also","text":"<ul> <li>Installation - Secure setup</li> <li>Operations - Security maintenance</li> <li>Deployment - Secure deployment</li> </ul>"},{"location":"security/best-practices/","title":"Security Best Practices","text":"<p>Comprehensive security guidelines for managing Omakase homelab.</p>"},{"location":"security/best-practices/#core-principles","title":"Core Principles","text":""},{"location":"security/best-practices/#1-defense-in-depth","title":"1. Defense in Depth","text":"<p>Never rely on a single security control. Layer multiple protections:</p> <pre><code>External Request\n  \u2192 CrowdSec (Block malicious IPs)\n  \u2192 Traefik (SSL + Security headers)\n  \u2192 Authelia (Authentication + 2FA)\n  \u2192 Network Isolation (Limit access)\n  \u2192 Container Security (Hardened config)\n  \u2192 Application (Service-specific security)\n</code></pre>"},{"location":"security/best-practices/#2-least-privilege","title":"2. Least Privilege","text":"<p>Grant minimum necessary permissions:</p> <ul> <li>Services only connect to required networks</li> <li>Use read-only filesystems where possible</li> <li>Non-root container execution</li> <li>Limited Docker API access via Cetusguard</li> <li>Restrictive access control rules</li> </ul>"},{"location":"security/best-practices/#3-zero-trust","title":"3. Zero Trust","text":"<p>Never trust, always verify:</p> <ul> <li>Authenticate every request (Authelia)</li> <li>Verify even internal traffic</li> <li>Don't skip security for \"internal\" services</li> <li>Assume breach, limit blast radius</li> </ul>"},{"location":"security/best-practices/#4-security-by-default","title":"4. Security by Default","text":"<p>Secure out of the box:</p> <ul> <li>All services protected by Authelia</li> <li>Automatic SSL certificates</li> <li>Network isolation by default</li> <li>Security options mandatory</li> <li>Secrets never in git</li> </ul>"},{"location":"security/best-practices/#secret-management","title":"Secret Management","text":""},{"location":"security/best-practices/#rule-1-never-commit-secrets","title":"Rule #1: Never Commit Secrets","text":"<p>NEVER in git: - \u274c Passwords - \u274c API keys - \u274c Tokens - \u274c Private keys - \u274c Certificates</p> <p>Always in Infisical: - \u2705 All credentials - \u2705 Environment variables - \u2705 Service secrets - \u2705 API tokens</p>"},{"location":"security/best-practices/#generate-strong-secrets","title":"Generate Strong Secrets","text":"<pre><code># Use pwgen for passwords\nmake pwgen\n\n# For API keys (32 bytes)\nopenssl rand -hex 32\n\n# For tokens (64 bytes)\nopenssl rand -base64 64\n</code></pre>"},{"location":"security/best-practices/#secret-rotation","title":"Secret Rotation","text":"<p>Rotate credentials regularly:</p> <p>Quarterly: - Service passwords - API keys - Database passwords</p> <p>Annually: - SSL certificates (automatic with Let's Encrypt) - SSH keys - Backup encryption keys</p> <p>Immediately: - After suspected compromise - When employee leaves (if shared homelab) - After sharing access temporarily</p>"},{"location":"security/best-practices/#secret-naming-convention","title":"Secret Naming Convention","text":"<p>Use consistent naming: <pre><code>&lt;SERVICE&gt;_&lt;COMPONENT&gt;_&lt;PURPOSE&gt;\n\nExamples:\nNEXTCLOUD_DB_PASSWORD\nVAULTWARDEN_ADMIN_TOKEN\nTRAEFIK_ACME_EMAIL\n</code></pre></p>"},{"location":"security/best-practices/#container-security","title":"Container Security","text":""},{"location":"security/best-practices/#mandatory-security-options","title":"Mandatory Security Options","text":"<p>Every service MUST have:</p> <pre><code>security_opt:\n  - no-new-privileges:true\n</code></pre> <p>This prevents privilege escalation within containers.</p>"},{"location":"security/best-practices/#user-permissions","title":"User Permissions","text":"<p>Run as non-root:</p> <pre><code>user: \"${PUID}:${PGID}\"  # Typically 1000:1000\n</code></pre> <p>Benefits: - Limits damage if container compromised - Prevents host file system modification - Follows least privilege principle</p>"},{"location":"security/best-practices/#resource-limits","title":"Resource Limits","text":"<p>Always set limits:</p> <pre><code>deploy:\n  resources:\n    limits:\n      cpus: '2.0'\n      memory: 2G\n    reservations:\n      cpus: '0.5'\n      memory: 512M\n</code></pre> <p>Prevents: - Resource exhaustion attacks - Runaway processes - Service starvation - System crashes</p>"},{"location":"security/best-practices/#read-only-filesystems","title":"Read-Only Filesystems","text":"<p>Use when possible:</p> <pre><code>read_only: true\ntmpfs:\n  - /tmp\n  - /var/run\n</code></pre> <p>Not always possible (services need write access), but use when you can.</p>"},{"location":"security/best-practices/#drop-capabilities","title":"Drop Capabilities","text":"<p>Remove unnecessary Linux capabilities:</p> <pre><code>cap_drop:\n  - ALL\ncap_add:\n  - NET_BIND_SERVICE  # Only if needed\n</code></pre>"},{"location":"security/best-practices/#network-security","title":"Network Security","text":""},{"location":"security/best-practices/#network-isolation-rules","title":"Network Isolation Rules","text":"<ol> <li> <p>Every service gets own network:    <pre><code>networks:\n  vnet-myservice:\n    name: vnet-myservice\n</code></pre></p> </li> <li> <p>Only connect to required networks:    <pre><code>networks:\n  - ingress  # Only if web-accessible\n  - vnet-myservice  # Always\n</code></pre></p> </li> <li> <p>Never connect databases to ingress:    <pre><code>services:\n  myservice-db:\n    networks:\n      - vnet-myservice  # NOT ingress\n</code></pre></p> </li> <li> <p>Use Cetusguard for Docker API:    <pre><code>environment:\n  DOCKER_HOST: tcp://cetusguard:2375\n</code></pre> NEVER mount Docker socket directly.</p> </li> </ol>"},{"location":"security/best-practices/#firewall-configuration","title":"Firewall Configuration","text":"<p>Host firewall (UFW): <pre><code># Default deny\nsudo ufw default deny incoming\nsudo ufw default allow outgoing\n\n# Allow SSH\nsudo ufw allow 22/tcp\n\n# Allow HTTP/HTTPS\nsudo ufw allow 80/tcp\nsudo ufw allow 443/tcp\n\n# Allow WireGuard (if used)\nsudo ufw allow 51820/udp\n\n# Enable\nsudo ufw enable\n</code></pre></p>"},{"location":"security/best-practices/#port-exposure","title":"Port Exposure","text":"<p>Minimize exposed ports: - Only expose 80/443 (Traefik) - WireGuard port if using VPN - SSH port (consider non-standard port)</p> <p>Never expose: - Database ports - Admin interfaces directly - Docker API - Internal services</p>"},{"location":"security/best-practices/#authentication","title":"Authentication","text":""},{"location":"security/best-practices/#authelia-configuration","title":"Authelia Configuration","text":"<p>Require 2FA for sensitive services:</p> <pre><code>access_control:\n  rules:\n    - domain:\n        - \"vaultwarden.yourdomain.com\"\n        - \"portainer.yourdomain.com\"\n      policy: two_factor\n      subject:\n        - \"group:admins\"\n</code></pre> <p>Use one_factor for regular services: <pre><code>    - domain: \"*.yourdomain.com\"\n      policy: one_factor\n</code></pre></p> <p>Never use bypass unless necessary: <pre><code>    - domain: \"public.yourdomain.com\"\n      policy: bypass  # Only for truly public services\n</code></pre></p>"},{"location":"security/best-practices/#password-requirements","title":"Password Requirements","text":"<p>Minimum standards: - 16+ characters for admin accounts - 12+ characters for user accounts - Mix of uppercase, lowercase, numbers, symbols - No dictionary words - Unique per service</p> <p>Use password manager: - Bitwarden/Vaultwarden - KeePass - 1Password</p>"},{"location":"security/best-practices/#2fa-enforcement","title":"2FA Enforcement","text":"<p>Require for: - All admin accounts - Sensitive services (password manager, admin panels) - Services with financial data - Services with personal data</p> <p>2FA methods: 1. TOTP (recommended) - Google Authenticator, Authy 2. WebAuthn (most secure) - YubiKey, hardware keys 3. Duo Push (convenient) - Push notifications</p>"},{"location":"security/best-practices/#backup-security","title":"Backup Security","text":""},{"location":"security/best-practices/#encrypted-backups","title":"Encrypted Backups","text":"<p>Always encrypt: <pre><code>environment:\n  RESTIC_PASSWORD: \"${RESTIC_PASSWORD:?err}\"\n</code></pre></p> <p>Benefits: - Protection if backup storage compromised - Compliance with data protection regulations - Peace of mind</p>"},{"location":"security/best-practices/#backup-storage","title":"Backup Storage","text":"<p>3-2-1 Rule: - 3 copies of data - 2 different storage types - 1 off-site copy</p> <p>Omakase implementation: - Primary: Production data in <code>${DATA_DIR}</code> - Secondary: Encrypted Restic repository - Off-site: Backblaze B2 cloud storage</p>"},{"location":"security/best-practices/#test-restores","title":"Test Restores","text":"<p>Monthly: Perform test restore to verify backups work.</p> <pre><code># Test restore\ndocker exec restic-backup restic restore latest --target /tmp/restore-test\n\n# Verify data integrity\nls -la /tmp/restore-test\n\n# Cleanup\nrm -rf /tmp/restore-test\n</code></pre>"},{"location":"security/best-practices/#backup-access-control","title":"Backup Access Control","text":"<p>Limit backup access: - Separate Backblaze credentials from other services - Restrict who can delete backups - Enable MFA on Backblaze account - Monitor backup notifications</p>"},{"location":"security/best-practices/#monitoring-and-logging","title":"Monitoring and Logging","text":""},{"location":"security/best-practices/#log-everything","title":"Log Everything","text":"<p>Enable logging for: - Authentication attempts (Authelia) - Access logs (Traefik) - Security events (CrowdSec) - Container logs (Docker) - System logs (syslog)</p>"},{"location":"security/best-practices/#review-logs-regularly","title":"Review Logs Regularly","text":"<p>Daily: <pre><code># Failed authentication\ndocker compose logs authelia | grep \"authentication failed\"\n\n# CrowdSec blocks\ndocker exec crowdsec cscli decisions list\n\n# Service errors\ndocker compose logs --since 24h | grep -i error\n</code></pre></p> <p>Weekly: <pre><code># Security alerts\ndocker exec crowdsec cscli alerts list\n\n# Resource usage anomalies\ndocker stats --no-stream\n\n# Unusual network activity\ndocker compose logs traefik | grep \"5xx\"\n</code></pre></p>"},{"location":"security/best-practices/#alerting","title":"Alerting","text":"<p>Set up notifications: - Backup failures \u2192 Telegram - Authentication failures \u2192 Email (Authelia) - CrowdSec bans \u2192 Review dashboard - Service outages \u2192 Uptime Kuma</p>"},{"location":"security/best-practices/#update-management","title":"Update Management","text":""},{"location":"security/best-practices/#regular-updates","title":"Regular Updates","text":"<p>Weekly: Pull latest images <pre><code>make pull\nmake restart\n</code></pre></p> <p>Monthly: Update dependencies - Review Renovate PRs - Test in development - Deploy to production</p>"},{"location":"security/best-practices/#security-updates","title":"Security Updates","text":"<p>Immediate: Apply critical security patches <pre><code># Pull specific image\ndocker pull service:version\n\n# Restart service\ndocker compose restart service\n</code></pre></p>"},{"location":"security/best-practices/#update-strategy","title":"Update Strategy","text":"<ol> <li>Read changelog - Understand changes</li> <li>Test in dev - Use compose.dev.yaml</li> <li>Backup first - Create snapshot</li> <li>Deploy - Update production</li> <li>Verify - Test functionality</li> <li>Monitor - Watch logs</li> </ol>"},{"location":"security/best-practices/#incident-response","title":"Incident Response","text":""},{"location":"security/best-practices/#preparation","title":"Preparation","text":"<p>Before incident: - Document recovery procedures - Keep backups tested and accessible - Have contact information ready - Know how to isolate services</p>"},{"location":"security/best-practices/#detection","title":"Detection","text":"<p>Monitor for: - CrowdSec alert spikes - Failed authentication patterns - Unusual resource usage - Modified files in <code>${DATA_DIR}</code> - Unknown containers</p>"},{"location":"security/best-practices/#response-steps","title":"Response Steps","text":"<ol> <li> <p>Identify:    <pre><code>docker compose logs &lt;service&gt;\ndocker exec crowdsec cscli alerts list\n</code></pre></p> </li> <li> <p>Contain:    <pre><code>docker compose stop &lt;service&gt;\ndocker exec crowdsec cscli decisions add --ip &lt;ip&gt;\n</code></pre></p> </li> <li> <p>Eradicate:    <pre><code># Rotate credentials\nmake pwgen\n# Update in Infisical\n\n# Update vulnerable image\ndocker pull service:patched-version\n</code></pre></p> </li> <li> <p>Recover:    <pre><code># Restore from backup if needed\ndocker exec restic-backup restic restore &lt;snapshot-id&gt;\n\n# Restart service\ndocker compose up -d &lt;service&gt;\n</code></pre></p> </li> <li> <p>Lessons Learned:</p> </li> <li>Document incident</li> <li>Update security controls</li> <li>Review and improve monitoring</li> </ol>"},{"location":"security/best-practices/#access-control","title":"Access Control","text":""},{"location":"security/best-practices/#user-management","title":"User Management","text":"<p>Principle: Minimize user accounts</p> <p>Admin accounts: - Enable 2FA - Strong passwords - Regular access reviews - Audit logs monitoring</p> <p>Regular users: - Enable 2FA when possible - Access only to needed services - Time-limited access for temporary users</p>"},{"location":"security/best-practices/#service-access","title":"Service Access","text":"<p>Internal-only services: <pre><code>access_control:\n  rules:\n    - domain: \"internal-admin.yourdomain.com\"\n      policy: two_factor\n      subject:\n        - \"group:admins\"\n      networks:\n        - 192.168.1.0/24  # Only from home network\n</code></pre></p> <p>Shared services: <pre><code>    - domain: \"shared.yourdomain.com\"\n      policy: one_factor\n      subject:\n        - \"group:users\"\n</code></pre></p>"},{"location":"security/best-practices/#api-access","title":"API Access","text":"<p>Service-to-service: - Use API keys, not passwords - Store in Infisical - Rotate regularly - Minimal scope</p> <p>External APIs: - Separate keys per service - Monitor usage - Implement rate limiting - Validate all input</p>"},{"location":"security/best-practices/#compliance","title":"Compliance","text":""},{"location":"security/best-practices/#data-protection","title":"Data Protection","text":"<p>Minimize data collection: - Only collect necessary data - Delete old logs - Encrypt sensitive data</p> <p>User privacy: - Transparent about data usage - Provide data export if shared homelab - Secure deletion procedures</p>"},{"location":"security/best-practices/#audit-trail","title":"Audit Trail","text":"<p>Maintain logs for: - Authentication attempts - Configuration changes - Backup operations - Security events</p> <p>Retention: 90 days minimum</p>"},{"location":"security/best-practices/#security-checklist","title":"Security Checklist","text":""},{"location":"security/best-practices/#daily","title":"Daily","text":"<ul> <li> Check service status: <code>docker compose ps</code></li> <li> Review failed logins: <code>docker compose logs authelia | grep failed</code></li> <li> Check CrowdSec blocks: <code>docker exec crowdsec cscli decisions list</code></li> </ul>"},{"location":"security/best-practices/#weekly","title":"Weekly","text":"<ul> <li> Pull image updates: <code>make pull</code></li> <li> Review CrowdSec alerts: <code>docker exec crowdsec cscli alerts list</code></li> <li> Check disk usage: <code>df -h</code></li> <li> Review backup status: <code>docker compose logs backup</code></li> </ul>"},{"location":"security/best-practices/#monthly","title":"Monthly","text":"<ul> <li> Test backup restore</li> <li> Review user access</li> <li> Update collections: <code>docker exec crowdsec cscli collections upgrade --all</code></li> <li> Review security logs</li> <li> Check for security advisories</li> </ul>"},{"location":"security/best-practices/#quarterly","title":"Quarterly","text":"<ul> <li> Rotate passwords</li> <li> Security audit</li> <li> Review access control rules</li> <li> Update documentation</li> <li> Disaster recovery drill</li> </ul>"},{"location":"security/best-practices/#red-flags","title":"Red Flags","text":"<p>Investigate immediately if: - Unexpected authentication failures - Unknown containers running - Unusual network traffic - Modified configuration files - Disabled security features - Missing logs - Backup failures - CPU/memory spikes - CrowdSec ban surge</p>"},{"location":"security/best-practices/#resources","title":"Resources","text":""},{"location":"security/best-practices/#tools","title":"Tools","text":"<ul> <li>Gitleaks - Secret detection</li> <li>Trivy - Container vulnerability scanning</li> <li>Docker Bench - CIS benchmark</li> </ul>"},{"location":"security/best-practices/#learning","title":"Learning","text":"<ul> <li>Docker Security Docs</li> <li>OWASP Top 10</li> <li>CIS Docker Benchmark</li> <li>CrowdSec Documentation</li> </ul>"},{"location":"security/best-practices/#see-also","title":"See Also","text":"<ul> <li>Secrets Management - Credential handling</li> <li>Security Overview - Security architecture</li> <li>CrowdSec - Intrusion prevention</li> <li>Authelia - Authentication</li> </ul>"},{"location":"security/secrets-management/","title":"Secrets Management with Infisical","text":"<p>Omakase uses Infisical as the central secrets management solution. All sensitive data (passwords, API keys, tokens) are stored in Infisical vault and injected at runtime.</p> <p>Security First</p> <p>NEVER commit secrets to git. All secrets must be stored in Infisical or another secure vault.</p>"},{"location":"security/secrets-management/#why-infisical","title":"Why Infisical?","text":"<ul> <li>Centralized: Single source of truth for all secrets</li> <li>Encrypted: End-to-end encryption at rest and in transit</li> <li>Access Control: Role-based permissions and audit logs</li> <li>Versioning: Track secret changes over time</li> <li>Multi-Environment: Separate dev, staging, prod secrets</li> <li>Developer Friendly: CLI integration with Docker Compose</li> </ul>"},{"location":"security/secrets-management/#deployment-options","title":"Deployment Options","text":""},{"location":"security/secrets-management/#option-a-infisical-cloud-easiest","title":"Option A: Infisical Cloud (Easiest)","text":"<p>Best for: Quick start, no additional infrastructure</p> <p>Pros: - No setup required - Always available - Automatic backups - Free tier for personal use</p> <p>Cons: - External dependency - Secrets stored outside your network (encrypted) - Requires internet connection</p> <p>Setup:</p> <ol> <li>Sign up at Infisical Cloud</li> <li>Create organization</li> <li>Create project \"omakase\"</li> <li>Create environments: <code>dev</code>, <code>prod</code></li> <li>Generate Machine Identity (for CLI auth)</li> </ol>"},{"location":"security/secrets-management/#infisical-self-hosted","title":"Option B: Infisical Self-Hosted (Recommended)","text":"<p>Best for: Homelab, complete control, air-gapped</p> <p>Pros: - Full control and privacy - No external dependencies - Free and open source - Can run alongside Omakase</p> <p>Cons: - Requires additional infrastructure - Manual backup responsibility</p> <p>Setup Guide Below \u2b07\ufe0f</p>"},{"location":"security/secrets-management/#self-hosted-infisical-setup","title":"Self-Hosted Infisical Setup","text":""},{"location":"security/secrets-management/#prerequisites","title":"Prerequisites","text":"<ul> <li>Separate server/VM/LXC container</li> <li>2 CPU cores</li> <li>2 GB RAM</li> <li>20 GB storage</li> <li>Docker + Docker Compose</li> </ul>"},{"location":"security/secrets-management/#step-1-prepare-infrastructure","title":"Step 1: Prepare Infrastructure","text":""},{"location":"security/secrets-management/#on-proxmox-recommended-setup","title":"On Proxmox (Recommended Setup)","text":"<pre><code># Create LXC container on Proxmox host\npct create 101 \\\n  local:vztmpl/debian-12-standard_12.2-1_amd64.tar.zst \\\n  --hostname infisical \\\n  --cores 2 \\\n  --memory 2048 \\\n  --swap 512 \\\n  --storage local-lvm \\\n  --rootfs local-lvm:20 \\\n  --net0 name=eth0,bridge=vmbr0,ip=192.168.1.101/24,gw=192.168.1.1\n\n# Enable Docker support\npct set 101 -features nesting=1,keyctl=1\n\n# Start container\npct start 101\npct enter 101\n</code></pre>"},{"location":"security/secrets-management/#on-bare-metal-vm","title":"On Bare Metal / VM","text":"<pre><code># Just use your existing Linux system\n# Ensure Docker is installed (see Prerequisites)\n</code></pre>"},{"location":"security/secrets-management/#step-2-install-docker","title":"Step 2: Install Docker","text":"<pre><code># Install Docker (if not already installed)\ncurl -fsSL https://get.docker.com -o get-docker.sh\nsudo sh get-docker.sh\n\n# Verify\ndocker --version\ndocker compose version\n</code></pre>"},{"location":"security/secrets-management/#step-3-deploy-infisical","title":"Step 3: Deploy Infisical","text":"<pre><code># Create directory\nmkdir -p /opt/infisical\ncd /opt/infisical\n\n# Download production docker-compose\ncurl -o docker-compose.yml https://raw.githubusercontent.com/Infisical/infisical/main/docker-compose.prod.yml\n\n# Generate encryption keys\ncat &gt; .env &lt;&lt;EOF\n# Infisical Core Configuration\nENCRYPTION_KEY=$(openssl rand -hex 32)\nJWT_SECRET=$(openssl rand -hex 32)\n\n# MongoDB Connection\nMONGO_URL=mongodb://mongo:27017/infisical\n\n# Frontend Configuration\nSITE_URL=https://infisical.yourdomain.com  # Change to your domain\nNEXT_PUBLIC_INFISICAL_URL=https://infisical.yourdomain.com\n\n# Mail Configuration (Optional, for invites/notifications)\n# SMTP_HOST=smtp.gmail.com\n# SMTP_PORT=587\n# SMTP_FROM=noreply@yourdomain.com\n# SMTP_USERNAME=your-email@gmail.com\n# SMTP_PASSWORD=your-app-password\nEOF\n\n# Secure .env file\nchmod 600 .env\n\n# Start Infisical\ndocker compose up -d\n\n# Check status\ndocker compose ps\ndocker compose logs -f infisical\n</code></pre>"},{"location":"security/secrets-management/#step-4-initial-configuration","title":"Step 4: Initial Configuration","text":"<ol> <li> <p>Access Infisical: Open browser to <code>https://infisical.yourdomain.com</code> (or <code>http://192.168.1.101:80</code> for local)</p> </li> <li> <p>Complete Setup Wizard:</p> </li> <li>Create admin account</li> <li>Set up organization</li> <li> <p>Create first project</p> </li> <li> <p>Create Project for Omakase:</p> </li> <li>Name: <code>omakase</code></li> <li> <p>Environments: <code>dev</code>, <code>prod</code></p> </li> <li> <p>Generate Machine Identity (for Omakase CLI):</p> </li> <li>Project Settings \u2192 Machine Identities \u2192 Create</li> <li>Name: <code>omakase-deployment</code></li> <li>Permissions: Read/Write on all environments</li> <li>Save <code>Client ID</code> and <code>Client Secret</code></li> </ol>"},{"location":"security/secrets-management/#step-5-configure-ssl-production","title":"Step 5: Configure SSL (Production)","text":""},{"location":"security/secrets-management/#option-a-lets-encrypt-via-traefik","title":"Option A: Let's Encrypt via Traefik","text":"<p>Add labels to Infisical frontend container in <code>docker-compose.yml</code>:</p> <pre><code>services:\n  infisical:\n    labels:\n      - traefik.enable=true\n      - traefik.http.routers.infisical.rule=Host(`infisical.yourdomain.com`)\n      - traefik.http.routers.infisical.entrypoints=websecure\n      - traefik.http.routers.infisical.tls.certresolver=letsencrypt\n      - traefik.http.services.infisical.loadbalancer.server.port=8080\n</code></pre>"},{"location":"security/secrets-management/#option-b-reverse-proxy-haproxy-nginx","title":"Option B: Reverse Proxy (HAProxy, Nginx)","text":"<p>Configure your external reverse proxy to forward to <code>http://192.168.1.101:80</code>.</p> <p>See Proxmox LXC deployment guide for HAProxy example.</p>"},{"location":"security/secrets-management/#omakase-integration","title":"Omakase Integration","text":""},{"location":"security/secrets-management/#step-1-install-infisical-cli","title":"Step 1: Install Infisical CLI","text":"<p>On your Omakase host:</p> <pre><code># Install Infisical CLI\ncurl -1sLf 'https://dl.cloudsmith.io/public/infisical/infisical-cli/setup.deb.sh' | sudo bash\nsudo apt update\nsudo apt install -y infisical\n\n# Verify installation\ninfisical --version\n</code></pre>"},{"location":"security/secrets-management/#step-2-configure-omakase-env","title":"Step 2: Configure Omakase .env","text":"<p>In your Omakase project directory:</p> <pre><code>cd ~/omakase\n\n# Create .env file (NEVER commit this!)\ncat &gt; .env &lt;&lt;EOF\n# Infisical Configuration\nINFISICAL_DOMAIN=https://infisical.yourdomain.com  # or http://192.168.1.101\nINFISICAL_PROJECT_ID=&lt;project-id-from-settings&gt;\nINFISICAL_CLIENT_ID=&lt;machine-identity-client-id&gt;\nINFISICAL_CLIENT_SECRET=&lt;machine-identity-client-secret&gt;\nEOF\n\n# Secure .env\nchmod 600 .env\n\n# Add to .gitignore\necho \".env\" &gt;&gt; .gitignore\n</code></pre>"},{"location":"security/secrets-management/#step-3-populate-secrets-in-infisical","title":"Step 3: Populate Secrets in Infisical","text":"<p>Access Infisical Web UI and add secrets to the <code>omakase</code> project:</p>"},{"location":"security/secrets-management/#required-base-secrets-environment-dev","title":"Required Base Secrets (Environment: <code>dev</code>)","text":"<pre><code># Path Configuration\nDATA_DIR=/home/omakase/omakase/data\nCOMPOSE_PROJECT_NAME=omakase\n\n# Domain Configuration\nDOMAINNAME=yourdomain.com\nTRAEFIK_DOMAIN=traefik.yourdomain.com\n\n# Network Configuration\nTRAEFIK_TRUSTED_IPS=192.168.0.0/16,172.16.0.0/12\n\n# User/Group (match your host user)\nPUID=1000\nPGID=1000\nTZ=Europe/Rome  # Your timezone\n\n# PostgreSQL\nPOSTGRES_PASSWORD=&lt;generate-secure-password&gt;\n\n# Authelia Database\nAUTHELIA_DB_PASSWORD=&lt;generate-secure-password&gt;\n\n# Authelia Secrets (generate with: openssl rand -hex 32)\nAUTHELIA_JWT_SECRET=&lt;hex-32&gt;\nAUTHELIA_SESSION_SECRET=&lt;hex-32&gt;\nAUTHELIA_STORAGE_ENCRYPTION_KEY=&lt;hex-32&gt;\n\n# Traefik Dashboard\nTRAEFIK_API_USER=admin\nTRAEFIK_API_PASSWORD=&lt;generate-secure-password&gt;\n\n# Backup (Restic + Backblaze B2)\nRESTIC_PASSWORD=&lt;generate-secure-password&gt;\nB2_ACCOUNT_ID=&lt;backblaze-key-id&gt;\nB2_ACCOUNT_KEY=&lt;backblaze-app-key&gt;\nRESTIC_REPOSITORY=b2:&lt;bucket-name&gt;:omakase\n\n# Notifications (Optional)\nTELEGRAM_BOT_TOKEN=&lt;telegram-bot-token&gt;\nTELEGRAM_CHAT_ID=&lt;telegram-chat-id&gt;\n</code></pre>"},{"location":"security/secrets-management/#generate-secure-passwords","title":"Generate Secure Passwords","text":"<pre><code># Random password\nopenssl rand -base64 32\n\n# Hex secret (for JWT, encryption keys)\nopenssl rand -hex 32\n\n# Using Makefile\nmake pwgen\n</code></pre>"},{"location":"security/secrets-management/#service-specific-secrets","title":"Service-Specific Secrets","text":"<p>As you enable more services, add their secrets following the naming pattern:</p> <pre><code>&lt;SERVICE&gt;_&lt;COMPONENT&gt;_&lt;PURPOSE&gt;\n</code></pre> <p>Examples: <pre><code>NEXTCLOUD_DB_PASSWORD=&lt;password&gt;\nNEXTCLOUD_ADMIN_PASSWORD=&lt;password&gt;\nJELLYFIN_API_KEY=&lt;key&gt;\nSONARR_API_KEY=&lt;key&gt;\n</code></pre></p>"},{"location":"security/secrets-management/#step-4-test-integration","title":"Step 4: Test Integration","text":"<pre><code>cd ~/omakase\n\n# Test Infisical connection\ninfisical export --env=dev\n\n# Should output all secrets (don't run in untrusted environments!)\n\n# Test Docker Compose with secret injection\nmake config\n\n# Verify secrets are injected (look for values, not ${VAR})\nmake config | grep POSTGRES_PASSWORD\n</code></pre>"},{"location":"security/secrets-management/#using-secrets-in-compose-files","title":"Using Secrets in Compose Files","text":""},{"location":"security/secrets-management/#standard-environment-variable-syntax","title":"Standard Environment Variable Syntax","text":"<pre><code>services:\n  myservice:\n    image: myimage:latest\n    environment:\n      # Required variable (will fail if not in Infisical)\n      DB_PASSWORD: \"${POSTGRES_PASSWORD:?err}\"\n\n      # Optional with default\n      DB_HOST: \"${DB_HOST:-postgres}\"\n\n      # Simple reference\n      DB_USER: \"${DB_USER}\"\n</code></pre>"},{"location":"security/secrets-management/#template-syntax-alternative","title":"Template Syntax (Alternative)","text":"<p>Some services use Go template syntax:</p> <pre><code>services:\n  myservice:\n    image: myimage:latest\n    environment:\n      API_KEY: \"{{env \\\"SERVICE_API_KEY\\\"}}\"\n</code></pre>"},{"location":"security/secrets-management/#secrets-in-config-files","title":"Secrets in Config Files","text":"<p>For services that load config from files:</p> <pre><code># compose/myservice/config/config.yml\ndatabase:\n  password: \"${MYSERVICE_DB_PASSWORD}\"\n</code></pre> <p>Mount as volume:</p> <pre><code>services:\n  myservice:\n    volumes:\n      - ./compose/myservice/config:/config:ro\n</code></pre>"},{"location":"security/secrets-management/#secret-rotation","title":"Secret Rotation","text":""},{"location":"security/secrets-management/#rotating-secrets","title":"Rotating Secrets","text":"<ol> <li>Update in Infisical: Change the secret value in Infisical UI</li> <li>Restart services: <code>make restart</code> or <code>docker compose restart &lt;service&gt;</code></li> <li>Verify: Check service logs for successful authentication</li> </ol>"},{"location":"security/secrets-management/#rotation-schedule-recommended","title":"Rotation Schedule (Recommended)","text":"Secret Type Rotation Frequency Database passwords Every 90 days API keys (external services) Every 180 days JWT secrets Every 180 days Encryption keys Yearly Service-to-service tokens Every 90 days"},{"location":"security/secrets-management/#automated-rotation-advanced","title":"Automated Rotation (Advanced)","text":"<p>Use Infisical API or webhooks to automate rotation:</p> <pre><code># Example: Rotate PostgreSQL password via API\ncurl -X PATCH https://infisical.yourdomain.com/api/v1/secrets/POSTGRES_PASSWORD \\\n  -H \"Authorization: Bearer $INFISICAL_TOKEN\" \\\n  -d '{\"value\": \"new-password\"}'\n\n# Restart service\ndocker compose restart postgres\n</code></pre>"},{"location":"security/secrets-management/#backup-recovery","title":"Backup &amp; Recovery","text":""},{"location":"security/secrets-management/#backup-infisical-data","title":"Backup Infisical Data","text":"<p>Infisical stores all data in MongoDB:</p> <pre><code># On Infisical host\ncd /opt/infisical\n\n# Backup MongoDB\ndocker compose exec -T mongo mongodump --archive --gzip &gt; infisical-backup-$(date +%Y%m%d).gz\n\n# Copy backup off-host\nrsync infisical-backup-*.gz backup-server:/backups/infisical/\n</code></pre>"},{"location":"security/secrets-management/#restore-infisical","title":"Restore Infisical","text":"<pre><code># Stop Infisical\ndocker compose down\n\n# Restore MongoDB\ndocker compose up -d mongo\nsleep 10\ndocker compose exec -T mongo mongorestore --archive --gzip &lt; infisical-backup-20250125.gz\n\n# Start Infisical\ndocker compose up -d\n</code></pre>"},{"location":"security/secrets-management/#disaster-recovery","title":"Disaster Recovery","text":"<p>If Infisical is completely lost:</p> <ol> <li>Restore from backup (preferred)</li> <li>Manual secret recreation:</li> <li>Refer to documentation</li> <li>Check git history for config templates</li> <li>Regenerate secrets (invalidates old ones)</li> </ol> <p>Prevention: Schedule regular automated backups!</p>"},{"location":"security/secrets-management/#security-best-practices","title":"Security Best Practices","text":""},{"location":"security/secrets-management/#access-control","title":"Access Control","text":"<ul> <li>Limit Machine Identities: Create separate identities per environment/team</li> <li>Rotate Credentials: Rotate Machine Identity credentials regularly</li> <li>Audit Logs: Review Infisical audit logs monthly</li> <li>Least Privilege: Grant minimum required permissions</li> </ul>"},{"location":"security/secrets-management/#network-security","title":"Network Security","text":"<ul> <li>Firewall: Block Infisical port from public internet</li> <li>VPN Access: Access Infisical only via VPN if self-hosted</li> <li>HTTPS Only: Always use HTTPS/TLS for Infisical</li> <li>Internal Network: Keep Infisical on internal network segment</li> </ul>"},{"location":"security/secrets-management/#secret-hygiene","title":"Secret Hygiene","text":"<ul> <li>No Defaults: Never use example/default passwords</li> <li>Complexity: Use strong, random secrets (32+ characters)</li> <li>Unique: Different password for each service</li> <li>No Reuse: Don't reuse secrets across environments</li> <li>No Sharing: Don't share secrets via email/chat</li> </ul>"},{"location":"security/secrets-management/#env-file-security","title":".env File Security","text":"<pre><code># Secure permissions\nchmod 600 .env\n\n# Never commit\necho \".env\" &gt;&gt; .gitignore\n\n# Verify not in git\ngit status --ignored\n\n# Store backup securely (encrypted)\ngpg -c .env -o .env.gpg\n</code></pre>"},{"location":"security/secrets-management/#troubleshooting","title":"Troubleshooting","text":""},{"location":"security/secrets-management/#cannot-connect-to-infisical","title":"Cannot connect to Infisical","text":"<pre><code># Test connectivity\ncurl -I https://infisical.yourdomain.com\n\n# Check Infisical logs\ndocker compose logs -f infisical\n\n# Verify credentials\ncat .env | grep INFISICAL\n\n# Test CLI auth\ninfisical export --env=dev\n</code></pre>"},{"location":"security/secrets-management/#secrets-not-injected","title":"Secrets not injected","text":"<pre><code># Verify .env exists\nls -la .env\n\n# Test Infisical CLI\ninfisical export --env=dev\n\n# Check make config output\nmake config | head -50\n\n# Verify secret exists in Infisical UI\n</code></pre>"},{"location":"security/secrets-management/#permission-denied-errors","title":"Permission denied errors","text":"<pre><code># Check file permissions\nls -la .env\n\n# Should be: -rw------- (600)\nchmod 600 .env\n</code></pre>"},{"location":"security/secrets-management/#next-steps","title":"Next Steps","text":"<ul> <li>Configure services</li> <li>Security Best Practices</li> <li>Backup Setup</li> </ul>"},{"location":"services/","title":"Services Overview","text":"<p>Omakase includes 25+ containerized services organized by category. Each service is modular and can be enabled/disabled independently.</p>"},{"location":"services/#service-categories","title":"Service Categories","text":""},{"location":"services/#core-infrastructure","title":"Core Infrastructure","text":"<p>Essential services that should always run:</p> Service Purpose Port Traefik Reverse proxy &amp; SSL 80, 443 Authelia SSO authentication - CrowdSec IPS &amp; security - Cetusguard Docker socket proxy -"},{"location":"services/#management-monitoring","title":"Management &amp; Monitoring","text":"Service Purpose Default URL Portainer Container management UI <code>portainer.${DOMAINNAME}</code> Homepage Unified dashboard <code>home.${DOMAINNAME}</code> Dozzle Real-time log viewer <code>dozzle.${DOMAINNAME}</code>"},{"location":"services/#databases","title":"Databases","text":"Service Type Used By PostgreSQL Relational DB Authelia, Nextcloud, others Redict (Redis) Key-value store Authelia, caching"},{"location":"services/#backup","title":"Backup","text":"Service Purpose Restic Encrypted backups"},{"location":"services/#enabling-services","title":"Enabling Services","text":"<p>Services are included via <code>compose.prod.yaml</code>:</p> <pre><code>include:\n  - path: compose/traefik/compose.yaml\n  - path: compose/authelia/compose.yaml\n  - path: compose/myservice/compose.yaml  # Add your service here\n</code></pre> <p>To enable a service:</p> <ol> <li>Add the service's <code>compose.yaml</code> to the include list</li> <li>Configure secrets in Infisical</li> <li>Redeploy: <code>make restart</code></li> </ol>"},{"location":"services/#adding-new-services","title":"Adding New Services","text":"<p>Quick checklist: - [ ] Create <code>compose/&lt;service&gt;/compose.yaml</code> - [ ] Configure dedicated <code>vnet-&lt;service&gt;</code> network - [ ] Add security options (<code>no-new-privileges:true</code>) - [ ] Configure secrets in Infisical - [ ] Add Traefik labels if web-accessible - [ ] Document service in <code>docs/services/&lt;service&gt;.md</code> - [ ] Test deployment</p>"},{"location":"services/#service-status","title":"Service Status","text":"<p>To check service status:</p> <pre><code># All services\ndocker compose ps\n\n# Specific service\ndocker compose ps &lt;service-name&gt;\n\n# Detailed status\ndocker compose logs -f &lt;service-name&gt;\n</code></pre>"},{"location":"services/#resource-usage","title":"Resource Usage","text":"<p>View real-time resource consumption:</p> <pre><code># Docker stats\ndocker stats\n\n# Per-service resource limits are defined in compose files\n</code></pre>"},{"location":"services/#service-dependencies","title":"Service Dependencies","text":"<p>Some services depend on others:</p> <pre><code>graph TD\n    Traefik[Traefik] --&gt; Services[All Web Services]\n    Authelia[Authelia] --&gt; PostgreSQL[(PostgreSQL)]\n    Authelia --&gt; Redict[(Redict)]\n    Services --&gt; Authelia\n    Services --&gt; CrowdSec[CrowdSec]\n    Management[Portainer/Homepage] --&gt; Cetusguard[Cetusguard]\n    Cetusguard --&gt; Docker[Docker Socket]</code></pre>"}]}